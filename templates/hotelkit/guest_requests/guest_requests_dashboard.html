{% extends 'dashboard_base.html' %}
{% load static %}

{% block title %}Guest Requests Analytics Dashboard{% endblock %}

{% block extra_css %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    .chart-container {
        position: relative;
        height: 400px;
        width: 100%;
    }
</style>
{% endblock %}

{% block content %}
<!-- Dashboard Header -->
<div class="dashboard-header" id="dashboardHeader">
    <div class="hotel-info d-flex align-items-center">
        <div class="flex-grow-1">
            <h1 class="mb-2">Guest Requests Analytics Dashboard</h1>
            <p class="mb-0 opacity-90">Monitor and analyze guest request performance</p>
        </div>
        <div class="d-flex gap-2">
            <a href="{% url 'guest_requests:upload' %}" class="btn btn-success">
                <i class="fas fa-upload me-2"></i>Upload Data
            </a>
            <a href="{% url 'guest_requests:export_excel' %}?start_date={{ start_date }}&end_date={{ end_date }}" class="btn btn-outline-primary">
                <i class="fas fa-file-excel me-2"></i>Export Excel
            </a>
            <a href="{% url 'guest_requests:export_pdf' %}?start_date={{ start_date }}&end_date={{ end_date }}" class="btn btn-outline-secondary">
                <i class="fas fa-file-pdf me-2"></i>Export PDF
            </a>
            <button id="exportDashboardPdfBtn" type="button" class="btn btn-dark">
                <i class="fas fa-download me-2"></i>Export Dashboard PDF
            </button>
        </div>
    </div>
</div>

<div class="container-fluid">
        <!-- Filters -->
        <div class="card mb-4">
            <div class="card-body">
                <form method="get" class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label">Start Date</label>
                        <input type="date" name="start_date" value="{{ start_date }}" class="form-control">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">End Date</label>
                        <input type="date" name="end_date" value="{{ end_date }}" class="form-control">
                    </div>
                    <div class="col-md-3 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-filter me-2"></i>Apply Filters
                        </button>
                    </div>
                </form>
            </div>
        </div>
        <!-- Info Banner -->
        <div class="alert alert-warning d-flex align-items-center mb-3" role="alert">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <div>
                This dashboard reflects guest requests within the selected date range. Upload new Excel exports to refresh data.
            </div>
        </div>

        <!-- KPI Cards -->
        <div class="row mb-4">
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="metric-card">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0 me-3">
                            <i class="fas fa-list text-primary" style="font-size: 2rem;"></i>
                        </div>
                        <div>
                            <div class="metric-label">Total Requests
                                <i class="fas fa-info-circle ms-2 text-muted" data-bs-toggle="tooltip" title="Count of all guest requests created in the selected date range."></i>
                            </div>
                            <div class="metric-value">{{ total_requests }}</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-3 col-md-6 mb-3">
                <div class="metric-card">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0 me-3">
                            <i class="fas fa-exclamation-triangle text-danger" style="font-size: 2rem;"></i>
                        </div>
                        <div>
                            <div class="metric-label">Open Requests
                                <i class="fas fa-info-circle ms-2 text-muted" data-bs-toggle="tooltip" title="Requests in non-closed states (e.g., Open, In Progress, Accepted)."></i>
                            </div>
                            <div class="metric-value">{{ open_requests }}</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-2 col-md-6 mb-3">
                <div class="metric-card">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0 me-3">
                            <i class="fas fa-clock text-primary" style="font-size: 2rem;"></i>
                        </div>
                        <div>
                            <div class="metric-label">Avg Response
                                <i class="fas fa-info-circle ms-2 text-muted" data-bs-toggle="tooltip" title="Average of (Time Accepted − Creation Date) for requests with both timestamps."></i>
                            </div>
                            <div class="metric-value">{{ avg_response }}</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-2 col-md-6 mb-3">
                <div class="metric-card">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0 me-3">
                            <i class="fas fa-check-circle text-success" style="font-size: 2rem;"></i>
                        </div>
                        <div>
                            <div class="metric-label">Avg Completion
                                <i class="fas fa-info-circle ms-2 text-muted" data-bs-toggle="tooltip" title="Average of (Time Done − Creation Date) for completed requests."></i>
                            </div>
                            <div class="metric-value">{{ avg_completion }}</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-2 col-md-6 mb-3">
                <div class="metric-card">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0 me-3">
                            <i class="fas fa-bolt text-warning" style="font-size: 2rem;"></i>
                        </div>
                        <div>
                            <div class="metric-label">Avg Execution
                                <i class="fas fa-info-circle ms-2 text-muted" data-bs-toggle="tooltip" title="Average of (Time Done − Time Accepted) for requests with both timestamps."></i>
                            </div>
                            <div class="metric-value">{{ avg_execution }}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row 1 -->
        <div class="row mb-4">
            <!-- Trend Chart -->
            <div class="col-lg-6 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Request Trends</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="trendChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Department Chart -->
            <div class="col-lg-6 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Requests by Department</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="deptChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row 2 -->
        <div class="row mb-4">
            <!-- Priority Chart -->
            <div class="col-lg-6 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Requests by Priority</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="priorityChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Types Chart -->
            <div class="col-lg-6 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Request Types Distribution</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="typesChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Table Row -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card" id="latestCard">
                    <div class="card-header"><h5 class="card-title mb-0">Latest 10 Guest Requests</h5></div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table performance-table mb-0">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Location</th>
                                        <th>Type</th>
                                        <th>Priority</th>
                                        <th>State</th>
                                        <th>Response Time</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for r in latest %}
                                    <tr>
                                        <td class="fw-medium">{{ r.request_id }}</td>
                                        <td>{{ r.location|default:'-' }}</td>
                                        <td>{{ r.type|default:'-' }}</td>
                                        <td>{{ r.priority|default:'-' }}</td>
                                        <td>{{ r.state|default:'-' }}</td>
                                        <td>{% if r.response_time %}{{ r.response_time }}{% else %}-{% endif %}</td>
                                    </tr>
                                    {% empty %}
                                    <tr><td colspan="5" class="text-center py-4">No data</td></tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script>
// Chart.js configurations
let createdTrend = JSON.parse('{{ created_trend_json|escapejs }}');
let completedTrend = JSON.parse('{{ completed_trend_json|escapejs }}');

// Ensure chronological order by day
const parseDay = (d) => (d ? new Date(d) : new Date(0));
createdTrend = createdTrend.sort((a,b) => parseDay(a.day) - parseDay(b.day));
completedTrend = completedTrend.sort((a,b) => parseDay(a.day) - parseDay(b.day));
const byRecipients = JSON.parse('{{ by_recipients_json|escapejs }}');
const byPriority = JSON.parse('{{ by_priority_json|escapejs }}');
const byType = JSON.parse('{{ by_type_json|escapejs }}');

// Trend Chart
const trendCtx = document.getElementById('trendChart').getContext('2d', { willReadFrequently: true });
new Chart(trendCtx, {
    type: 'line',
    data: {
        labels: createdTrend.map(item => item.day),
        datasets: [{
            label: 'Created',
            data: createdTrend.map(item => item.count),
            borderColor: 'rgb(59, 130, 246)',
            backgroundColor: 'rgba(59, 130, 246, 0.1)',
            tension: 0.1
        }, {
            label: 'Completed',
            data: completedTrend.map(item => item.count),
            borderColor: 'rgb(16, 185, 129)',
            backgroundColor: 'rgba(16, 185, 129, 0.1)',
            tension: 0.1
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: { y: { beginAtZero: true } }
    }
});

// Department Pie Chart
const deptCtx = document.getElementById('deptChart').getContext('2d', { willReadFrequently: true });
new Chart(deptCtx, {
    type: 'doughnut',
    data: {
        labels: byRecipients.map(item => item.recipients),
        datasets: [{
            data: byRecipients.map(item => item.count),
            backgroundColor: [
                '#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6',
                '#06B6D4', '#84CC16', '#F97316', '#EC4899', '#6B7280'
            ]
        }]
    },
    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
});

// Priority Chart
const priorityCtx = document.getElementById('priorityChart').getContext('2d', { willReadFrequently: true });
new Chart(priorityCtx, {
    type: 'bar',
    data: {
        labels: byPriority.map(item => item.priority || 'Unknown'),
        datasets: [{
            label: 'Request Count',
            data: byPriority.map(item => item.count),
            backgroundColor: 'rgba(59, 130, 246, 0.8)',
            borderColor: 'rgb(59, 130, 246)',
            borderWidth: 1
        }]
    },
    options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
});

// Types Chart
const typesCtx = document.getElementById('typesChart').getContext('2d', { willReadFrequently: true });
new Chart(typesCtx, {
    type: 'doughnut',
    data: {
        labels: byType.map(item => item.type),
        datasets: [{
            data: byType.map(item => item.count),
            backgroundColor: [
                '#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6',
                '#06B6D4', '#84CC16', '#F97316', '#EC4899', '#6B7280'
            ]
        }]
    },
    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
});

// Dashboard PDF export (client-side capture)
document.getElementById('exportDashboardPdfBtn')?.addEventListener('click', async function () {
    const { jsPDF } = window.jspdf || {};
    if (!jsPDF || !window.html2canvas) {
        alert('PDF export libraries not loaded');
        return;
    }
    const pdf = new jsPDF('p', 'pt', 'a4');
    const pageWidth = pdf.internal.pageSize.getWidth();
    const pageHeight = pdf.internal.pageSize.getHeight();

    async function addElementAsImage(selector, addNewPageIfNeeded = true, margin = 20) {
        const el = typeof selector === 'string' ? document.querySelector(selector) : selector;
        if (!el) return;
        const canvas = await html2canvas(el, { scale: 2, useCORS: true, backgroundColor: '#ffffff', logging: false });
        const imgData = canvas.toDataURL('image/png');
        const imgWidth = pageWidth - margin * 2;
        const imgHeight = canvas.height * (imgWidth / canvas.width);
        let y = margin;
        if (imgHeight <= pageHeight - margin * 2) {
            pdf.addImage(imgData, 'PNG', margin, y, imgWidth, imgHeight, undefined, 'FAST');
            if (addNewPageIfNeeded) pdf.addPage();
        } else {
            let remainingHeight = imgHeight;
            let sY = 0;
            const sliceHeight = canvas.height * ((pageHeight - margin * 2) / imgHeight);
            while (remainingHeight > 0) {
                const sliceCanvas = document.createElement('canvas');
                sliceCanvas.width = canvas.width;
                sliceCanvas.height = Math.min(sliceHeight, canvas.height - sY);
                const ctx = sliceCanvas.getContext('2d');
                ctx.drawImage(canvas, 0, sY, canvas.width, sliceCanvas.height, 0, 0, sliceCanvas.width, sliceCanvas.height);
                const sliceImg = sliceCanvas.toDataURL('image/png');
                const sliceRenderedHeight = (sliceCanvas.height / canvas.width) * imgWidth;
                pdf.addImage(sliceImg, 'PNG', margin, margin, imgWidth, sliceRenderedHeight, undefined, 'FAST');
                remainingHeight -= sliceRenderedHeight;
                sY += sliceCanvas.height;
                if (remainingHeight > 0) pdf.addPage();
            }
            if (addNewPageIfNeeded) pdf.addPage();
        }
    }

    try {
        await addElementAsImage('#dashboardHeader');
        if (pdf.getNumberOfPages() > 1) pdf.deletePage(pdf.getNumberOfPages());
        await addElementAsImage('#trendChart');
        if (pdf.getNumberOfPages() > 1) pdf.deletePage(pdf.getNumberOfPages());
        await addElementAsImage('#deptChart');
        if (pdf.getNumberOfPages() > 1) pdf.deletePage(pdf.getNumberOfPages());
        await addElementAsImage('#priorityChart');
        if (pdf.getNumberOfPages() > 1) pdf.deletePage(pdf.getNumberOfPages());
        await addElementAsImage('#typesChart');
        if (pdf.getNumberOfPages() > 1) pdf.deletePage(pdf.getNumberOfPages());
        const latestCard = document.getElementById('latestCard');
        if (latestCard) {
            await addElementAsImage(latestCard);
            if (pdf.getNumberOfPages() > 1) pdf.deletePage(pdf.getNumberOfPages());
        }
    } catch (e) {
        console.error(e);
        alert('Failed to generate PDF.');
        return;
    }

    pdf.save('guest_requests_dashboard.pdf');
});
</script>
{% endblock %}
{% endblock %}


