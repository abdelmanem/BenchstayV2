{% extends 'dashboard_base.html' %}
{% load static %}

{% block title %}Monthly Root Cause Report - Repairs Analytics{% endblock %}

{% block extra_css %}
<script src="https://cdn.tailwindcss.com"></script>
<style>
    .chart-container {
        position: relative;
        height: 400px;
        width: 100%;
    }
    .root-cause-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }
    .root-cause-value {
        font-size: 2.5rem;
        font-weight: 700;
        margin: 0.5rem 0;
    }
    .root-cause-label {
        font-size: 0.875rem;
        opacity: 0.9;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }
    .export-btn {
        background: linear-gradient(135deg, #10b981, #059669);
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    .export-btn:hover {
        background: linear-gradient(135deg, #059669, #047857);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }
    .export-btn-secondary {
        background: linear-gradient(135deg, #3b82f6, #2563eb);
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    .export-btn-secondary:hover {
        background: linear-gradient(135deg, #2563eb, #1d4ed8);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }
    .priority-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
    }
    .priority-high {
        background: rgba(239, 68, 68, 0.1);
        color: #dc2626;
    }
    .priority-medium {
        background: rgba(245, 158, 11, 0.1);
        color: #d97706;
    }
    .priority-low {
        background: rgba(16, 185, 129, 0.1);
        color: #059669;
    }
    .bottleneck-item {
        background: #f8fafc;
        border-left: 4px solid #3b82f6;
        padding: 1rem;
        margin-bottom: 0.5rem;
        border-radius: 0 8px 8px 0;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-0 text-dark">Monthly Root Cause Report</h1>
                    <p class="text-muted mb-0">Root cause analysis and process optimization insights</p>
                </div>
                <div class="d-flex gap-2">
                    <button class="export-btn" onclick="exportToExcel()">
                        <i class="fas fa-file-excel me-2"></i>Export to Excel
                    </button>
                    <button class="export-btn-secondary" onclick="exportToPDF()">
                        <i class="fas fa-file-pdf me-2"></i>Export to PDF
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Date Filter -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <form id="dateFilterForm" class="row g-3">
                        {% csrf_token %}
                        <div class="col-md-4">
                            <label for="startDate" class="form-label">Start Date</label>
                            <input type="date" class="form-control" id="startDate" name="start_date" value="{{ start_date }}">
                        </div>
                        <div class="col-md-4">
                            <label for="endDate" class="form-label">End Date</label>
                            <input type="date" class="form-control" id="endDate" name="end_date" value="{{ end_date }}">
                        </div>
                        <div class="col-md-4 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-filter me-2"></i>Apply Filter
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="root-cause-card">
                <div class="root-cause-label">Total Requests</div>
                <div class="root-cause-value" id="totalRequests">-</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="root-cause-card">
                <div class="root-cause-label">Top Issue Type</div>
                <div class="root-cause-value" id="topIssueType">-</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="root-cause-card">
                <div class="root-cause-label">Most Problematic Room</div>
                <div class="root-cause-value" id="topProblemRoom">-</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="root-cause-card">
                <div class="root-cause-label">Process Bottlenecks</div>
                <div class="root-cause-value" id="bottlenecksCount">-</div>
            </div>
        </div>
    </div>

    <!-- Top 5 Charts Row -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Top 5 Request Types</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="topTypesChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Top 5 Problem Locations</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="topLocationsChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- SLA Breakdown Chart -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">SLA Compliance Breakdown</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="slaBreakdownChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Process Bottlenecks -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Process Bottlenecks Analysis</h5>
                </div>
                <div class="card-body">
                    <div id="bottlenecksContainer">
                        <!-- Bottlenecks will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Data Tables -->
    <div class="row">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Top 5 Request Types</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Type</th>
                                    <th>Count</th>
                                    <th>Percentage</th>
                                    <th>Avg Completion</th>
                                </tr>
                            </thead>
                            <tbody id="topTypesTable">
                                <!-- Data will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Top 5 Locations</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Location</th>
                                    <th>Count</th>
                                    <th>Floor</th>
                                    <th>Avg Completion</th>
                                </tr>
                            </thead>
                            <tbody id="topLocationsTable">
                                <!-- Data will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let topTypesChart, topLocationsChart, slaBreakdownChart;

// Load data on page load
document.addEventListener('DOMContentLoaded', function() {
    loadReportData();
    
    // Setup date filter form
    document.getElementById('dateFilterForm').addEventListener('submit', function(e) {
        e.preventDefault();
        loadReportData();
    });
});

function loadReportData() {
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    
    // If no dates selected, use last month as default
    const today = new Date();
    const lastMonth = new Date(today.getFullYear(), today.getMonth() - 1, 1);
    const finalStartDate = startDate || lastMonth.toISOString().split('T')[0];
    const finalEndDate = endDate || today.toISOString().split('T')[0];
    
    console.log('Loading monthly data for date range:', finalStartDate, 'to', finalEndDate);
    
    // Load summary cards
    loadSummaryCards(finalStartDate, finalEndDate);
    
    // Load charts
    loadTopTypesChart(finalStartDate, finalEndDate);
    loadTopLocationsChart(finalStartDate, finalEndDate);
    loadSLABreakdownChart(finalStartDate, finalEndDate);
    
    // Load tables
    loadTopTypesTable(finalStartDate, finalEndDate);
    loadTopLocationsTable(finalStartDate, finalEndDate);
    
    // Load bottlenecks
    loadBottlenecks(finalStartDate, finalEndDate);
}

function loadSummaryCards(startDate, endDate) {
    // Load types data
    fetch(`/hotelkit/repairs/api/repairs/types/?start_date=${startDate}&end_date=${endDate}`)
        .then(response => response.json())
        .then(data => {
            const totalRequests = data.reduce((sum, item) => sum + item.count, 0);
            const topType = data.length > 0 ? data[0].type : 'N/A';
            
            document.getElementById('totalRequests').textContent = totalRequests;
            document.getElementById('topIssueType').textContent = topType;
        });
    
    // Load locations data
    fetch(`/hotelkit/repairs/api/repairs/heatmap/?start_date=${startDate}&end_date=${endDate}`)
        .then(response => response.json())
        .then(data => {
            const topLocation = data.length > 0 ? data[0].location : 'N/A';
            document.getElementById('topProblemRoom').textContent = topLocation;
        });
    
    // Load bottlenecks data
    fetch(`/hotelkit/repairs/api/repairs/bottlenecks/?start_date=${startDate}&end_date=${endDate}`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('bottlenecksCount').textContent = data.length;
        });
}

function loadTopTypesChart(startDate, endDate) {
    fetch(`/hotelkit/repairs/api/repairs/types/?start_date=${startDate}&end_date=${endDate}`)
        .then(response => response.json())
        .then(data => {
            const top5 = data.slice(0, 5);
            const ctx = document.getElementById('topTypesChart').getContext('2d');
            
            if (topTypesChart) {
                topTypesChart.destroy();
            }
            
            topTypesChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: top5.map(item => item.type),
                    datasets: [{
                        label: 'Count',
                        data: top5.map(item => item.count),
                        backgroundColor: 'rgba(102, 126, 234, 0.8)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        });
}

function loadTopLocationsChart(startDate, endDate) {
    fetch(`/hotelkit/repairs/api/repairs/heatmap/?start_date=${startDate}&end_date=${endDate}`)
        .then(response => response.json())
        .then(data => {
            const top5 = data.slice(0, 5);
            const ctx = document.getElementById('topLocationsChart').getContext('2d');
            
            if (topLocationsChart) {
                topLocationsChart.destroy();
            }
            
            topLocationsChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: top5.map(item => item.location),
                    datasets: [{
                        data: top5.map(item => item.count),
                        backgroundColor: [
                            'rgba(102, 126, 234, 0.8)',
                            'rgba(118, 75, 162, 0.8)',
                            'rgba(16, 185, 129, 0.8)',
                            'rgba(245, 158, 11, 0.8)',
                            'rgba(239, 68, 68, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        });
}

function loadSLABreakdownChart(startDate, endDate) {
    fetch(`/hotelkit/repairs/api/repairs/sla_compliance/?start_date=${startDate}&end_date=${endDate}`)
        .then(response => response.json())
        .then(data => {
            const ctx = document.getElementById('slaBreakdownChart').getContext('2d');
            
            if (slaBreakdownChart) {
                slaBreakdownChart.destroy();
            }
            
            slaBreakdownChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.sla_breakdown.map(item => item.period),
                    datasets: [{
                        label: 'Compliance Rate (%)',
                        data: data.sla_breakdown.map(item => item.compliance_rate),
                        backgroundColor: [
                            'rgba(239, 68, 68, 0.8)',
                            'rgba(245, 158, 11, 0.8)',
                            'rgba(59, 130, 246, 0.8)',
                            'rgba(16, 185, 129, 0.8)',
                            'rgba(102, 126, 234, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
        });
}

function loadTopTypesTable(startDate, endDate) {
    fetch(`/hotelkit/repairs/api/repairs/types/?start_date=${startDate}&end_date=${endDate}`)
        .then(response => response.json())
        .then(data => {
            const top5 = data.slice(0, 5);
            const tbody = document.getElementById('topTypesTable');
            tbody.innerHTML = '';
            
            top5.forEach(item => {
                const row = tbody.insertRow();
                row.insertCell(0).textContent = item.type;
                row.insertCell(1).textContent = item.count;
                row.insertCell(2).textContent = item.percentage + '%';
                row.insertCell(3).textContent = 'N/A'; // Would need additional API call for avg completion
            });
        });
}

function loadTopLocationsTable(startDate, endDate) {
    fetch(`/hotelkit/repairs/api/repairs/heatmap/?start_date=${startDate}&end_date=${endDate}`)
        .then(response => response.json())
        .then(data => {
            const top5 = data.slice(0, 5);
            const tbody = document.getElementById('topLocationsTable');
            tbody.innerHTML = '';
            
            top5.forEach(item => {
                const row = tbody.insertRow();
                row.insertCell(0).textContent = item.location;
                row.insertCell(1).textContent = item.count;
                row.insertCell(2).textContent = item.floor || 'N/A';
                row.insertCell(3).textContent = 'N/A'; // Would need additional API call for avg completion
            });
        });
}

function loadBottlenecks(startDate, endDate) {
    fetch(`/hotelkit/repairs/api/repairs/bottlenecks/?start_date=${startDate}&end_date=${endDate}`)
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('bottlenecksContainer');
            container.innerHTML = '';
            
            if (data.length === 0) {
                container.innerHTML = '<p class="text-muted">No significant bottlenecks identified.</p>';
                return;
            }
            
            data.forEach(bottleneck => {
                const bottleneckDiv = document.createElement('div');
                bottleneckDiv.className = 'bottleneck-item';
                
                const avgResponse = bottleneck.avg_response_time ? formatDuration(bottleneck.avg_response_time) : 'N/A';
                const avgExecution = bottleneck.avg_execution_time ? formatDuration(bottleneck.avg_execution_time) : 'N/A';
                const avgEvaluation = bottleneck.avg_evaluation_time ? formatDuration(bottleneck.avg_evaluation_time) : 'N/A';
                
                bottleneckDiv.innerHTML = `
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="mb-1">${bottleneck.state}</h6>
                            <p class="mb-0 text-muted">${bottleneck.count} requests</p>
                        </div>
                        <div class="text-end">
                            <small class="text-muted d-block">Avg Response: ${avgResponse}</small>
                            <small class="text-muted d-block">Avg Execution: ${avgExecution}</small>
                            <small class="text-muted d-block">Avg Evaluation: ${avgEvaluation}</small>
                        </div>
                    </div>
                `;
                
                container.appendChild(bottleneckDiv);
            });
        });
}

function formatDuration(duration) {
    if (!duration) return 'N/A';
    
    const totalSeconds = Math.floor(duration.total_seconds());
    const hours = Math.floor(totalSeconds / 3600);
    const minutes = Math.floor((totalSeconds % 3600) / 60);
    
    if (hours > 0) {
        return `${hours}h ${minutes}m`;
    } else {
        return `${minutes}m`;
    }
}

function exportToExcel() {
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    
    const url = `/hotelkit/reports/export/excel/?type=monthly&start_date=${startDate}&end_date=${endDate}`;
    window.open(url, '_blank');
}

function exportToPDF() {
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    
    const url = `/hotelkit/reports/export/pdf/?type=monthly&start_date=${startDate}&end_date=${endDate}`;
    window.open(url, '_blank');
}
</script>
{% endblock %}
