{% extends 'dashboard_base.html' %}
{% load humanize reporting_filters %}

{% block title %}Hotel Performance Report - Benchstay{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Hotel Details & Branding -->
    <div class="row mb-4">
        <div class="col-12">
            <h2 class="mb-3">{{ hotel.name }} - Performance Report</h2>
            <p class="text-muted">Report Period: {{ start_date|date:"F j, Y" }} - {{ end_date|date:"F j, Y" }}</p>
        </div>
    </div>

    <!-- Date Filter + Quick Filters -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <form method="POST" id="date-filter-form" class="row g-3 align-items-end">
                        {% csrf_token %}
                        <div class="col-md-4">
                            <label for="start_date" class="form-label fw-semibold">From</label>
                            <input type="date" class="form-control" id="start_date" name="start_date" value="{{ start_date|date:'Y-m-d' }}" required>
                        </div>
                        <div class="col-md-4">
                            <label for="end_date" class="form-label fw-semibold">To</label>
                            <input type="date" class="form-control" id="end_date" name="end_date" value="{{ end_date|date:'Y-m-d' }}" required>
                        </div>
                        <div class="col-md-4">
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="bi bi-funnel"></i> Apply
                            </button>
                        </div>
                    </form>
                    <div class="d-flex flex-wrap gap-2 mt-3" aria-label="Quick date filters">
                        <button type="button" class="btn btn-outline-primary" data-qf="today">Today</button>
                        <button type="button" class="btn btn-outline-primary" data-qf="last7">Last 7 Days</button>
                        <button type="button" class="btn btn-outline-primary" data-qf="last30">Last 30 Days</button>
                        <button type="button" class="btn btn-outline-primary" data-qf="thisMonth">This Month</button>
                        <button type="button" class="btn btn-outline-primary" data-qf="lastMonth">Last Month</button>
                        <button type="button" class="btn btn-outline-primary" data-qf="ytd">YTD</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Snapshot Metrics -->
    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="card h-100">
                <div class="card-body">
                    <h6 class="card-subtitle mb-2 text-muted">Current Occupancy</h6>
                    <h3 class="card-title mb-0">{{ summary.current_occ|floatformat:1 }}%</h3>
                    <p class="card-text mt-2 {% if summary.occ_change > 0 %}text-success{% elif summary.occ_change < 0 %}text-danger{% endif %}">
                        <i class="bi {% if summary.occ_change > 0 %}bi-arrow-up{% elif summary.occ_change < 0 %}bi-arrow-down{% else %}bi-dash{% endif %}"></i>
                        {{ summary.occ_change|floatformat:1 }}% YoY
                    </p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card h-100">
                <div class="card-body">
                    <h6 class="card-subtitle mb-2 text-muted">Average Daily Rate</h6>
                                            <h3 class="card-title mb-0">{{ system_settings.effective_currency_symbol }}{{ summary.avg_rate|floatformat:2|intcomma }}</h3>
                    <p class="card-text mt-2 {% if summary.rate_change > 0 %}text-success{% elif summary.rate_change < 0 %}text-danger{% endif %}">
                        <i class="bi {% if summary.rate_change > 0 %}bi-arrow-up{% elif summary.rate_change < 0 %}bi-arrow-down{% else %}bi-dash{% endif %}"></i>
                        {{ summary.rate_change|floatformat:1 }}% YoY
                    </p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card h-100">
                <div class="card-body">
                    <h6 class="card-subtitle mb-2 text-muted">RevPAR</h6>
                                            <h3 class="card-title mb-0">{{ system_settings.effective_currency_symbol }}{{ summary.avg_revpar|floatformat:2|intcomma }}</h3>
                    <p class="card-text mt-2 {% if summary.revpar_change > 0 %}text-success{% elif summary.revpar_change < 0 %}text-danger{% endif %}">
                        <i class="bi {% if summary.revpar_change > 0 %}bi-arrow-up{% elif summary.revpar_change < 0 %}bi-arrow-down{% else %}bi-dash{% endif %}"></i>
                        {{ summary.revpar_change|floatformat:1 }}% YoY
                    </p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card h-100">
                <div class="card-body">
                    <h6 class="card-subtitle mb-2 text-muted">Total Revenue</h6>
                                            <h3 class="card-title mb-0">{{ system_settings.effective_currency_symbol }}{{ summary.total_revenue|format_currency_short }}</h3>
                    <p class="card-text mt-2 {% if summary.revenue_change > 0 %}text-success{% elif summary.revenue_change < 0 %}text-danger{% endif %}">
                        <i class="bi {% if summary.revenue_change > 0 %}bi-arrow-up{% elif summary.revenue_change < 0 %}bi-arrow-down{% else %}bi-dash{% endif %}"></i>
                        {{ summary.revenue_change|floatformat:1 }}% YoY
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Performance Trend Chart -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Performance Trends</h5>
                    {{ trend_chart|safe }}
                </div>
            </div>
        </div>
    </div>

    <!-- Market Comparison Chart -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Market Comparison</h5>
                    {{ comparison_chart|safe }}
                </div>
            </div>
        </div>
    </div>

    <!-- Performance Indices Chart -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Performance Indices</h5>
                    {{ indices_chart|safe }}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<style>
    .card {
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        border: none;
        transition: transform 0.2s;
    }
    .card:hover {
        transform: translateY(-2px);
    }
</style>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    setupQuickFilters();
});

function setupQuickFilters() {
    const form = document.getElementById('date-filter-form');
    const startInput = document.getElementById('start_date');
    const endInput = document.getElementById('end_date');
    if (!form || !startInput || !endInput) return;

    function fmt(d) {
        const m = d.getMonth() + 1;
        const day = d.getDate();
        return `${d.getFullYear()}-${String(m).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
    }

    function setAndSubmit(start, end) {
        startInput.value = fmt(start);
        endInput.value = fmt(end);
        form.submit();
    }

    function onQuick(range) {
        const now = new Date();
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        switch(range) {
            case 'today':
                setAndSubmit(today, today);
                break;
            case 'last7': {
                const s = new Date(today);
                s.setDate(s.getDate() - 6);
                setAndSubmit(s, today);
                break; }
            case 'last30': {
                const s = new Date(today);
                s.setDate(s.getDate() - 29);
                setAndSubmit(s, today);
                break; }
            case 'thisMonth': {
                const s = new Date(today.getFullYear(), today.getMonth(), 1);
                const e = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                setAndSubmit(s, e);
                break; }
            case 'lastMonth': {
                const s = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                const e = new Date(today.getFullYear(), today.getMonth(), 0);
                setAndSubmit(s, e);
                break; }
            case 'ytd': {
                const s = new Date(today.getFullYear(), 0, 1);
                setAndSubmit(s, today);
                break; }
        }
    }

    document.querySelectorAll('[data-qf]').forEach(btn => {
        btn.addEventListener('click', () => onQuick(btn.getAttribute('data-qf')));
    });
}
</script>
{% endblock %}