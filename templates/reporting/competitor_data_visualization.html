{% extends 'dashboard_base.html' %}
{% load reporting_filters %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/competitor_analytics.css' %}">
<style>
    .chart-container {
        position: relative;
        height: 400px;
        margin-bottom: 30px;
    }
    
    .circular-chart-container {
        position: relative;
        height: 300px;
        margin-bottom: 20px;
    }
    
    .chart-card {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border: none;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
        border-radius: 12px;
        overflow: hidden;
    }
    
    .chart-card:hover {
        transform: translateY(-8px);
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
    }
    
    .metric-selector {
        margin-bottom: 20px;
    }
    
    .chart-title {
        font-size: 1.3rem;
        font-weight: 600;
        margin-bottom: 15px;
        color: #2c3e50;
    }
    
    .period-badge {
        font-size: 0.8rem;
        padding: 6px 12px;
        border-radius: 25px;
        margin-left: 10px;
        background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
    }

    .chart-type-toggle {
        margin-bottom: 15px;
    }

    .chart-type-toggle .btn {
        min-width: 90px;
        border-radius: 25px;
        margin-right: 5px;
        transition: all 0.3s ease;
    }

    .chart-type-toggle .btn.active {
        background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
        border: none;
        transform: scale(1.05);
    }

    .tab-content {
        padding-top: 20px;
    }
    
    .metrics-summary {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .metric-card {
        padding: 20px;
        border-radius: 12px;
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
        text-align: center;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }
    
    .metric-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
    }
    
    .metric-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
    }
    
    .metric-card .metric-value {
        font-size: 2rem;
        font-weight: 700;
        margin: 15px 0;
        background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    
    .metric-card .metric-label {
        font-size: 0.95rem;
        color: #5a6c7d;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .metric-trend {
        display: flex;
        align-items: center;
        justify-content: center;
        margin-top: 10px;
        font-size: 0.85rem;
    }

    .trend-up {
        color: #28a745;
    }

    .trend-down {
        color: #dc3545;
    }

    .trend-neutral {
        color: #6c757d;
    }

    .nav-tabs .nav-link {
        border-radius: 25px 25px 0 0;
        margin-right: 5px;
        font-weight: 500;
        color: #5a6c7d;
        transition: all 0.3s ease;
    }

    .nav-tabs .nav-link.active {
        background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
        border-color: transparent;
        color: white;
    }

    .card-header {
        border-radius: 12px 12px 0 0 !important;
        font-weight: 600;
        padding: 15px 20px;
    }

    .gradient-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .gradient-success {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    }

    .gradient-info {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .gradient-warning {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }

    .gradient-secondary {
        background: linear-gradient(135deg, #4b6cb7 0%, #182848 100%);
    }

    .btn-group .btn {
        border-radius: 25px;
        margin-right: 5px;
        transition: all 0.3s ease;
        font-weight: 500;
    }

    .btn-outline-primary.active {
        background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
        border: none;
        transform: scale(1.05);
    }

    .circular-metrics-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .performance-indicator {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
        pointer-events: none;
    }

    .performance-indicator .value {
        font-size: 1.5rem;
        font-weight: bold;
        color: #2c3e50;
    }

    .performance-indicator .label {
        font-size: 0.8rem;
        color: #7f8c8d;
        text-transform: uppercase;
    }

    .chart-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        flex-wrap: wrap;
        gap: 10px;
    }

    @media (max-width: 768px) {
        .metrics-summary {
            grid-template-columns: 1fr;
        }
        
        .circular-metrics-row {
            grid-template-columns: 1fr;
        }
        
        .chart-controls {
            flex-direction: column;
            align-items: stretch;
        }
        
        .metric-selector .btn-group {
            flex-wrap: wrap;
        }
        
        .metric-selector .btn {
            margin-bottom: 5px;
        }
    }

    .loading-spinner {
        display: none;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 1000;
    }

    .chart-container.loading::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.8);
        z-index: 999;
    }

    .export-btn {
        background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
        border: none;
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 0.85rem;
        transition: all 0.3s ease;
    }

    .export-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        color: white;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="display-6 fw-bold text-dark">Competitor Analytics Dashboard</h1>
        <button class="export-btn" id="export-dashboard">
            <i class="fas fa-download me-2"></i>Export Data
        </button>
    </div>
    
    <!-- Date Filter Form -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card chart-card">
                <div class="card-header gradient-primary text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-calendar-alt me-2"></i>Custom Date Range Filter
                    </h5>
                </div>
                <div class="card-body">
                    <form method="POST" id="date-filter-form" class="row g-3 align-items-end">
                        {% csrf_token %}
                        <div class="col-md-4">
                            <label for="start_date" class="form-label fw-semibold">From Date</label>
                            <input type="date" class="form-control" id="start_date" name="start_date" value="{{ start_date|date:'Y-m-d' }}" required>
                        </div>
                        <div class="col-md-4">
                            <label for="end_date" class="form-label fw-semibold">To Date</label>
                            <input type="date" class="form-control" id="end_date" name="end_date" value="{{ end_date|date:'Y-m-d' }}" required>
                        </div>
                        <div class="col-md-4">
                            <button type="submit" class="btn gradient-primary text-white w-100">
                                <i class="fas fa-filter me-2"></i>Apply Filter
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Chart Controls -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card chart-card">
                <div class="card-header gradient-secondary text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-cog me-2"></i>Visualization Controls
                    </h5>
                </div>
                <div class="card-body">
                    <div class="chart-controls">
                        <div class="metric-selector">
                            <label class="form-label fw-semibold mb-2">Select Metrics to Display</label>
                            <div class="btn-group flex-wrap" role="group">
                                <button type="button" class="btn btn-outline-primary active" data-metric="occupancy_percentage">
                                    <i class="fas fa-bed me-1"></i>Occupancy %
                                </button>
                                <button type="button" class="btn btn-outline-primary" data-metric="average_rate">
                                    <i class="fas fa-dollar-sign me-1"></i>Average Rate
                                </button>
                                <button type="button" class="btn btn-outline-primary" data-metric="revpar">
                                    <i class="fas fa-chart-line me-1"></i>RevPAR
                                </button>
                                <button type="button" class="btn btn-outline-primary" data-metric="mpi">
                                    <i class="fas fa-crosshairs me-1"></i>MPI
                                </button>
                                <button type="button" class="btn btn-outline-primary" data-metric="ari">
                                    <i class="fas fa-tachometer-alt me-1"></i>ARI
                                </button>
                                <button type="button" class="btn btn-outline-primary" data-metric="rgi">
                                    <i class="fas fa-trophy me-1"></i>RGI
                                </button>
                            </div>
                        </div>
                        <div class="chart-type-selector">
                            <label class="form-label fw-semibold mb-2">Chart Type</label>
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-outline-secondary active" data-chart-type="bar">
                                    <i class="fas fa-chart-bar me-1"></i>Bar
                                </button>
                                <button type="button" class="btn btn-outline-secondary" data-chart-type="line">
                                    <i class="fas fa-chart-line me-1"></i>Line
                                </button>
                                <button type="button" class="btn btn-outline-secondary" data-chart-type="doughnut">
                                    <i class="fas fa-chart-pie me-1"></i>Doughnut
                                </button>
                                <button type="button" class="btn btn-outline-secondary" data-chart-type="radar">
                                    <i class="fas fa-radar me-1"></i>Radar
                                </button>
                                <button type="button" class="btn btn-outline-secondary" data-chart-type="polarArea">
                                    <i class="fas fa-circle-notch me-1"></i>Polar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Key Metrics Summary -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card chart-card">
                <div class="card-header gradient-secondary text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-hotel me-2"></i>Key Metrics Summary for {{ hotel.name }}
                    </h5>
                </div>
                <div class="card-body">
                    <div class="metrics-summary" data-hotel-name="{{ hotel.name }}">
                        <div class="metric-card">
                            <div class="metric-label">
                                <i class="fas fa-bed me-1"></i>Occupancy Rate
                            </div>
                            <div class="metric-value" id="summary-occupancy">{{ daily_data|get_item:hotel.name|get_item:'occupancy_percentage'|floatformat:2 }}%</div>
                            <div class="metric-trend" id="trend-occupancy">
                                <!-- This will be populated by JavaScript -->
                            </div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">
                                <i class="fas fa-dollar-sign me-1"></i>Average Rate
                            </div>
                            <div class="metric-value" id="summary-rate">{{ system_settings.currency_symbol }}{{ daily_data|get_item:hotel.name|get_item:'average_rate'|floatformat:2 }}</div>
                            <div class="metric-trend" id="trend-rate">
                                <!-- This will be populated by JavaScript -->
                            </div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">
                                <i class="fas fa-chart-line me-1"></i>RevPAR
                            </div>
                            <div class="metric-value" id="summary-revpar">{{ system_settings.currency_symbol }}{{ daily_data|get_item:hotel.name|get_item:'revpar'|floatformat:2 }}</div>
                            <div class="metric-trend" id="trend-revpar">
                                <!-- This will be populated by JavaScript -->
                            </div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">
                                <i class="fas fa-crosshairs me-1"></i>Market Penetration
                            </div>
                            <div class="metric-value" id="summary-mpi">{{ daily_data|get_item:hotel.name|get_item:'mpi'|floatformat:2 }}</div>
                            <div class="metric-trend" id="trend-mpi">
                                <!-- This will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Circular Performance Indicators -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card chart-card">
                <div class="card-header gradient-info text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-pie me-2"></i>Performance Indicators
                    </h5>
                </div>
                <div class="card-body">
                    <div class="circular-metrics-row">
                        <div class="circular-chart-card">
                            <h6 class="text-center mb-3">Occupancy Performance</h6>
                            <div class="circular-chart-container">
                                <canvas id="occupancy-circle"></canvas>
                                <div class="performance-indicator">
                                    <div class="value" id="occupancy-value"></div>
                                    <div class="label">Target: <span id="occupancy-target">80%</span></div>
                                </div>
                            </div>
                        </div>
                        <div class="circular-chart-card">
                            <h6 class="text-center mb-3">Rate Index</h6>
                            <div class="circular-chart-container">
                                <canvas id="rate-index-circle"></canvas>
                                <div class="performance-indicator">
                                    <div class="value" id="rate-index-value"></div>
                                    <div class="label"><span id="rate-index-label">Above Market</span></div>
                                </div>
                            </div>
                        </div>
                        <div class="circular-chart-card">
                            <h6 class="text-center mb-3">Revenue Index</h6>
                            <div class="circular-chart-container">
                                <canvas id="revenue-index-circle"></canvas>
                                <div class="performance-indicator">
                                    <div class="value" id="revenue-index-value"></div>
                                    <div class="label"><span id="revenue-index-label">Fair Share</span></div>
                                </div>
                            </div>
                        </div>
                        <div class="circular-chart-card">
                            <h6 class="text-center mb-3">Market Share</h6>
                            <div class="circular-chart-container">
                                <canvas id="market-share-circle"></canvas>
                                <div class="performance-indicator">
                                    <div class="value" id="market-share-value"></div>
                                    <div class="label">Of Total Market</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Charts Navigation Tabs -->
    <ul class="nav nav-tabs mb-4" id="chartTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="individual-tab" data-bs-toggle="tab" data-bs-target="#individual" type="button" role="tab" aria-controls="individual" aria-selected="true">
                <i class="fas fa-chart-bar me-2"></i>Individual Periods
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="comparison-tab" data-bs-toggle="tab" data-bs-target="#comparison" type="button" role="tab" aria-controls="comparison" aria-selected="false">
                <i class="fas fa-balance-scale me-2"></i>Period Comparison
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="circular-tab" data-bs-toggle="tab" data-bs-target="#circular" type="button" role="tab" aria-controls="circular" aria-selected="false">
                <i class="fas fa-chart-pie me-2"></i>Circular Analytics
            </button>
        </li>
    </ul>
    
    <!-- Charts Tab Content -->
    <div class="tab-content" id="chartTabsContent">
        <!-- Individual Periods Tab -->
        <div class="tab-pane fade show active" id="individual" role="tabpanel" aria-labelledby="individual-tab">
            <div class="row">
                <!-- Custom Date Range Chart -->
                <div class="col-md-12 mb-4">
                    <div class="card chart-card">
                        <div class="card-header gradient-warning text-white d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-calendar-alt me-2"></i>Custom Date Range Performance
                                <span class="period-badge">{{ start_date|date:'M d, Y' }} - {{ end_date|date:'M d, Y' }}</span>
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <div class="loading-spinner">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </div>
                                <canvas id="daily-chart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- MTD Chart -->
                <div class="col-md-6 mb-4">
                    <div class="card chart-card">
                        <div class="card-header gradient-success text-white">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-calendar-week me-2"></i>MTD Performance
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="mtd-chart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- YTD Chart -->
                <div class="col-md-6 mb-4">
                    <div class="card chart-card">
                        <div class="card-header gradient-info text-white">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-calendar me-2"></i>YTD Performance
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="ytd-chart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Comparison Tab -->
        <div class="tab-pane fade" id="comparison" role="tabpanel" aria-labelledby="comparison-tab">
            <div class="row mb-4">
                <div class="col-md-12">
                    <div class="card chart-card">
                        <div class="card-header gradient-primary text-white">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-balance-scale me-2"></i>Period Comparison Analysis
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="comparison-chart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Indices Comparison -->
            <div class="row">
                <div class="col-md-4 mb-4">
                    <div class="card chart-card">
                        <div class="card-header gradient-secondary text-white">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-crosshairs me-2"></i>MPI Comparison
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="mpi-comparison-chart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4 mb-4">
                    <div class="card chart-card">
                        <div class="card-header gradient-secondary text-white">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-tachometer-alt me-2"></i>ARI Comparison
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="ari-comparison-chart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4 mb-4">
                    <div class="card chart-card">
                        <div class="card-header gradient-secondary text-white">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-trophy me-2"></i>RGI Comparison
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="rgi-comparison-chart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Circular Analytics Tab -->
        <div class="tab-pane fade" id="circular" role="tabpanel" aria-labelledby="circular-tab">
            <div class="row mb-4">
                <!-- Market Position Radar -->
                <div class="col-md-6 mb-4">
                    <div class="card chart-card">
                        <div class="card-header gradient-primary text-white">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-radar me-2"></i>Market Position Radar
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="market-radar-chart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Performance Distribution -->
                <div class="col-md-6 mb-4">
                    <div class="card chart-card">
                        <div class="card-header gradient-warning text-white">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-chart-pie me-2"></i>Performance Distribution
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="performance-pie-chart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Circular Metrics Grid -->
            <div class="row">
                <div class="col-md-3 mb-4">
                    <div class="card chart-card">
                        <div class="card-header gradient-success text-white">
                            <h6 class="card-title mb-0">Occupancy Gauge</h6>
                        </div>
                        <div class="card-body">
                            <div class="circular-chart-container">
                                <canvas id="occupancy-gauge"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-3 mb-4">
                    <div class="card chart-card">
                        <div class="card-header gradient-info text-white">
                            <h6 class="card-title mb-0">Rate Performance</h6>
                        </div>
                        <div class="card-body">
                            <div class="circular-chart-container">
                                <canvas id="rate-gauge"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-3 mb-4">
                    <div class="card chart-card">
                        <div class="card-header gradient-warning text-white">
                            <h6 class="card-title mb-0">RevPAR Index</h6>
                        </div>
                        <div class="card-body">
                            <div class="circular-chart-container">
                                <canvas id="revpar-gauge"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-3 mb-4">
                    <div class="card chart-card">
                        <div class="card-header gradient-secondary text-white">
                            <h6 class="card-title mb-0">Market Share</h6>
                        </div>
                        <div class="card-body">
                            <div class="circular-chart-container">
                                <canvas id="market-share-gauge"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Competitor Comparison Polar Chart -->
            <div class="row">
                <div class="col-md-12 mb-4">
                    <div class="card chart-card">
                        <div class="card-header gradient-primary text-white">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-circle-notch me-2"></i>Competitor Analysis - Polar View
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="competitor-polar-chart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
<script id="ytd-data" type="application/json">{{ ytd_data_json|default:ytd_data|safe }}</script>
<script id="daily-data" type="application/json">{{ daily_data_json|default:daily_data|safe }}</script>
<script id="mtd-data" type="application/json">{{ mtd_data_json|default:mtd_data|safe }}</script>
<script src="{% static 'js/cache_control.js' %}"></script>

<script>
// Enhanced Competitor Data Visualization with Circular Charts
class EnhancedCompetitorCharts {
    constructor() {
        this.charts = {};
        this.currentMetric = 'occupancy_percentage';
        this.currentChartType = 'bar';
        this.data = {
            ytd: JSON.parse(document.getElementById('ytd-data').textContent),
            daily: JSON.parse(document.getElementById('daily-data').textContent),
            mtd: JSON.parse(document.getElementById('mtd-data').textContent)
        };
        this.colors = {
            primary: ['#667eea', '#764ba2'],
            success: ['#11998e', '#38ef7d'],
            info: ['#667eea', '#764ba2'],
            warning: ['#f093fb', '#f5576c'],
            secondary: ['#4b6cb7', '#182848']
        };
        this.init();
    }

    init() {
        this.setupEventListeners();
        this.createAllCharts();
        this.createCircularIndicators();
    }

    setupEventListeners() {
        // Metric selector
        document.querySelectorAll('[data-metric]').forEach(btn => {
            btn.addEventListener('click', (e) => {
                document.querySelectorAll('[data-metric]').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                this.currentMetric = e.target.dataset.metric;
                this.updateCharts();
            });
        });

        // Chart type selector
        document.querySelectorAll('[data-chart-type]').forEach(btn => {
            btn.addEventListener('click', (e) => {
                document.querySelectorAll('[data-chart-type]').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                this.currentChartType = e.target.dataset.chartType;
                this.updateCharts();
            });
        });

        // Export functionality
        document.getElementById('export-dashboard').addEventListener('click', () => {
            this.exportData();
        });

        // Tab switching
        document.querySelectorAll('[data-bs-toggle="tab"]').forEach(tab => {
            tab.addEventListener('shown.bs.tab', (e) => {
                setTimeout(() => this.resizeCharts(), 100);
            });
        });
    }

    createAllCharts() {
        this.createDailyChart();
        this.createMTDChart();
        this.createYTDChart();
        this.createComparisonCharts();
        this.createCircularCharts();
    }

    createDailyChart() {
        const ctx = document.getElementById('daily-chart').getContext('2d');
        const gradient = ctx.createLinearGradient(0, 0, 0, 400);
        gradient.addColorStop(0, this.colors.primary[0]);
        gradient.addColorStop(1, this.colors.primary[1]);

        this.charts.daily = new Chart(ctx, {
            type: this.currentChartType,
            data: this.getChartData(this.data.daily),
            options: this.getChartOptions('Daily Performance', gradient)
        });
    }

    createMTDChart() {
        const ctx = document.getElementById('mtd-chart').getContext('2d');
        const gradient = ctx.createLinearGradient(0, 0, 0, 400);
        gradient.addColorStop(0, this.colors.success[0]);
        gradient.addColorStop(1, this.colors.success[1]);

        this.charts.mtd = new Chart(ctx, {
            type: this.currentChartType,
            data: this.getChartData(this.data.mtd),
            options: this.getChartOptions('MTD Performance', gradient)
        });
    }

    createYTDChart() {
        const ctx = document.getElementById('ytd-chart').getContext('2d');
        const gradient = ctx.createLinearGradient(0, 0, 0, 400);
        gradient.addColorStop(0, this.colors.info[0]);
        gradient.addColorStop(1, this.colors.info[1]);

        this.charts.ytd = new Chart(ctx, {
            type: this.currentChartType,
            data: this.getChartData(this.data.ytd),
            options: this.getChartOptions('YTD Performance', gradient)
        });
    }

    createComparisonCharts() {
        this.createMPIComparison();
        this.createARIComparison();
        this.createRGIComparison();
        this.createMainComparison();
    }

    createCircularCharts() {
        this.createCircularIndicators();
        this.createMarketRadar();
        this.createPerformancePie();
        this.createGaugeCharts();
        this.createCompetitorPolar();
    }

    createCircularIndicators() {
        // Get hotel name
        const userHotelName = document.querySelector('.metrics-summary').getAttribute('data-hotel-name');
        
        // Get data from backend
        const dailyData = this.data.daily;
        
        // Occupancy Circle - Use real data
        const occupancyValue = dailyData[userHotelName].occupancy_percentage;
        this.createCircularProgress('occupancy-circle', occupancyValue, 100, '#11998e');
        document.getElementById('occupancy-value').textContent = occupancyValue.toFixed(1) + '%';
        
        // Set occupancy target - typically 5-10% higher than current value or industry average
        const occupancyTarget = Math.min(100, Math.round(occupancyValue * 1.1)); // 10% higher than current, max 100%
        document.getElementById('occupancy-target').textContent = occupancyTarget + '%';
        
        // Rate Index Circle - Use real data
        const rateIndexValue = dailyData[userHotelName].ari;
        this.createCircularProgress('rate-index-circle', rateIndexValue, 150, '#667eea');
        document.getElementById('rate-index-value').textContent = rateIndexValue.toFixed(1);
        
        // Set rate index label based on value
        const rateIndexLabel = document.getElementById('rate-index-label');
        if (rateIndexValue > 105) {
            rateIndexLabel.textContent = 'Above Market';
        } else if (rateIndexValue >= 95 && rateIndexValue <= 105) {
            rateIndexLabel.textContent = 'At Market';
        } else {
            rateIndexLabel.textContent = 'Below Market';
        }
        
        // Revenue Index Circle - Use real data
        const revenueIndexValue = dailyData[userHotelName].rgi;
        this.createCircularProgress('revenue-index-circle', revenueIndexValue, 150, '#f093fb');
        document.getElementById('revenue-index-value').textContent = revenueIndexValue.toFixed(1);
        
        // Set revenue index label based on value
        const revenueIndexLabel = document.getElementById('revenue-index-label');
        if (revenueIndexValue > 105) {
            revenueIndexLabel.textContent = 'Above Fair Share';
        } else if (revenueIndexValue >= 95 && revenueIndexValue <= 105) {
            revenueIndexLabel.textContent = 'Fair Share';
        } else {
            revenueIndexLabel.textContent = 'Below Fair Share';
        }
        
        // Market Share Circle - Calculate market share from data
        // For simplicity, we'll use MPI as an approximation of market share
        const marketShareValue = dailyData[userHotelName].mpi / 10; // Convert MPI to approximate market share percentage
        this.createCircularProgress('market-share-circle', marketShareValue, 100, '#4b6cb7');
        document.getElementById('market-share-value').textContent = marketShareValue.toFixed(1) + '%';
    }

    createCircularProgress(canvasId, value, max, color) {
        const ctx = document.getElementById(canvasId)?.getContext('2d');
        if (!ctx) return;

        const percentage = (value / max) * 100;
        
        this.charts[canvasId] = new Chart(ctx, {
            type: 'doughnut',
            data: {
                datasets: [{
                    data: [value, max - value],
                    backgroundColor: [color, '#e9ecef'],
                    borderWidth: 0,
                    cutout: '75%'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: { enabled: false }
                },
                animation: {
                    animateRotate: true,
                    duration: 2000
                }
            }
        });
    }

    createMarketRadar() {
        const ctx = document.getElementById('market-radar-chart')?.getContext('2d');
        if (!ctx) return;

        // Get hotel name and data
        const userHotelName = document.querySelector('.metrics-summary').getAttribute('data-hotel-name');
        const dailyData = this.data.daily;
        
        // Get hotel data
        const hotelData = dailyData[userHotelName];
        
        // Get market average data
        const marketData = dailyData['Market Average'] || {
            occupancy_percentage: 70,
            average_rate: 100,
            revpar: 95,
            mpi: 100,
            ari: 100,
            rgi: 100
        };

        this.charts.marketRadar = new Chart(ctx, {
            type: 'radar',
            data: {
                labels: ['Occupancy', 'Rate', 'RevPAR', 'MPI', 'ARI', 'RGI'],
                datasets: [{
                    label: 'Your Hotel',
                    data: [
                        hotelData.occupancy_percentage,
                        hotelData.average_rate,
                        hotelData.revpar,
                        hotelData.mpi,
                        hotelData.ari,
                        hotelData.rgi
                    ],
                    backgroundColor: 'rgba(102, 126, 234, 0.2)',
                    borderColor: '#667eea',
                    borderWidth: 3,
                    pointBackgroundColor: '#667eea',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2
                }, {
                    label: 'Market Average',
                    data: [
                        marketData.occupancy_percentage,
                        marketData.average_rate,
                        marketData.revpar,
                        marketData.mpi,
                        marketData.ari,
                        marketData.rgi
                    ],
                    backgroundColor: 'rgba(118, 75, 162, 0.1)',
                    borderColor: '#764ba2',
                    borderWidth: 2,
                    pointBackgroundColor: '#764ba2',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { usePointStyle: true }
                    }
                },
                scales: {
                    r: {
                        beginAtZero: true,
                        max: 120,
                        ticks: { stepSize: 20 }
                    }
                }
            }
        });
    }

    createPerformancePie() {
        const ctx = document.getElementById('performance-pie-chart')?.getContext('2d');
        if (!ctx) return;

        // Get data from backend
        const dailyData = this.data.daily;
        
        // Get hotel names and data (excluding Market Average)
        const hotelNames = Object.keys(dailyData).filter(name => name !== 'Market Average');
        
        // Count hotels above, at, and below market
        let aboveMarket = 0;
        let atMarket = 0;
        let belowMarket = 0;
        
        // Use MPI (Market Penetration Index) to determine market position
        hotelNames.forEach(name => {
            const mpi = dailyData[name].mpi;
            if (mpi > 105) { // Above market
                aboveMarket++;
            } else if (mpi >= 95 && mpi <= 105) { // At market
                atMarket++;
            } else { // Below market
                belowMarket++;
            }
        });

        this.charts.performancePie = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Above Market', 'At Market', 'Below Market'],
                datasets: [{
                    data: [aboveMarket, atMarket, belowMarket],
                    backgroundColor: ['#11998e', '#667eea', '#f093fb'],
                    borderWidth: 3,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { usePointStyle: true, padding: 20 }
                    }
                },
                cutout: '60%'
            }
        });
    }

    createGaugeCharts() {
        // Get hotel name
        const userHotelName = document.querySelector('.metrics-summary').getAttribute('data-hotel-name');
        
        // Get data from backend
        const dailyData = this.data.daily;
        
        // Occupancy Gauge - Use real data
        const occupancyValue = dailyData[userHotelName].occupancy_percentage;
        this.createGaugeChart('occupancy-gauge', occupancyValue, 'Occupancy %', '#11998e');
        
        // Rate Gauge - Use real data
        const rateIndexValue = dailyData[userHotelName].ari;
        this.createGaugeChart('rate-gauge', rateIndexValue, 'Rate Index', '#667eea');
        
        // RevPAR Gauge - Use real data
        const revenueIndexValue = dailyData[userHotelName].rgi;
        this.createGaugeChart('revpar-gauge', revenueIndexValue, 'RevPAR Index', '#f093fb');
        
        // Market Share Gauge - Calculate market share from data
        // For simplicity, we'll use MPI as an approximation of market share
        const marketShareValue = dailyData[userHotelName].mpi / 10; // Convert MPI to approximate market share percentage
        this.createGaugeChart('market-share-gauge', marketShareValue, 'Market Share %', '#4b6cb7');
    }

    createGaugeChart(canvasId, value, label, color) {
        const ctx = document.getElementById(canvasId)?.getContext('2d');
        if (!ctx) return;

        this.charts[canvasId] = new Chart(ctx, {
            type: 'doughnut',
            data: {
                datasets: [{
                    data: [value, 100 - value],
                    backgroundColor: [color, '#e9ecef'],
                    borderWidth: 0,
                    cutout: '80%',
                    circumference: 180,
                    rotation: 270
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: { enabled: false }
                }
            }
        });
    }

    createCompetitorPolar() {
        const ctx = document.getElementById('competitor-polar-chart')?.getContext('2d');
        if (!ctx) return;

        // Get data from backend
        const dailyData = this.data.daily;
        
        // Get hotel names and data
        const hotelNames = Object.keys(dailyData);
        
        // Filter out 'Market Average' if it exists
        const filteredHotelNames = hotelNames.filter(name => name !== 'Market Average');
        
        // Get performance data (using MPI as overall performance indicator)
        const performanceData = filteredHotelNames.map(name => dailyData[name].mpi);
        
        // Generate colors
        const colors = [
            'rgba(102, 126, 234, 0.8)',
            'rgba(17, 153, 142, 0.8)',
            'rgba(240, 147, 251, 0.8)',
            'rgba(75, 108, 183, 0.8)',
            'rgba(118, 75, 162, 0.8)'
        ];

        this.charts.competitorPolar = new Chart(ctx, {
            type: 'polarArea',
            data: {
                labels: filteredHotelNames,
                datasets: [{
                    data: performanceData,
                    backgroundColor: colors.slice(0, filteredHotelNames.length),
                    borderColor: '#fff',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { usePointStyle: true, padding: 15 }
                    }
                },
                scales: {
                    r: {
                        beginAtZero: true,
                        max: 100
                    }
                }
            }
        });
    }

    createMPIComparison() {
        const ctx = document.getElementById('mpi-comparison-chart')?.getContext('2d');
        if (!ctx) return;

        this.charts.mpiComparison = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['MTD', 'YTD', 'Last Year'],
                datasets: [{
                    label: 'MPI',
                    data: [102, 105, 98],
                    backgroundColor: this.colors.secondary[0],
                    borderRadius: 8
                }]
            },
            options: this.getComparisonOptions('MPI Comparison')
        });
    }

    createARIComparison() {
        const ctx = document.getElementById('ari-comparison-chart')?.getContext('2d');
        if (!ctx) return;

        this.charts.ariComparison = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['MTD', 'YTD', 'Last Year'],
                datasets: [{
                    label: 'ARI',
                    data: [105, 108, 102],
                    backgroundColor: this.colors.info[0],
                    borderRadius: 8
                }]
            },
            options: this.getComparisonOptions('ARI Comparison')
        });
    }

    createRGIComparison() {
        const ctx = document.getElementById('rgi-comparison-chart')?.getContext('2d');
        if (!ctx) return;

        this.charts.rgiComparison = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['MTD', 'YTD', 'Last Year'],
                datasets: [{
                    label: 'RGI',
                    data: [98, 101, 95],
                    backgroundColor: this.colors.warning[0],
                    borderRadius: 8
                }]
            },
            options: this.getComparisonOptions('RGI Comparison')
        });
    }

    createMainComparison() {
        const ctx = document.getElementById('comparison-chart')?.getContext('2d');
        if (!ctx) return;

        this.charts.comparison = new Chart(ctx, {
            type: 'line',
            data: {
                labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                datasets: [{
                    label: 'This Year',
                    data: [65, 68, 72, 75, 78, 82],
                    borderColor: this.colors.primary[0],
                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                    fill: true,
                    tension: 0.4
                }, {
                    label: 'Last Year',
                    data: [62, 65, 69, 71, 74, 76],
                    borderColor: this.colors.secondary[0],
                    backgroundColor: 'rgba(75, 108, 183, 0.1)',
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                        labels: { usePointStyle: true }
                    }
                },
                scales: {
                    y: { beginAtZero: false }
                }
            }
        });
    }

    getChartData(data) {
        if (!data) return { labels: [], datasets: [] };
        
        const labels = Object.keys(data);
        const values = labels.map(label => data[label]?.[this.currentMetric] || 0);
        
        return {
            labels,
            datasets: [{
                label: this.getMetricLabel(),
                data: values,
                backgroundColor: this.currentChartType === 'line' ? 'rgba(102, 126, 234, 0.1)' : this.colors.primary[0],
                borderColor: this.colors.primary[0],
                borderWidth: 2,
                fill: this.currentChartType === 'line',
                tension: 0.4,
                borderRadius: this.currentChartType === 'bar' ? 8 : 0
            }]
        };
    }

    getChartOptions(title, gradient) {
        const baseOptions = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                    labels: { usePointStyle: true }
                },
                title: {
                    display: false,
                    text: title
                }
            },
            scales: {
                y: {
                    beginAtZero: this.currentMetric.includes('percentage'),
                    grid: { color: 'rgba(0,0,0,0.05)' },
                    ticks: { font: { size: 12 } }
                },
                x: {
                    grid: { display: false },
                    ticks: { font: { size: 12 } }
                }
            }
        };

        if (this.currentChartType === 'doughnut' || this.currentChartType === 'pie') {
            baseOptions.scales = {};
            baseOptions.plugins.legend.position = 'bottom';
        }

        return baseOptions;
    }

    getComparisonOptions(title) {
        return {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                title: { display: false }
            },
            scales: {
                y: { beginAtZero: false }
            }
        };
    }

    getMetricLabel() {
        const labels = {
            'occupancy_percentage': 'Occupancy %',
            'average_rate': 'Average Rate',
            'revpar': 'RevPAR',
            'mpi': 'Market Penetration Index',
            'ari': 'Average Rate Index',
            'rgi': 'Revenue Generation Index'
        };
        return labels[this.currentMetric] || this.currentMetric;
    }

    updateCharts() {
        // Show loading state
        document.querySelectorAll('.chart-container').forEach(container => {
            container.classList.add('loading');
        });

        setTimeout(() => {
            Object.keys(this.charts).forEach(chartKey => {
                if (chartKey.includes('daily') || chartKey.includes('mtd') || chartKey.includes('ytd')) {
                    this.charts[chartKey].destroy();
                }
            });

            this.createDailyChart();
            this.createMTDChart();
            this.createYTDChart();

            // Remove loading state
            document.querySelectorAll('.chart-container').forEach(container => {
                container.classList.remove('loading');
            });
        }, 500);
    }

    resizeCharts() {
        Object.values(this.charts).forEach(chart => {
            if (chart && typeof chart.resize === 'function') {
                chart.resize();
            }
        });
    }

    exportData() {
        // Create export data
        const exportData = {
            date: new Date().toISOString(),
            metric: this.currentMetric,
            data: this.data
        };

        // Create and download file
        const dataStr = JSON.stringify(exportData, null, 2);
        const dataBlob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(dataBlob);
        
        const link = document.createElement('a');
        link.href = url;
        link.download = `competitor-analytics-${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
    }
}

// Initialize when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    new EnhancedCompetitorCharts();
});

// Handle window resize
window.addEventListener('resize', function() {
    if (window.competitorCharts) {
        window.competitorCharts.resizeCharts();
    }
});
</script>
{% endblock %}