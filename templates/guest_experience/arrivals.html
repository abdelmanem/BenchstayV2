{% extends 'dashboard_base.html' %}

{% block title %}Guest Experience - Arrivals{% endblock %}

{% block extra_css %}
<style>
    /* Highlight row in blue on hover or when active (clicked) */
    .performance-table tbody tr:hover {
        background-color: #e0f2ff !important; /* light blue */
        cursor: pointer;
    }
    .performance-table tbody tr.active-row {
        background-color: #bfdbfe !important; /* slightly darker blue when selected */
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-header mb-4">
    <div class="hotel-info d-flex align-items-center justify-content-between">
        <div>
            <h1 class="mb-1">Arrivals</h1>
            <p class="mb-0 text-white-50">Track expected guests arriving today and upcoming days.</p>
        </div>
        <form method="post" action="{% url 'guest_experience:upload_arrivals' %}" enctype="multipart/form-data" class="d-flex align-items-center gap-2">
            {% csrf_token %}
            <input type="file" name="file" accept=".xlsx,.xls" class="form-control form-control-sm" required>
            <button type="submit" class="btn btn-light btn-sm">
                <i class="fas fa-upload me-1"></i>Import Excel
            </button>
        </form>
    </div>
</div>

<div class="card">
    <div class="card-header d-flex flex-wrap justify-content-between align-items-center gap-2">
        <div>
            <h5 class="card-title mb-0">Arrivals Overview</h5>
            <small class="text-muted">Showing arrivals for selected date</small>
        </div>
        <div class="d-flex flex-wrap align-items-center gap-3">
            <div class="d-flex flex-column">
                <label class="small text-muted mb-1" for="arrival-date-filter">Arrival Date</label>
                <input type="date" id="arrival-date-filter" class="form-control form-control-sm" value="{{ today }}">
            </div>
            <div class="d-flex flex-column">
                <label class="small text-muted mb-1" for="arrival-search-input">Search</label>
                <input type="text" id="arrival-search-input" class="form-control form-control-sm" placeholder="Search room, guest, confirmation, agent, country">
            </div>
            <div class="d-flex flex-column">
                <label class="small text-muted mb-1" for="arrival-page-size">Rows per page</label>
                <select id="arrival-page-size" class="form-select form-select-sm">
                    <option value="all" selected>All</option>
                    <option value="25">25</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                </select>
            </div>
            <div class="d-flex flex-column">
                <label class="small text-muted mb-1">&nbsp;</label>
                <div id="arrival-count" class="small text-muted">0 rows</div>
            </div>
            <div class="d-flex flex-column">
                <label class="small text-muted mb-1">&nbsp;</label>
                <div class="d-flex gap-2">
                    <button id="arrival-delete-selected" class="btn btn-sm btn-outline-danger" disabled>
                        <i class="fas fa-trash-alt me-1"></i>Delete Selected
                    </button>
                    <button id="arrival-mark-inhouse-selected" class="btn btn-sm btn-outline-primary" disabled>
                        <i class="fas fa-bed me-1"></i>Mark In-House
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table performance-table mb-0">
                <thead>
                    <tr>
                        <th><input type="checkbox" id="arrival-select-all"></th>
                        <th role="button" data-sort-key="room">Room</th>
                        <th role="button" data-sort-key="guest_name">Guest Name</th>
                        <th role="button" data-sort-key="confirmation_number">Confirmation #</th>
                        <th role="button" data-sort-key="phone">Phone</th>
                        <th role="button" data-sort-key="country">Country</th>
                        <th role="button" data-sort-key="travel_agent_name">Travel Agent</th>
                        <th role="button" data-sort-key="arrival_date">Arrival</th>
                        <th role="button" data-sort-key="departure_date">Departure</th>
                        <th role="button" data-sort-key="nights">Nights</th>
                        <th role="button" data-sort-key="status">Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="arrivals-body">
                    <tr>
                        <td colspan="12" class="text-center py-4 text-muted">
                            Loading arrivals...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Edit Reservation Modal -->
<div class="modal fade" id="editReservationModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-edit me-2"></i>Edit Reservation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editReservationForm">
                {% csrf_token %}
                <div class="modal-body">
                    <input type="hidden" id="edit-confirmation-number" name="confirmation_number">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Confirmation Number</label>
                            <input type="text" class="form-control" id="edit-confirmation-display" readonly>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Room Number <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="edit-room" name="room" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">First Name</label>
                            <input type="text" class="form-control" id="edit-first-name" name="first_name">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Last Name</label>
                            <input type="text" class="form-control" id="edit-last-name" name="last_name">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Guest Name</label>
                            <input type="text" class="form-control" id="edit-guest-name" name="guest_name">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Phone</label>
                            <input type="text" class="form-control" id="edit-phone" name="phone">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" id="edit-email" name="email">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Nationality</label>
                            <select class="form-select" id="edit-nationality" name="nationality">
                                <option value="">Select Nationality...</option>
                                <option value="Afghan">Afghan</option>
                                <option value="Albanian">Albanian</option>
                                <option value="Algerian">Algerian</option>
                                <option value="Argentine">Argentine</option>
                                <option value="Australian">Australian</option>
                                <option value="Austrian">Austrian</option>
                                <option value="Bahraini">Bahraini</option>
                                <option value="Bangladeshi">Bangladeshi</option>
                                <option value="Belgian">Belgian</option>
                                <option value="Brazilian">Brazilian</option>
                                <option value="Bulgarian">Bulgarian</option>
                                <option value="Canadian">Canadian</option>
                                <option value="Chilean">Chilean</option>
                                <option value="Chinese">Chinese</option>
                                <option value="Colombian">Colombian</option>
                                <option value="Croatian">Croatian</option>
                                <option value="Czech">Czech</option>
                                <option value="Danish">Danish</option>
                                <option value="Egyptian">Egyptian</option>
                                <option value="Finnish">Finnish</option>
                                <option value="French">French</option>
                                <option value="German">German</option>
                                <option value="Greek">Greek</option>
                                <option value="Hong Konger">Hong Konger</option>
                                <option value="Hungarian">Hungarian</option>
                                <option value="Indian">Indian</option>
                                <option value="Indonesian">Indonesian</option>
                                <option value="Iranian">Iranian</option>
                                <option value="Iraqi">Iraqi</option>
                                <option value="Irish">Irish</option>
                                <option value="Israeli">Israeli</option>
                                <option value="Italian">Italian</option>
                                <option value="Japanese">Japanese</option>
                                <option value="Jordanian">Jordanian</option>
                                <option value="Kenyan">Kenyan</option>
                                <option value="Kuwaiti">Kuwaiti</option>
                                <option value="Lebanese">Lebanese</option>
                                <option value="Malaysian">Malaysian</option>
                                <option value="Mexican">Mexican</option>
                                <option value="Moroccan">Moroccan</option>
                                <option value="Dutch">Dutch</option>
                                <option value="New Zealander">New Zealander</option>
                                <option value="Nigerian">Nigerian</option>
                                <option value="Norwegian">Norwegian</option>
                                <option value="Omani">Omani</option>
                                <option value="Pakistani">Pakistani</option>
                                <option value="Filipino">Filipino</option>
                                <option value="Polish">Polish</option>
                                <option value="Portuguese">Portuguese</option>
                                <option value="Qatari">Qatari</option>
                                <option value="Romanian">Romanian</option>
                                <option value="Russian">Russian</option>
                                <option value="Saudi Arabian">Saudi Arabian</option>
                                <option value="Singaporean">Singaporean</option>
                                <option value="South African">South African</option>
                                <option value="South Korean">South Korean</option>
                                <option value="Spanish">Spanish</option>
                                <option value="Swedish">Swedish</option>
                                <option value="Swiss">Swiss</option>
                                <option value="Taiwanese">Taiwanese</option>
                                <option value="Thai">Thai</option>
                                <option value="Turkish">Turkish</option>
                                <option value="Ukrainian">Ukrainian</option>
                                <option value="Emirati">Emirati</option>
                                <option value="British">British</option>
                                <option value="American">American</option>
                                <option value="Venezuelan">Venezuelan</option>
                                <option value="Vietnamese">Vietnamese</option>
                                <option value="Yemeni">Yemeni</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Country</label>
                            <select class="form-select" id="edit-country" name="country">
                                <option value="">Select Country...</option>
                                <option value="Afghanistan">Afghanistan</option>
                                <option value="Albania">Albania</option>
                                <option value="Algeria">Algeria</option>
                                <option value="Argentina">Argentina</option>
                                <option value="Australia">Australia</option>
                                <option value="Austria">Austria</option>
                                <option value="Bahrain">Bahrain</option>
                                <option value="Bangladesh">Bangladesh</option>
                                <option value="Belgium">Belgium</option>
                                <option value="Brazil">Brazil</option>
                                <option value="Bulgaria">Bulgaria</option>
                                <option value="Canada">Canada</option>
                                <option value="Chile">Chile</option>
                                <option value="China">China</option>
                                <option value="Colombia">Colombia</option>
                                <option value="Croatia">Croatia</option>
                                <option value="Czech Republic">Czech Republic</option>
                                <option value="Denmark">Denmark</option>
                                <option value="Egypt">Egypt</option>
                                <option value="Finland">Finland</option>
                                <option value="France">France</option>
                                <option value="Germany">Germany</option>
                                <option value="Greece">Greece</option>
                                <option value="Hong Kong">Hong Kong</option>
                                <option value="Hungary">Hungary</option>
                                <option value="India">India</option>
                                <option value="Indonesia">Indonesia</option>
                                <option value="Iran">Iran</option>
                                <option value="Iraq">Iraq</option>
                                <option value="Ireland">Ireland</option>
                                <option value="Israel">Israel</option>
                                <option value="Italy">Italy</option>
                                <option value="Japan">Japan</option>
                                <option value="Jordan">Jordan</option>
                                <option value="Kenya">Kenya</option>
                                <option value="Kuwait">Kuwait</option>
                                <option value="Lebanon">Lebanon</option>
                                <option value="Malaysia">Malaysia</option>
                                <option value="Mexico">Mexico</option>
                                <option value="Morocco">Morocco</option>
                                <option value="Netherlands">Netherlands</option>
                                <option value="New Zealand">New Zealand</option>
                                <option value="Nigeria">Nigeria</option>
                                <option value="Norway">Norway</option>
                                <option value="Oman">Oman</option>
                                <option value="Pakistan">Pakistan</option>
                                <option value="Philippines">Philippines</option>
                                <option value="Poland">Poland</option>
                                <option value="Portugal">Portugal</option>
                                <option value="Qatar">Qatar</option>
                                <option value="Romania">Romania</option>
                                <option value="Russia">Russia</option>
                                <option value="Saudi Arabia">Saudi Arabia</option>
                                <option value="Singapore">Singapore</option>
                                <option value="South Africa">South Africa</option>
                                <option value="South Korea">South Korea</option>
                                <option value="Spain">Spain</option>
                                <option value="Sweden">Sweden</option>
                                <option value="Switzerland">Switzerland</option>
                                <option value="Taiwan">Taiwan</option>
                                <option value="Thailand">Thailand</option>
                                <option value="Turkey">Turkey</option>
                                <option value="Ukraine">Ukraine</option>
                                <option value="United Arab Emirates">United Arab Emirates</option>
                                <option value="United Kingdom">United Kingdom</option>
                                <option value="United States">United States</option>
                                <option value="Venezuela">Venezuela</option>
                                <option value="Vietnam">Vietnam</option>
                                <option value="Yemen">Yemen</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Travel Agent</label>
                            <input type="text" class="form-control" id="edit-travel-agent" name="travel_agent_name">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Arrival Date</label>
                            <input type="date" class="form-control" id="edit-arrival-date" name="arrival_date">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Departure Date</label>
                            <input type="date" class="form-control" id="edit-departure-date" name="departure_date">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Status</label>
                            <select class="form-select" id="edit-status" name="status">
                                <option value="Expected">Expected</option>
                                <option value="In-House">In-House</option>
                                <option value="Departed">Departed</option>
                                <option value="Cancelled">Cancelled</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">ETA</label>
                            <input type="text" class="form-control" id="edit-eta" name="eta" placeholder="e.g., 14:00">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-1"></i>Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const tbody = document.getElementById('arrivals-body');
    const dateInput = document.getElementById('arrival-date-filter');
    const searchInput = document.getElementById('arrival-search-input');
    const pageSizeSelect = document.getElementById('arrival-page-size');
    const countLabel = document.getElementById('arrival-count');
    const selectAllCheckbox = document.getElementById('arrival-select-all');
    const deleteButton = document.getElementById('arrival-delete-selected');
    const markInHouseButton = document.getElementById('arrival-mark-inhouse-selected');
    const headerCells = document.querySelectorAll('thead th[data-sort-key]');
    let allArrivals = [];
    let currentSortKey = 'room';
    let currentSortDir = 'asc';
    let currentPage = 1;
    let selectedIds = new Set(); // track selected by confirmation_number

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        // Fallback: try to get from hidden input
        if (!cookieValue) {
            const csrfInput = document.querySelector('input[name="csrfmiddlewaretoken"]');
            if (csrfInput) {
                cookieValue = csrfInput.value;
            }
        }
        return cookieValue;
    }

    function updateActionButtons() {
        const disabled = selectedIds.size === 0;
        if (deleteButton) deleteButton.disabled = disabled;
        if (markInHouseButton) markInHouseButton.disabled = disabled;
    }

    function renderTable() {
        const q = (searchInput.value || '').toLowerCase().trim();
        tbody.innerHTML = '';

        let filtered = allArrivals.filter(item => {
            if (!q) return true;
            const haystack = [
                item.room,
                item.guest_name,
                item.phone,
                item.confirmation_number,
                item.travel_agent_name,
                item.country,
                item.nationality,
            ].map(v => (v || '').toString().toLowerCase()).join(' ');
            return haystack.includes(q);
        });

        // Sort
        if (currentSortKey) {
            filtered = filtered.slice().sort((a, b) => {
                const av = a[currentSortKey];
                const bv = b[currentSortKey];

                // Handle null/undefined
                if (av == null && bv == null) return 0;
                if (av == null) return currentSortDir === 'asc' ? 1 : -1;
                if (bv == null) return currentSortDir === 'asc' ? -1 : 1;

                // Numeric sort for nights
                if (currentSortKey === 'nights') {
                    const an = Number(av) || 0;
                    const bn = Number(bv) || 0;
                    return currentSortDir === 'asc' ? an - bn : bn - an;
                }

                const as = av.toString().toLowerCase();
                const bs = bv.toString().toLowerCase();
                if (as < bs) return currentSortDir === 'asc' ? -1 : 1;
                if (as > bs) return currentSortDir === 'asc' ? 1 : -1;
                return 0;
            });
        }

        const total = filtered.length;
        const pageSizeVal = pageSizeSelect ? pageSizeSelect.value : 'all';
        let pageSize = pageSizeVal === 'all' ? total || 1 : parseInt(pageSizeVal, 10) || total || 1;

        const totalPages = pageSizeVal === 'all' ? 1 : Math.max(1, Math.ceil(total / pageSize));
        if (currentPage > totalPages) currentPage = totalPages;
        if (currentPage < 1) currentPage = 1;

        const startIndex = pageSizeVal === 'all' ? 0 : (currentPage - 1) * pageSize;
        const endIndex = pageSizeVal === 'all' ? total : Math.min(startIndex + pageSize, total);
        const pageItems = filtered.slice(startIndex, endIndex);

        if (countLabel) {
            if (!total) {
                countLabel.textContent = '0 rows';
            } else if (pageSizeVal === 'all') {
                countLabel.textContent = `${total} rows`;
            } else {
                countLabel.textContent = `Showing ${startIndex + 1}â€“${endIndex} of ${total}`;
            }
        }

        if (!pageItems.length) {
            tbody.innerHTML = '<tr><td colspan="12" class="text-center py-4 text-muted">No arrivals found.</td></tr>';
            return;
        }

        pageItems.forEach(item => {
            const tr = document.createElement('tr');
            const id = item.confirmation_number || '';
            const isSelected = id && selectedIds.has(id);
            tr.classList.toggle('selected-row', isSelected);

            tr.innerHTML = `
                <td><input type="checkbox" class="arrival-row-checkbox" data-id="${id}" ${isSelected ? 'checked' : ''}></td>
                <td>${item.room || '-'}</td>
                <td>${item.guest_name || '-'}</td>
                <td>${item.confirmation_number || '-'}</td>
                <td>${item.phone || '-'}</td>
                <td>${item.country || '-'}</td>
                <td>${item.travel_agent_name || '-'}</td>
                <td>${item.arrival_date || '-'}</td>
                <td>${item.departure_date || '-'}</td>
                <td>${item.nights != null ? item.nights : '-'}</td>
                <td>${item.status || '-'}</td>
                <td>
                    <div class="btn-group btn-group-sm" role="group">
                        <button type="button" class="btn btn-outline-info btn-sm arrival-edit-btn" data-id="${id}" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button type="button" class="btn btn-outline-primary btn-sm arrival-mark-inhouse-btn" data-id="${id}" title="Mark In-House">
                            <i class="fas fa-bed"></i>
                        </button>
                        <button type="button" class="btn btn-outline-danger btn-sm arrival-delete-btn" data-id="${id}" title="Delete">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                </td>
            `;

            // Row click toggles checkbox & selection (but not when clicking action buttons)
            tr.addEventListener('click', (e) => {
                // Don't toggle if clicking on checkbox, action buttons, or inside action buttons
                if (e.target && (
                    e.target.classList.contains('arrival-row-checkbox') ||
                    e.target.closest('.arrival-delete-btn') ||
                    e.target.closest('.arrival-mark-inhouse-btn') ||
                    e.target.closest('.arrival-edit-btn') ||
                    e.target.closest('.btn-group')
                )) {
                    return;
                }
                const cb = tr.querySelector('.arrival-row-checkbox');
                if (!cb) return;
                cb.checked = !cb.checked;
                const cid = cb.dataset.id;
                if (cid) {
                    if (cb.checked) {
                        selectedIds.add(cid);
                    } else {
                        selectedIds.delete(cid);
                    }
                }
                tr.classList.toggle('selected-row', cb.checked);
                if (selectAllCheckbox) {
                    const checkboxes = tbody.querySelectorAll('.arrival-row-checkbox');
                    const allChecked = checkboxes.length > 0 && Array.from(checkboxes).every(c => c.checked);
                    selectAllCheckbox.checked = allChecked;
                }
                updateActionButtons();
            });

            // Checkbox change keeps selection state
            const cb = tr.querySelector('.arrival-row-checkbox');
            if (cb) {
                cb.addEventListener('change', () => {
                    const cid = cb.dataset.id;
                    if (cid) {
                        if (cb.checked) {
                            selectedIds.add(cid);
                        } else {
                            selectedIds.delete(cid);
                        }
                    }
                    tr.classList.toggle('selected-row', cb.checked);
                    if (selectAllCheckbox) {
                        const checkboxes = tbody.querySelectorAll('.arrival-row-checkbox');
                        const allChecked = checkboxes.length > 0 && Array.from(checkboxes).every(c => c.checked);
                        selectAllCheckbox.checked = allChecked;
                    }
                    updateActionButtons();
                });
            }

            // Individual delete button
            const deleteBtn = tr.querySelector('.arrival-delete-btn');
            if (deleteBtn) {
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const cid = deleteBtn.dataset.id;
                    if (!cid) return;
                    if (!confirm('Are you sure you want to delete this arrival?')) {
                        return;
                    }
                    const csrftoken = getCookie('csrftoken');
                    if (!csrftoken) {
                        alert('CSRF token not found. Please refresh the page.');
                        return;
                    }
                    fetch("{% url 'guest_experience:delete_arrivals' %}", {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrftoken
                        },
                        body: JSON.stringify({ confirmation_numbers: [cid] })
                    })
                    .then(response => {
                        if (!response.ok) {
                            return response.json().then(err => {
                                throw new Error(err.error || 'Failed to delete arrival');
                            });
                        }
                        return response.json();
                    })
                    .then(() => {
                        selectedIds.delete(cid);
                        updateActionButtons();
                        loadArrivals();
                    })
                    .catch((error) => {
                        console.error('Delete error:', error);
                        alert('Failed to delete arrival: ' + error.message);
                    });
                });
            }

            // Individual mark in-house button
            const markInHouseBtn = tr.querySelector('.arrival-mark-inhouse-btn');
            if (markInHouseBtn) {
                markInHouseBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const cid = markInHouseBtn.dataset.id;
                    if (!cid) return;
                    const csrftoken = getCookie('csrftoken');
                    if (!csrftoken) {
                        alert('CSRF token not found. Please refresh the page.');
                        return;
                    }
                    fetch("{% url 'guest_experience:mark_in_house' %}", {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrftoken
                        },
                        body: JSON.stringify({ confirmation_numbers: [cid] })
                    })
                    .then(response => {
                        if (!response.ok) {
                            return response.json().then(err => {
                                throw new Error(err.error || 'Failed to update arrival');
                            });
                        }
                        return response.json();
                    })
                    .then(() => {
                        selectedIds.delete(cid);
                        updateActionButtons();
                        loadArrivals();
                    })
                    .catch((error) => {
                        console.error('Mark In-House error:', error);
                        alert('Failed to mark arrival as In-House: ' + error.message);
                    });
                });
            }

            // Individual edit button
            const editBtn = tr.querySelector('.arrival-edit-btn');
            if (editBtn) {
                editBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const cid = editBtn.dataset.id;
                    if (!cid) return;
                    
                    // Load reservation data
                    const editUrl = `/guest-experience/arrivals/edit/${encodeURIComponent(cid)}/`;
                    fetch(editUrl)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Failed to load reservation data');
                            }
                            return response.json();
                        })
                        .then(data => {
                            // Populate modal fields
                            document.getElementById('edit-confirmation-number').value = data.confirmation_number || '';
                            document.getElementById('edit-confirmation-display').value = data.confirmation_number || '';
                            document.getElementById('edit-room').value = data.room || '';
                            document.getElementById('edit-first-name').value = data.first_name || '';
                            document.getElementById('edit-last-name').value = data.last_name || '';
                            document.getElementById('edit-guest-name').value = data.guest_name || '';
                            document.getElementById('edit-phone').value = data.phone || '';
                            document.getElementById('edit-email').value = data.email || '';
                            // Set nationality dropdown value, or add as option if not in list
                            const nationalitySelect = document.getElementById('edit-nationality');
                            const nationalityValue = data.nationality || '';
                            if (nationalityValue) {
                                // Check if the value exists in the options
                                const optionExists = Array.from(nationalitySelect.options).some(opt => opt.value === nationalityValue);
                                if (optionExists) {
                                    nationalitySelect.value = nationalityValue;
                                } else {
                                    // If nationality not in list, add it as an option and select it
                                    const option = document.createElement('option');
                                    option.value = nationalityValue;
                                    option.textContent = nationalityValue;
                                    nationalitySelect.appendChild(option);
                                    nationalitySelect.value = nationalityValue;
                                }
                            } else {
                                nationalitySelect.value = '';
                            }
                            // Set country dropdown value, or add as option if not in list
                            const countrySelect = document.getElementById('edit-country');
                            const countryValue = data.country || '';
                            if (countryValue) {
                                // Check if the value exists in the options
                                const optionExists = Array.from(countrySelect.options).some(opt => opt.value === countryValue);
                                if (optionExists) {
                                    countrySelect.value = countryValue;
                                } else {
                                    // If country not in list, add it as an option and select it
                                    const option = document.createElement('option');
                                    option.value = countryValue;
                                    option.textContent = countryValue;
                                    countrySelect.appendChild(option);
                                    countrySelect.value = countryValue;
                                }
                            } else {
                                countrySelect.value = '';
                            }
                            document.getElementById('edit-travel-agent').value = data.travel_agent_name || '';
                            document.getElementById('edit-arrival-date').value = data.arrival_date || '';
                            document.getElementById('edit-departure-date').value = data.departure_date || '';
                            document.getElementById('edit-status').value = data.status || 'Expected';
                            document.getElementById('edit-eta').value = data.eta || '';
                            
                            // Show modal
                            const modal = new bootstrap.Modal(document.getElementById('editReservationModal'));
                            modal.show();
                        })
                        .catch((error) => {
                            console.error('Load error:', error);
                            alert('Failed to load reservation data: ' + error.message);
                        });
                });
            }

            tbody.appendChild(tr);
        });
    }

    // Handle edit form submission
    const editForm = document.getElementById('editReservationForm');
    if (editForm) {
        editForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const confirmationNumber = document.getElementById('edit-confirmation-number').value;
            if (!confirmationNumber) {
                alert('Confirmation number is required.');
                return;
            }

            const formData = {
                room: document.getElementById('edit-room').value.trim(),
                first_name: document.getElementById('edit-first-name').value.trim(),
                last_name: document.getElementById('edit-last-name').value.trim(),
                guest_name: document.getElementById('edit-guest-name').value.trim(),
                phone: document.getElementById('edit-phone').value.trim(),
                email: document.getElementById('edit-email').value.trim(),
                nationality: document.getElementById('edit-nationality').value.trim(),
                country: document.getElementById('edit-country').value.trim(),
                travel_agent_name: document.getElementById('edit-travel-agent').value.trim(),
                arrival_date: document.getElementById('edit-arrival-date').value,
                departure_date: document.getElementById('edit-departure-date').value,
                status: document.getElementById('edit-status').value,
                eta: document.getElementById('edit-eta').value.trim(),
            };

            const csrftoken = getCookie('csrftoken');
            if (!csrftoken) {
                alert('CSRF token not found. Please refresh the page.');
                return;
            }

            const updateUrl = `/guest-experience/arrivals/edit/${encodeURIComponent(confirmationNumber)}/`;
            fetch(updateUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify(formData)
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => {
                        throw new Error(err.error || 'Failed to update reservation');
                    });
                }
                return response.json();
            })
            .then((data) => {
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('editReservationModal'));
                if (modal) modal.hide();
                
                // Reload arrivals
                loadArrivals();
                
                // Show success message
                alert('Reservation updated successfully!');
            })
            .catch((error) => {
                console.error('Update error:', error);
                alert('Failed to update reservation: ' + error.message);
            });
        });
    }

    function loadArrivals() {
        tbody.innerHTML = '<tr><td colspan="12" class="text-center py-4 text-muted">Loading arrivals...</td></tr>';
        let dateVal = dateInput.value;
        // Ensure default is today's date if no value is set
        if (!dateVal) {
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            dateVal = `${yyyy}-${mm}-${dd}`;
            if (dateInput) {
                dateInput.value = dateVal;
            }
        }
        const params = dateVal ? `?date=${encodeURIComponent(dateVal)}` : '';
        fetch("{% url 'guest_experience:arrivals_api' %}" + params)
            .then(response => response.json())
            .then(data => {
                allArrivals = data.results || [];
                selectedIds.clear();
                if (selectAllCheckbox) selectAllCheckbox.checked = false;
                renderTable();
            })
            .catch(() => {
                tbody.innerHTML = '<tr><td colspan="12" class="text-center py-4 text-danger">Failed to load arrivals.</td></tr>';
            });
    }

    if (dateInput) {
        dateInput.addEventListener('change', loadArrivals);
    }
    if (searchInput) {
        searchInput.addEventListener('input', () => {
            currentPage = 1;
            renderTable();
        });
    }
    if (pageSizeSelect) {
        pageSizeSelect.addEventListener('change', () => {
            currentPage = 1;
            renderTable();
        });
    }
    headerCells.forEach(th => {
        th.addEventListener('click', () => {
            const key = th.getAttribute('data-sort-key');
            if (!key) return;
            if (currentSortKey === key) {
                currentSortDir = currentSortDir === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortKey = key;
                currentSortDir = 'asc';
            }
            currentPage = 1;
            renderTable();
        });
    });

    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', () => {
            const checked = selectAllCheckbox.checked;
            const checkboxes = tbody.querySelectorAll('.arrival-row-checkbox');
            checkboxes.forEach(cb => {
                cb.checked = checked;
                const cid = cb.dataset.id;
                const row = cb.closest('tr');
                if (cid) {
                    if (checked) {
                        selectedIds.add(cid);
                    } else {
                        selectedIds.delete(cid);
                    }
                }
                if (row) row.classList.toggle('selected-row', checked);
            });
            updateActionButtons();
        });
    }

    // Initialize action buttons state
    updateActionButtons();

    if (deleteButton) {
        deleteButton.addEventListener('click', () => {
            if (!selectedIds.size) return;
            if (!confirm('Are you sure you want to delete the selected arrivals?')) {
                return;
            }
            const csrftoken = getCookie('csrftoken');
            if (!csrftoken) {
                alert('CSRF token not found. Please refresh the page.');
                return;
            }
            fetch("{% url 'guest_experience:delete_arrivals' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify({ confirmation_numbers: Array.from(selectedIds) })
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => {
                        throw new Error(err.error || 'Failed to delete arrivals');
                    });
                }
                return response.json();
            })
            .then((data) => {
                selectedIds.clear();
                if (selectAllCheckbox) selectAllCheckbox.checked = false;
                updateActionButtons();
                loadArrivals();
            })
            .catch((error) => {
                console.error('Delete error:', error);
                alert('Failed to delete selected arrivals: ' + error.message);
            });
        });
    }

    if (markInHouseButton) {
        markInHouseButton.addEventListener('click', () => {
            if (!selectedIds.size) return;
            const csrftoken = getCookie('csrftoken');
            if (!csrftoken) {
                alert('CSRF token not found. Please refresh the page.');
                return;
            }
            fetch("{% url 'guest_experience:mark_in_house' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify({ confirmation_numbers: Array.from(selectedIds) })
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => {
                        throw new Error(err.error || 'Failed to update arrivals');
                    });
                }
                return response.json();
            })
            .then((data) => {
                selectedIds.clear();
                if (selectAllCheckbox) selectAllCheckbox.checked = false;
                updateActionButtons();
                loadArrivals();
            })
            .catch((error) => {
                console.error('Mark In-House error:', error);
                alert('Failed to mark selected arrivals as In-House: ' + error.message);
            });
        });
    }

    loadArrivals();
});
</script>
{% endblock %}


