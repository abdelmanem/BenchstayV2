{% extends 'dashboard_base.html' %}

{% block title %}Guest Experience - In-House{% endblock %}

{% block extra_css %}
<style>
    .performance-table tbody tr:hover {
        background-color: #e0f2ff !important;
        cursor: pointer;
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-header mb-4">
    <div class="hotel-info d-flex align-items-center justify-content-between">
        <div>
            <h1 class="mb-1">Guests In-House</h1>
            <p class="mb-0 text-white-50">Monitor all current in-house guests and their stay details.</p>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header d-flex flex-wrap justify-content-between align-items-center gap-2">
        <div>
            <h5 class="card-title mb-0">In-House Guests</h5>
            <small class="text-muted">Showing in-house guests for selected date</small>
        </div>
        <div class="d-flex flex-wrap align-items-center gap-3">
            <div class="d-flex flex-column">
                <label class="small text-muted mb-1" for="inhouse-date-filter">Reference Date</label>
                <input type="date" id="inhouse-date-filter" class="form-control form-control-sm" value="{{ today }}">
            </div>
            <div class="d-flex flex-column">
                <label class="small text-muted mb-1" for="inhouse-search-input">Search</label>
                <input type="text" id="inhouse-search-input" class="form-control form-control-sm" placeholder="Search room, guest, country, agent">
            </div>
            <div class="d-flex flex-column">
                <label class="small text-muted mb-1" for="inhouse-page-size">Rows per page</label>
                <select id="inhouse-page-size" class="form-select form-select-sm">
                    <option value="all" selected>All</option>
                    <option value="25">25</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                </select>
            </div>
            <div class="d-flex flex-column">
                <label class="small text-muted mb-1">&nbsp;</label>
                <div id="inhouse-count" class="small text-muted">0 rows</div>
            </div>
        </div>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table performance-table mb-0">
                <thead>
                    <tr>
                        <th role="button" data-sort-key="room">Room</th>
                        <th role="button" data-sort-key="guest_name">Guest Name</th>
                        <th role="button" data-sort-key="confirmation_number">Confirmation #</th>
                        <th role="button" data-sort-key="phone">Phone</th>
                        <th role="button" data-sort-key="country">Country</th>
                        <th role="button" data-sort-key="travel_agent_name">Travel Agent</th>
                        <th role="button" data-sort-key="arrival_date">Arrival</th>
                        <th role="button" data-sort-key="departure_date">Departure</th>
                        <th role="button" data-sort-key="nights">Nights</th>
                        <th role="button" data-sort-key="status">Status</th>
                    </tr>
                </thead>
                <tbody id="inhouse-body">
                    <tr>
                        <td colspan="10" class="text-center py-4 text-muted">
                            Loading in-house guests...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const tbody = document.getElementById('inhouse-body');
    const dateInput = document.getElementById('inhouse-date-filter');
    const searchInput = document.getElementById('inhouse-search-input');
    const pageSizeSelect = document.getElementById('inhouse-page-size');
    const countLabel = document.getElementById('inhouse-count');
    const headerCells = document.querySelectorAll('thead th[data-sort-key]');

    let allGuests = [];
    let currentSortKey = 'room';
    let currentSortDir = 'asc';
    let currentPage = 1;

    function renderTable() {
        const q = (searchInput.value || '').toLowerCase().trim();
        tbody.innerHTML = '';

        let filtered = allGuests.filter(item => {
            if (!q) return true;
            const haystack = [
                item.room,
                item.guest_name,
                item.confirmation_number,
                item.phone,
                item.country,
                item.travel_agent_name,
            ].map(v => (v || '').toString().toLowerCase()).join(' ');
            return haystack.includes(q);
        });

        if (currentSortKey) {
            filtered = filtered.slice().sort((a, b) => {
                const av = a[currentSortKey];
                const bv = b[currentSortKey];

                if (av == null && bv == null) return 0;
                if (av == null) return currentSortDir === 'asc' ? 1 : -1;
                if (bv == null) return currentSortDir === 'asc' ? -1 : 1;

                if (currentSortKey === 'nights') {
                    const an = Number(av) || 0;
                    const bn = Number(bv) || 0;
                    return currentSortDir === 'asc' ? an - bn : bn - an;
                }

                const as = av.toString().toLowerCase();
                const bs = bv.toString().toLowerCase();
                if (as < bs) return currentSortDir === 'asc' ? -1 : 1;
                if (as > bs) return currentSortDir === 'asc' ? 1 : -1;
                return 0;
            });
        }

        const total = filtered.length;
        const pageSizeVal = pageSizeSelect ? pageSizeSelect.value : 'all';
        let pageSize = pageSizeVal === 'all' ? total || 1 : parseInt(pageSizeVal, 10) || total || 1;

        const totalPages = pageSizeVal === 'all' ? 1 : Math.max(1, Math.ceil(total / pageSize));
        if (currentPage > totalPages) currentPage = totalPages;
        if (currentPage < 1) currentPage = 1;

        const startIndex = pageSizeVal === 'all' ? 0 : (currentPage - 1) * pageSize;
        const endIndex = pageSizeVal === 'all' ? total : Math.min(startIndex + pageSize, total);
        const pageItems = filtered.slice(startIndex, endIndex);

        if (countLabel) {
            if (!total) {
                countLabel.textContent = '0 rows';
            } else if (pageSizeVal === 'all') {
                countLabel.textContent = `${total} rows`;
            } else {
                countLabel.textContent = `Showing ${startIndex + 1}â€“${endIndex} of ${total}`;
            }
        }

        if (!pageItems.length) {
            tbody.innerHTML = '<tr><td colspan="10" class="text-center py-4 text-muted">No in-house guests found.</td></tr>';
            return;
        }

        pageItems.forEach(item => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${item.room || '-'}</td>
                <td>${item.guest_name || '-'}</td>
                <td>${item.confirmation_number || '-'}</td>
                <td>${item.phone || '-'}</td>
                <td>${item.country || '-'}</td>
                <td>${item.travel_agent_name || '-'}</td>
                <td>${item.arrival_date || '-'}</td>
                <td>${item.departure_date || '-'}</td>
                <td>${item.nights != null ? item.nights : '-'}</td>
                <td>${item.status || '-'}</td>
            `;
            tbody.appendChild(tr);
        });
    }

    function loadInHouse() {
        tbody.innerHTML = '<tr><td colspan="10" class="text-center py-4 text-muted">Loading in-house guests...</td></tr>';
        let dateVal = dateInput.value;
        if (!dateVal) {
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            dateVal = `${yyyy}-${mm}-${dd}`;
            if (dateInput) {
                dateInput.value = dateVal;
            }
        }
        const params = dateVal ? `?date=${encodeURIComponent(dateVal)}` : '';
        fetch("{% url 'guest_experience:in_house_api' %}" + params)
            .then(response => response.json())
            .then(data => {
                allGuests = data.results || [];
                currentPage = 1;
                renderTable();
            })
            .catch(() => {
                tbody.innerHTML = '<tr><td colspan="10" class="text-center py-4 text-danger">Failed to load in-house guests.</td></tr>';
            });
    }

    if (dateInput) {
        dateInput.addEventListener('change', () => {
            currentPage = 1;
            loadInHouse();
        });
    }
    if (searchInput) {
        searchInput.addEventListener('input', () => {
            currentPage = 1;
            renderTable();
        });
    }
    if (pageSizeSelect) {
        pageSizeSelect.addEventListener('change', () => {
            currentPage = 1;
            renderTable();
        });
    }
    headerCells.forEach(th => {
        th.addEventListener('click', () => {
            const key = th.getAttribute('data-sort-key');
            if (!key) return;
            if (currentSortKey === key) {
                currentSortDir = currentSortDir === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortKey = key;
                currentSortDir = 'asc';
            }
            currentPage = 1;
            renderTable();
        });
    });

    loadInHouse();
});
</script>
{% endblock %}


