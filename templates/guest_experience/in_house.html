{% extends 'dashboard_base.html' %}

{% block title %}Guest Experience - In-House{% endblock %}

{% block extra_css %}
<style>
    .performance-table tbody tr:hover {
        background-color: #e0f2ff !important;
        cursor: pointer;
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-header mb-4">
    <div class="hotel-info d-flex align-items-center justify-content-between">
        <div>
            <h1 class="mb-1">Guests In-House</h1>
            <p class="mb-0 text-white-50">Monitor all current in-house guests and their stay details.</p>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header d-flex flex-wrap justify-content-between align-items-center gap-2">
        <div>
            <h5 class="card-title mb-0">In-House Guests</h5>
            <small class="text-muted">Showing in-house guests for selected date</small>
        </div>
        <div class="d-flex flex-wrap align-items-center gap-3">
            <div class="d-flex flex-column">
                <label class="small text-muted mb-1" for="inhouse-date-filter">Reference Date</label>
                <input type="date" id="inhouse-date-filter" class="form-control form-control-sm" value="{{ today|date:'Y-m-d' }}">
            </div>
            <div class="d-flex flex-column">
                <label class="small text-muted mb-1" for="inhouse-search-input">Search</label>
                <input type="text" id="inhouse-search-input" class="form-control form-control-sm" placeholder="Search room, guest, country, agent">
            </div>
            <div class="d-flex flex-column">
                <label class="small text-muted mb-1" for="inhouse-page-size">Rows per page</label>
                <select id="inhouse-page-size" class="form-select form-select-sm">
                    <option value="all" selected>All</option>
                    <option value="25">25</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                </select>
            </div>
            <div class="d-flex flex-column">
                <label class="small text-muted mb-1">&nbsp;</label>
                <div id="inhouse-count" class="small text-muted">0 rows</div>
            </div>
        </div>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table performance-table mb-0">
                <thead>
                    <tr>
                        <th role="button" data-sort-key="room">Room</th>
                        <th role="button" data-sort-key="guest_name">Guest Name</th>
                        <th role="button" data-sort-key="confirmation_number">Confirmation #</th>
                        <th role="button" data-sort-key="phone">Phone</th>
                        <th role="button" data-sort-key="country">Country</th>
                        <th role="button" data-sort-key="travel_agent_name">Travel Agent</th>
                        <th role="button" data-sort-key="arrival_date">Arrival</th>
                        <th role="button" data-sort-key="departure_date">Departure</th>
                        <th role="button" data-sort-key="nights">Nights</th>
                        <th role="button" data-sort-key="status">Status</th>
                        <th role="button" data-sort-key="in_house_since">In-House Since</th>
                        <th role="button" data-sort-key="in_house_by">In-House By</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="inhouse-body">
                    <tr>
                        <td colspan="13" class="text-center py-4 text-muted">
                            Loading in-house guests...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Change Room Modal -->
<div class="modal fade" id="changeRoomModal" tabindex="-1" aria-labelledby="changeRoomModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="changeRoomModalLabel">Change Guest Room</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="changeRoomForm">
                    <input type="hidden" id="change_room_confirmation" name="confirmation_number">
                    <div class="mb-3">
                        <label class="form-label"><strong>Guest:</strong> <span id="change_room_guest_name"></span></label>
                        <br>
                        <label class="form-label"><strong>Current Room:</strong> <span id="change_room_current_room"></span></label>
                    </div>
                    <div class="mb-3">
                        <label for="new_room_number" class="form-label">New Room Number <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="new_room_number" name="new_room_number" required placeholder="Enter new room number">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmChangeRoomBtn">
                    <i class="fas fa-door-open me-2"></i>Update Room
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Departure Modal -->
<div class="modal fade" id="departureModal" tabindex="-1" aria-labelledby="departureModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="departureModalLabel">Mark Guest as Departed</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="departureForm">
                    <input type="hidden" id="departure_confirmation" name="confirmation_number">
                    <div class="mb-3">
                        <label class="form-label"><strong>Guest:</strong> <span id="departure_guest_name"></span></label>
                        <br>
                        <label class="form-label"><strong>Room:</strong> <span id="departure_room"></span></label>
                    </div>
                    <div class="mb-3">
                        <label for="departure_method" class="form-label">How was the actual departure made? <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="departure_method" name="departure_method" required placeholder="e.g., Checkout at front desk, Express checkout, Early checkout, etc.">
                    </div>
                    <div class="mb-3">
                        <label for="departure_notes" class="form-label">Comment about the stay</label>
                        <textarea class="form-control" id="departure_notes" name="departure_notes" rows="4" placeholder="Enter any comments or feedback about the guest's stay..."></textarea>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="message_sent_to_guest" name="message_sent_to_guest">
                            <label class="form-check-label" for="message_sent_to_guest">
                                Message sent to guest
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" id="confirmDepartureBtn">
                    <i class="fas fa-sign-out-alt me-2"></i>Mark as Departed
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const tbody = document.getElementById('inhouse-body');
    const dateInput = document.getElementById('inhouse-date-filter');
    const searchInput = document.getElementById('inhouse-search-input');
    const pageSizeSelect = document.getElementById('inhouse-page-size');
    const countLabel = document.getElementById('inhouse-count');
    const headerCells = document.querySelectorAll('thead th[data-sort-key]');

    let allGuests = [];
    let currentSortKey = 'room';
    let currentSortDir = 'asc';
    let currentPage = 1;

    function formatDate(isoString) {
        if (!isoString) return '-';
        const d = new Date(isoString);
        if (isNaN(d.getTime())) return isoString;
        return d.toLocaleDateString(undefined, {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
        });
    }

    function formatDateTime(isoString) {
        if (!isoString) return '-';
        const d = new Date(isoString);
        if (isNaN(d.getTime())) return isoString;
        return d.toLocaleDateString(undefined, {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
        }) + ' ' + d.toLocaleTimeString(undefined, {
            hour: '2-digit',
            minute: '2-digit',
        });
    }

    function renderTable() {
        const q = (searchInput.value || '').toLowerCase().trim();
        tbody.innerHTML = '';

        let filtered = allGuests.filter(item => {
            if (!q) return true;
            const haystack = [
                item.room,
                item.guest_name,
                item.confirmation_number,
                item.phone,
                item.country,
                item.travel_agent_name,
                item.in_house_by,
            ].map(v => (v || '').toString().toLowerCase()).join(' ');
            return haystack.includes(q);
        });

        if (currentSortKey) {
            filtered = filtered.slice().sort((a, b) => {
                const av = a[currentSortKey];
                const bv = b[currentSortKey];

                if (av == null && bv == null) return 0;
                if (av == null) return currentSortDir === 'asc' ? 1 : -1;
                if (bv == null) return currentSortDir === 'asc' ? -1 : 1;

                if (currentSortKey === 'nights') {
                    const an = Number(av) || 0;
                    const bn = Number(bv) || 0;
                    return currentSortDir === 'asc' ? an - bn : bn - an;
                }

                const as = av.toString().toLowerCase();
                const bs = bv.toString().toLowerCase();
                if (as < bs) return currentSortDir === 'asc' ? -1 : 1;
                if (as > bs) return currentSortDir === 'asc' ? 1 : -1;
                return 0;
            });
        }

        const total = filtered.length;
        const pageSizeVal = pageSizeSelect ? pageSizeSelect.value : 'all';
        let pageSize = pageSizeVal === 'all' ? total || 1 : parseInt(pageSizeVal, 10) || total || 1;

        const totalPages = pageSizeVal === 'all' ? 1 : Math.max(1, Math.ceil(total / pageSize));
        if (currentPage > totalPages) currentPage = totalPages;
        if (currentPage < 1) currentPage = 1;

        const startIndex = pageSizeVal === 'all' ? 0 : (currentPage - 1) * pageSize;
        const endIndex = pageSizeVal === 'all' ? total : Math.min(startIndex + pageSize, total);
        const pageItems = filtered.slice(startIndex, endIndex);

        if (countLabel) {
            if (!total) {
                countLabel.textContent = '0 rows';
            } else if (pageSizeVal === 'all') {
                countLabel.textContent = `${total} rows`;
            } else {
                countLabel.textContent = `Showing ${startIndex + 1}â€“${endIndex} of ${total}`;
            }
        }

        if (!pageItems.length) {
            tbody.innerHTML = '<tr><td colspan="13" class="text-center py-4 text-muted">No in-house guests found.</td></tr>';
            return;
        }

        pageItems.forEach(item => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${item.room || '-'}</td>
                <td>${item.guest_name || '-'}</td>
                <td>${item.confirmation_number || '-'}</td>
                <td>${item.phone || '-'}</td>
                <td>${item.country || '-'}</td>
                <td>${item.travel_agent_name || '-'}</td>
                <td>${formatDate(item.arrival_date)}</td>
                <td>${formatDate(item.departure_date)}</td>
                <td>${item.nights != null ? item.nights : '-'}</td>
                <td>${item.status || '-'}</td>
                <td>${formatDateTime(item.in_house_since)}</td>
                <td>${item.in_house_by || '-'}</td>
                <td>
                    <div class="btn-group" role="group">
                        <button class="btn btn-sm btn-primary change-room-btn" 
                                data-confirmation="${item.confirmation_number}"
                                data-room="${item.room || ''}"
                                data-guest="${item.guest_name || ''}"
                                title="Change Room">
                            <i class="fas fa-door-open"></i> Change Room
                        </button>
                        <button class="btn btn-sm btn-warning mark-departed-btn" 
                                data-confirmation="${item.confirmation_number}"
                                data-room="${item.room || ''}"
                                data-guest="${item.guest_name || ''}"
                                title="Mark as Departed">
                            <i class="fas fa-sign-out-alt"></i> Departures
                        </button>
                    </div>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    function loadInHouse() {
        tbody.innerHTML = '<tr><td colspan="13" class="text-center py-4 text-muted">Loading in-house guests...</td></tr>';
        let dateVal = dateInput.value;
        if (!dateVal) {
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            dateVal = `${yyyy}-${mm}-${dd}`;
            if (dateInput) {
                dateInput.value = dateVal;
            }
        }
        const params = dateVal ? `?date=${encodeURIComponent(dateVal)}` : '';
        fetch("{% url 'guest_experience:in_house_api' %}" + params)
            .then(response => response.json())
            .then(data => {
                allGuests = data.results || [];
                currentPage = 1;
                renderTable();
            })
            .catch(() => {
                tbody.innerHTML = '<tr><td colspan="13" class="text-center py-4 text-danger">Failed to load in-house guests.</td></tr>';
            });
    }

    if (dateInput) {
        dateInput.addEventListener('change', () => {
            currentPage = 1;
            loadInHouse();
        });
    }
    if (searchInput) {
        searchInput.addEventListener('input', () => {
            currentPage = 1;
            renderTable();
        });
    }
    if (pageSizeSelect) {
        pageSizeSelect.addEventListener('change', () => {
            currentPage = 1;
            renderTable();
        });
    }
    headerCells.forEach(th => {
        th.addEventListener('click', () => {
            const key = th.getAttribute('data-sort-key');
            if (!key) return;
            if (currentSortKey === key) {
                currentSortDir = currentSortDir === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortKey = key;
                currentSortDir = 'asc';
            }
            currentPage = 1;
            renderTable();
        });
    });

    loadInHouse();

    // Handle Change Room button clicks
    document.addEventListener('click', function(e) {
        if (e.target.closest('.change-room-btn')) {
            const btn = e.target.closest('.change-room-btn');
            const confirmation = btn.getAttribute('data-confirmation');
            const room = btn.getAttribute('data-room');
            const guest = btn.getAttribute('data-guest');
            
            document.getElementById('change_room_confirmation').value = confirmation;
            document.getElementById('change_room_current_room').textContent = room || '-';
            document.getElementById('change_room_guest_name').textContent = guest || '-';
            document.getElementById('new_room_number').value = '';
            
            const modal = new bootstrap.Modal(document.getElementById('changeRoomModal'));
            modal.show();
        }
    });

    // Helper: get CSRF token from cookies
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Handle change room form submission
    const confirmChangeRoomBtn = document.getElementById('confirmChangeRoomBtn');
    if (confirmChangeRoomBtn) {
        confirmChangeRoomBtn.addEventListener('click', function() {
        const form = document.getElementById('changeRoomForm');
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }

        const confirmation = document.getElementById('change_room_confirmation').value;
        const newRoom = document.getElementById('new_room_number').value.trim();

        if (!newRoom) {
            alert('Please enter a room number');
            return;
        }

            const csrftoken = getCookie('csrftoken');

            fetch("{% url 'guest_experience:update_room' %}", {
                method: 'POST',
                credentials: 'same-origin',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify({
                    confirmation_number: confirmation,
                    room: newRoom
                })
            })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(t => { throw new Error('Request failed: ' + response.status + ' ' + t); });
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    const modal = bootstrap.Modal.getInstance(document.getElementById('changeRoomModal'));
                    modal.hide();
                    loadInHouse(); // Reload the table
                } else {
                    alert('Error: ' + (data.error || 'Failed to update room number'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error updating room number. ' + (error.message || 'Please try again.'));
            });
        });
    }

    // Handle Departure button clicks
    document.addEventListener('click', function(e) {
        if (e.target.closest('.mark-departed-btn')) {
            const btn = e.target.closest('.mark-departed-btn');
            const confirmation = btn.getAttribute('data-confirmation');
            const room = btn.getAttribute('data-room');
            const guest = btn.getAttribute('data-guest');
            
            document.getElementById('departure_confirmation').value = confirmation;
            document.getElementById('departure_room').textContent = room || '-';
            document.getElementById('departure_guest_name').textContent = guest || '-';
            document.getElementById('departure_method').value = '';
            document.getElementById('departure_notes').value = '';
            document.getElementById('message_sent_to_guest').checked = false;
            
            const modal = new bootstrap.Modal(document.getElementById('departureModal'));
            modal.show();
        }
    });

    // Handle departure form submission
    const confirmDepartureBtn = document.getElementById('confirmDepartureBtn');
    if (confirmDepartureBtn) {
        confirmDepartureBtn.addEventListener('click', function() {
        const form = document.getElementById('departureForm');
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }

        const confirmation = document.getElementById('departure_confirmation').value;
        const departureMethod = document.getElementById('departure_method').value;
        const departureNotes = document.getElementById('departure_notes').value;
        const messageSent = document.getElementById('message_sent_to_guest').checked;

            const csrftoken = getCookie('csrftoken');

            fetch("{% url 'guest_experience:mark_departed' %}", {
                method: 'POST',
                credentials: 'same-origin',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify({
                    confirmation_number: confirmation,
                    departure_method: departureMethod,
                    departure_notes: departureNotes,
                    message_sent_to_guest: messageSent
                })
            })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(t => { throw new Error('Request failed: ' + response.status + ' ' + t); });
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    const modal = bootstrap.Modal.getInstance(document.getElementById('departureModal'));
                    modal.hide();
                    loadInHouse(); // Reload the table
                } else {
                    alert('Error: ' + (data.error || 'Failed to mark as departed'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error marking guest as departed. ' + (error.message || 'Please try again.'));
            });
        });
    }
});
</script>
{% endblock %}


