{% extends 'dashboard_base.html' %}
{% load math_filters %}
{% load static %}
<!-- {% block page_title %}{{ hotel.name }}{% endblock %} -->
{% block title %}Daily Data - {{ hotel.name }} - Benchstay{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-4">Please fill in the required daily data.</h1>
    
    <!-- Data Entry Cards -->
    <div class="row row-cols-1 row-cols-md-2 g-4 mb-4">
        <!-- Hotel Data Card -->
        <div class="col">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0"><i class="fas fa-hotel me-2"></i>Hotel Data Enty</h5>
                </div>
                <div class="card-body">
                    <form method="post" id="hotelDataForm">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="add_hotel_data">
                        
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="date" class="form-label">Date</label>
                                <input type="date" class="form-control" id="date" name="date" 
                                       value="{{ today }}" required>
                            </div>
                            <div class="col-md-6">
                                <label for="rooms_sold" class="form-label">Rooms Sold</label>
                                <input type="number" class="form-control" id="rooms_sold" 
                                       name="rooms_sold" min="0" max="{{ hotel.total_rooms }}" 
                                       required>
                                <small class="form-text text-muted">
                                    Available: {{ hotel.total_rooms }} rooms
                                </small>
                            </div>
                            <div class="col-12">
                                <label for="total_revenue" class="form-label">Hotel Revenue</label>
                                <div class="input-group">
                                    <span class="input-group-text">EGP</span>
                                    <input type="number" class="form-control" id="total_revenue" 
                                           name="total_revenue" min="0" step="0.01" required>
                                </div>
                            </div>
                            <div class="col-12">
                                <label for="notes" class="form-label">Notes</label>
                                <textarea class="form-control" id="notes" name="notes" 
                                          rows="2" placeholder="Additional comments..."></textarea>
                            </div>
                            <div class="col-12 text-end">
                                <button type="submit" class="btn btn-primary px-4">
                                    <i class="fas fa-save me-2"></i>Save
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Competitor Data Card -->
        <div class="col">
            <div class="card shadow">
                <div class="card-header bg-info text-white">
                    <h5 class="card-title mb-0"><i class="fas fa-users me-2"></i>Competitors Data Entry</h5>
                </div>
                <div class="card-body">
                    <form method="post" id="competitorDataForm">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="add_competitor_data">
                        
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="competitor_date" class="form-label">Date</label>
                                <input type="date" class="form-control" id="competitor_date" 
                                       name="date" value="{{ today }}" required>
                            </div>
                            <div class="col-md-6">
                                <label for="competitor" class="form-label">Competitor</label>
                                <select class="form-select" id="competitor" name="competitor_id" required>
                                    <option value="">Select competitor...</option>
                                    {% for competitor in competitors %}
                                    <option value="{{ competitor.id }}" data-total-rooms="{{ competitor.total_rooms }}">{{ competitor.name }}</option>
                                    {% endfor %}
                                </select>
                                <small class="form-text text-muted">
                                    Available: <span id="competitor-available-rooms">-</span> rooms
                                </small>
                            </div>
                            <div class="col-md-6">
                                <label for="rooms_sold" class="form-label">Rooms Sold</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="rooms_sold" 
                                           name="rooms_sold" min="0" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label for="estimated_average_rate" class="form-label">ADR</label>
                                <div class="input-group">
                                    <span class="input-group-text">EGP</span>
                                    <input type="number" class="form-control" id="estimated_average_rate" 
                                           name="estimated_average_rate" min="0" step="0.01" required>
                                </div>
                            </div>
                            <div class="col-12">
                                <label for="competitor_notes" class="form-label">Notes</label>
                                <textarea class="form-control" id="competitor_notes" name="notes" 
                                          rows="2" placeholder="Competitor observations..."></textarea>
                            </div>
                            <div class="col-12 text-end">
                                <button type="submit" class="btn btn-info text-white px-4">
                                    <i class="fas fa-save me-2"></i>Save
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Data Filter Card -->
    <div class="card shadow mb-4">
        <div class="card-header bg-secondary text-white">
            <h5 class="card-title mb-0"><i class="fas fa-filter me-2"></i>Select date range</h5>
        </div>
        <div class="card-body">
            <form method="get" class="row g-3 align-items-end">
                <div class="col-md-3">
                    <label for="start_date" class="form-label">Start Date</label>
                    <input type="date" class="form-control" id="start_date" 
                           name="start_date" value="{{ request.GET.start_date }}"
                           data-display="{% if request.GET.start_date %}{{ request.GET.start_date|date:'d/m/Y' }}{% endif %}"
                           onfocus="this.showPicker()">
                </div>
                <div class="col-md-3">
                    <label for="end_date" class="form-label">End Date</label>
                    <input type="date" class="form-control" id="end_date" 
                           name="end_date" value="{{ request.GET.end_date }}"
                           data-display="{% if request.GET.end_date %}{{ request.GET.end_date|date:'d/m/Y' }}{% endif %}"
                           onfocus="this.showPicker()">
                </div>
                <div class="col-md-3">
                    <label for="data_type" class="form-label">Data Type</label>
                    <select class="form-select" id="data_type" name="data_type">
                        <option value="all" {% if request.GET.data_type == 'all' %}selected{% endif %}>All</option>
                        <option value="hotel" {% if request.GET.data_type == 'hotel' %}selected{% endif %}>Hotel</option>
                        <option value="competitor" {% if request.GET.data_type == 'competitor' %}selected{% endif %}>Competitor</option>
                    </select>
                </div>
                <div class="col-md-3 d-grid">
                    <button type="submit" class="btn btn-secondary">
                        <i class="fas fa-filter me-2"></i>Apply
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Data Tables -->
    <div class="row row-cols-1 g-4">
        <!-- Hotel Data Table -->
        <div class="col">
            <div class="card shadow">
                <div class="card-header bg-success text-white">
                    <h5 class="card-title mb-0"><i class="fas fa-history me-2"></i>Hotel Data History</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Date</th>
                                    <th>Rooms Sold</th>
                                    <th>Occupancy %</th>
                                    <th>Revenue</th>
                                    <th>Avg. Rate</th>
                                    <th>RevPAR</th>
                                    <th>Notes</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for data in hotel_data %}
                                <tr>
                                    <td>{{ data.date|date:"M d, Y" }}</td>
                                    <td>{{ data.rooms_sold }}</td>
                                    <td>{{ data.occupancy_percentage|floatformat:1 }}%</td>
                                    <td>EGP {{ data.total_revenue|floatformat:2 }}</td>
                                    <td>EGP {{ data.average_rate|floatformat:2 }}</td>
                                    <td>EGP {{ data.revpar|floatformat:2 }}</td>
                                    <td class="text-truncate" style="max-width: 150px;" 
                                        title="{{ data.notes }}">
                                        {{ data.notes|default:"-" }}
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-warning edit-hotel-data" 
                                                data-id="{{ data.id }}" title="Edit">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger delete-hotel-data" 
                                                data-id="{{ data.id }}" title="Delete">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="8" class="text-center py-4 text-muted">
                                        No hotel data available
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Competitor Data Table -->
        <div class="col">
            <div class="card shadow mt-4">
                <div class="card-header bg-info text-white">
                    <h5 class="card-title mb-0"><i class="fas fa-chart-line me-2"></i>Competitors Data History</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Date</th>
                                    <th>Competitor</th>
                                    <th>Rooms Sold</th>
                                    <th>Occupancy %</th>
                                    <th>Avg. Rate</th>
                                    <th>Notes</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for data in competitor_data %}
                                <tr>
                                    <td>{{ data.date|date:"M d, Y" }}</td>
                                    <td>{{ data.competitor.name }}</td>
                                    <td>{{ data.rooms_sold }}</td>
                                    <td>{{ data.rooms_sold|default:0|multiply:100|divide:data.competitor.total_rooms|floatformat:1 }}%</td>
                                    <td>EGP {{ data.estimated_average_rate|floatformat:2 }}</td>
                                    <td class="text-truncate" style="max-width: 150px;" 
                                        title="{{ data.notes }}">
                                        {{ data.notes|default:"-" }}
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-warning edit-competitor-data" 
                                                data-id="{{ data.id }}" title="Edit">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger delete-competitor-data" 
                                                data-id="{{ data.id }}" title="Delete">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="6" class="text-center py-4 text-muted">
                                        No competitor data available
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Modals -->
{% include 'hotel_management/partials/edit_modals.html' %}

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this data? This action cannot be undone.</p>
                <form id="deleteDataForm" method="post">
                    {% csrf_token %}
                    <input type="hidden" name="action" id="deleteAction">
                    <input type="hidden" name="data_id" id="deleteDataId">
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" form="deleteDataForm" class="btn btn-danger">Delete</button>
            </div>
        </div>
    </div>
</div>

<!-- Load JavaScript -->
<script src="{% static 'js/data_entry.js' %}"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Set default date range to current month
    const now = new Date();
    const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
    const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);
    
    const formatDate = date => {
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        return `${day}/${month}/${year}`;
    };
    
    const startDateInput = document.getElementById('start_date');
    const endDateInput = document.getElementById('end_date');
    
    // Convert date to YYYY-MM-DD format for input value
    const formatInputDate = date => date.toISOString().split('T')[0];
    
    if (!startDateInput.value) startDateInput.value = formatInputDate(firstDay);
    if (!endDateInput.value) endDateInput.value = formatInputDate(lastDay);
    
    // Add event listeners to format displayed dates
    const formatDisplayDate = date => {
        if (!date) return '';
        const [year, month, day] = date.split('-');
        return `${day}/${month}/${year}`;
    };
    
    startDateInput.addEventListener('change', function() {
        const date = this.value;
        this.setAttribute('data-display', formatDisplayDate(date));
    });
    
    endDateInput.addEventListener('change', function() {
        const date = this.value;
        this.setAttribute('data-display', formatDisplayDate(date));
    });

    // Edit Hotel Data Handler
    document.querySelectorAll('.edit-hotel-data').forEach(button => {
        button.addEventListener('click', async function() {
            const dataId = this.dataset.id;
            try {
                const response = await fetch(`/api/hotel-data/${dataId}/`);
                if (!response.ok) throw new Error('Network response was not ok');
                
                const data = await response.json();
                const modal = new bootstrap.Modal(document.getElementById('editHotelDataModal'));
                
                document.getElementById('editHotelDataId').value = dataId;
                document.querySelector('#editHotelDataModal [name="date"]').value = data.date;
                document.querySelector('#editHotelDataModal [name="rooms_sold"]').value = data.rooms_sold;
                document.querySelector('#editHotelDataModal [name="total_revenue"]').value = data.total_revenue;
                document.querySelector('#editHotelDataModal [name="notes"]').value = data.notes || '';
                
                modal.show();
            } catch (error) {
                console.error('Error:', error);
                alert('Error loading hotel data');
            }
        });
    });

    // Edit Hotel Data Form Submission
    document.getElementById('editHotelDataForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        const dataId = document.getElementById('editHotelDataId').value;

        try {
            const response = await fetch(`/api/hotel-data/${dataId}/update/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                },
                body: formData
            });

            if (!response.ok) {
                throw new Error('Failed to update hotel data');
            }

            const result = await response.json();
            if (result.success) {
                window.location.reload();
            } else {
                alert(result.error || 'Failed to update hotel data');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error updating hotel data. Please try again.');
        }
    });

    // Delete Handler
    document.querySelectorAll('.delete-hotel-data, .delete-competitor-data').forEach(button => {
        button.addEventListener('click', function() {
            const dataId = this.dataset.id;
            const isHotelData = this.classList.contains('delete-hotel-data');
            
            document.getElementById('deleteDataId').value = dataId;
            document.getElementById('deleteAction').value = isHotelData 
                ? 'delete_hotel_data' 
                : 'delete_competitor_data';
            
            new bootstrap.Modal(document.getElementById('deleteConfirmModal')).show();
        });
    });

    // Add similar handlers for competitor data editing
});
</script>
<script>
document.getElementById('competitor').addEventListener('change', function() {
    const selectedOption = this.options[this.selectedIndex];
    const totalRooms = selectedOption.dataset.totalRooms || 0;
    document.getElementById('competitor-available-rooms').textContent = totalRooms;
});
</script>
{% endblock %}