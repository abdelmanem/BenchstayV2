{% extends 'dashboard_base.html' %}

{% block title %}Dashboard - {{ hotel.name }} - Benchstay{% endblock %}

{% block content %}
<!-- Enhanced Hotel Info Header -->
<div class="dashboard-header">
    <div class="hotel-info d-flex align-items-center">
        <div class="me-4">
            <img src="{{ hotel.logo.url|default:'https://via.placeholder.com/90x90/667eea/ffffff?text=HOTEL' }}" 
                 alt="Hotel Logo" class="hotel-logo">
        </div>
        <div>
            <h1 class="mb-2 fw-bold">{{ hotel.name }}</h1>
            <p class="mb-1 opacity-90">
                <i class="fas fa-map-marker-alt me-2"></i>
                {{ hotel.address }}
            </p>
            <div class="date-range">
                <i class="fas fa-calendar-alt me-2"></i>
                {{ start_date|date:"F j, Y" }} - {{ end_date|date:"F j, Y" }}
            </div>
        </div>
    </div>
</div>

<!-- Unified Date Filter Form -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h5 class="card-title mb-0"><i class="fas fa-calendar-alt me-2"></i>Custom Date Range Filter</h5>
            </div>
            <div class="card-body">
                <form method="POST" id="date-filter-form" class="row g-3 align-items-end">
                    {% csrf_token %}
                    <div class="col-md-4">
                        <label for="start_date" class="form-label">From Date</label>
                        <input type="date" class="form-control" id="start_date" name="start_date" value="{{ start_date|date:'Y-m-d' }}" required>
                    </div>
                    <div class="col-md-4">
                        <label for="end_date" class="form-label">To Date</label>
                        <input type="date" class="form-control" id="end_date" name="end_date" value="{{ end_date|date:'Y-m-d' }}" required>
                    </div>
                    <div class="col-md-4">
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fas fa-filter me-2"></i>Apply Filter
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Enhanced Key Performance Metrics -->
<div class="row g-4 mb-5">
    <!-- Occupancy -->
    <div class="col-md-4">
        <div class="metric-card">
            <div class="d-flex justify-content-between align-items-start mb-3">
                <div class="metric-label">
                    <i class="fas fa-bed me-2"></i>Occupancy Rate
                </div>
                <div class="change-badge {% if summary.occ_change > 0 %}positive{% else %}negative{% endif %}">
                    <i class="fas fa-arrow-{% if summary.occ_change > 0 %}up{% else %}down{% endif %}"></i>
                    {{ summary.occ_change|floatformat:1 }}%
                </div>
            </div>
            <div class="metric-value">{{ summary.current_occ|floatformat:system_settings.decimal_places_percentage }}%</div>
            <div class="text-muted small">
                Prior Year: {{ summary.prior_year_occ|floatformat:system_settings.decimal_places_percentage }}%
            </div>
        </div>
    </div>
    <!-- ADR -->
    <div class="col-md-4">
        <div class="metric-card">
            <div class="d-flex justify-content-between align-items-start mb-3">
                <div class="metric-label">
                    <i class="fas fa-dollar-sign me-2"></i>ADR (Average Daily Rate)
                </div>
                <div class="change-badge {% if summary.adr_change > 0 %}positive{% else %}negative{% endif %}">
                    <i class="fas fa-arrow-{% if summary.adr_change > 0 %}up{% else %}down{% endif %}"></i>
                    {{ summary.adr_change|floatformat:1 }}%
                </div>
            </div>
            <div class="metric-value">{{ system_settings.effective_currency_symbol }} {{ summary.current_adr|floatformat:system_settings.decimal_places_currency }}</div>
            <div class="text-muted small">
                Prior Year: {{ system_settings.effective_currency_symbol }} {{ summary.prior_year_adr|floatformat:system_settings.decimal_places_currency }}
            </div>
        </div>
    </div>
    <!-- RevPAR -->
    <div class="col-md-4">
        <div class="metric-card">
            <div class="d-flex justify-content-between align-items-start mb-3">
                <div class="metric-label">
                    <i class="fas fa-chart-line me-2"></i>RevPAR
                </div>
                <div class="change-badge {% if summary.revpar_change > 0 %}positive{% else %}negative{% endif %}">
                    <i class="fas fa-arrow-{% if summary.revpar_change > 0 %}up{% else %}down{% endif %}"></i>
                    {{ summary.revpar_change|floatformat:1 }}%
                </div>
            </div>
            <div class="metric-value">{{ system_settings.effective_currency_symbol }} {{ summary.current_revpar|floatformat:system_settings.decimal_places_currency }}</div>
            <div class="text-muted small">
                Prior Year: {{ system_settings.effective_currency_symbol }} {{ summary.prior_year_revpar|floatformat:system_settings.decimal_places_currency }}
            </div>
        </div>
    </div>
</div>

<!-- Revenue Metrics Charts - Side by Side -->
<div class="row mb-5">
    <div class="col-12 mb-3">
        <h3 class="section-title">
            <i class="fas fa-chart-area me-2"></i>Revenue Performance Analytics
        </h3>
    </div>
    
    <!-- No Data Message -->
    {% if not summary.current_occ and not summary.current_adr and not summary.current_revpar %}
    <div class="col-12">
        <div class="alert alert-info text-center">
            <i class="fas fa-info-circle me-2"></i>
            <strong>No data available</strong> for the selected date range. 
            Please enter some hotel data or adjust your date filter to see charts.
        </div>
    </div>
    {% endif %}
    
    <!-- Budget Goal Message -->
    <!-- Debug: budget_goal = {{ budget_goal }}, summary.current_occ = {{ summary.current_occ }}, summary.current_adr = {{ summary.current_adr }}, summary.current_revpar = {{ summary.current_revpar }} -->
    {% if not budget_goal %}
        {% if summary.current_occ or summary.current_adr or summary.current_revpar %}
        <div class="col-12">
            <div class="alert alert-warning text-center">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>No budget goal found</strong> for the selected date range ({{ start_date|date:"F j, Y" }} - {{ end_date|date:"F j, Y" }}). 
                <a href="{% url 'hotel_management:budget_goals' %}" class="alert-link">Set up budget goals</a> to see target comparisons.
            </div>
        </div>
        {% endif %}
    {% endif %}
    
    <!-- Occupancy Chart -->
    <div class="col-lg-4 mb-4">
        <div class="chart-section">
            <div class="section-header-small">
                <h5 class="chart-title">
                    <i class="fas fa-bed me-2"></i>Occupancy Rate
                    {% if budget_goal and budget_goal.occupancy_goal %}
                    <span class="badge bg-success ms-2" title="Budget goal available for {{ budget_goal.fiscal_year }} {{ budget_goal.get_period_type_display }}{% if budget_goal.period_detail %} {{ budget_goal.period_detail }}{% endif %}">
                        <i class="fas fa-bullseye me-1"></i>Goal Set
                    </span>
                    {% endif %}
                    <span id="occupancy-alert-icon" class="ms-2" style="display: none;">
                        <i class="fas fa-exclamation-triangle text-warning" title="Performance below goal"></i>
                    </span>
                </h5>
            </div>
            
            <div class="chart-container-compact" id="occupancy-chart-container" 
                 title="{% if budget_goal and budget_goal.occupancy_goal and summary.current_occ %}{% if goal_comparison.occupancy_met %}Meeting occupancy goal of {{ budget_goal.occupancy_goal|floatformat:1 }}%{% else %}Missing occupancy goal of {{ budget_goal.occupancy_goal|floatformat:1 }}% by {{ goal_comparison.occupancy_diff|floatformat:1 }}%{% endif %}{% else %}No goal set for this period{% endif %}">
                <canvas id="occupancyChart"></canvas>
                <div class="performance-indicator">
                    <div id="occupancy-value" class="value">{{ summary.current_occ|floatformat:system_settings.decimal_places_percentage }}%</div>
                    <div class="label">Target: <span id="occupancy-target">{% if budget_goal and budget_goal.occupancy_goal %}{{ budget_goal.occupancy_goal|floatformat:1 }}%{% else %}—{% endif %}</span></div>
                    {% if budget_goal and budget_goal.occupancy_goal and summary.current_occ %}
                    <div class="goal-comparison">
                        {% if goal_comparison.occupancy_met %}
                        <span class="badge bg-success" title="Meeting or exceeding goal">
                            <i class="fas fa-check-circle me-1"></i>On Target
                        </span>
                        {% else %}
                        <span class="badge bg-warning" title="Below goal">
                            <i class="fas fa-exclamation-triangle me-1"></i>{{ goal_comparison.occupancy_diff|floatformat:1 }}% Below
                        </span>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- ADR Chart -->
    <div class="col-lg-4 mb-4">
        <div class="chart-section">
            <div class="section-header-small">
                <h5 class="chart-title">
                    <i class="fas fa-dollar-sign me-2"></i>Average Daily Rate
                    {% if budget_goal and budget_goal.adr_goal %}
                    <span class="badge bg-success ms-2" title="Budget goal available for {{ budget_goal.fiscal_year }} {{ budget_goal.get_period_type_display }}{% if budget_goal.period_detail %} {{ budget_goal.period_detail }}{% endif %}">
                        <i class="fas fa-bullseye me-1"></i>Goal Set
                    </span>
                    {% endif %}
                    <span id="adr-alert-icon" class="ms-2" style="display: none;">
                        <i class="fas fa-exclamation-triangle text-warning" title="Performance below goal"></i>
                    </span>
                </h5>
            </div>
            
            <div class="chart-container-compact" id="adr-chart-container" 
                 title="{% if budget_goal and budget_goal.adr_goal and summary.current_adr %}{% if summary.current_adr >= budget_goal.adr_goal %}Meeting ADR goal of {{ budget_goal.adr_goal|floatformat:2 }}{% else %}Missing ADR goal of {{ budget_goal.adr_goal|floatformat:2 }} by {{ budget_goal.adr_goal|floatformat:2|add:'-'|add:summary.current_adr|floatformat:2 }}{% endif %}{% else %}No goal set for this period{% endif %}">
                <canvas id="adrChart"></canvas>
                <div class="performance-indicator">
                    <div id="adr-value" class="value">{{ summary.current_adr|floatformat:system_settings.decimal_places_currency }}</div>
                    <div class="label">Target: <span id="adr-target">{% if budget_goal and budget_goal.adr_goal %}{{ budget_goal.adr_goal|floatformat:2 }}{% else %}—{% endif %}</span></div>
                    <div id="adr-goal-comparison" class="goal-comparison" style="display: none;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- RevPAR Chart -->
    <div class="col-lg-4 mb-4">
        <div class="chart-section">
            <div class="section-header-small">
                <h5 class="chart-title">
                    <i class="fas fa-chart-line me-2"></i>RevPAR
                    {% if budget_goal and budget_goal.revpar_goal %}
                    <span class="badge bg-success ms-2" title="Budget goal available for {{ budget_goal.fiscal_year }} {{ budget_goal.get_period_type_display }}{% if budget_goal.period_detail %} {{ budget_goal.period_detail }}{% endif %}">
                        <i class="fas fa-bullseye me-1"></i>Goal Set
                    </span>
                    {% endif %}
                    <span id="revpar-alert-icon" class="ms-2" style="display: none;">
                        <i class="fas fa-exclamation-triangle text-warning" title="Performance below goal"></i>
                    </span>
                </h5>
            </div>
            
            <div class="chart-container-compact" id="revpar-chart-container"
                 title="{% if budget_goal and budget_goal.revpar_goal and summary.current_revpar %}{% if summary.current_revpar >= budget_goal.revpar_goal %}Meeting RevPAR goal of {{ budget_goal.revpar_goal|floatformat:2 }}{% else %}Missing RevPAR goal of {{ budget_goal.revpar_goal|floatformat:2 }} by {{ budget_goal.revpar_goal|floatformat:2|add:'-'|add:summary.current_revpar|floatformat:2 }}{% endif %}{% else %}No goal set for this period{% endif %}">
                <canvas id="revparChart"></canvas>
                <div class="performance-indicator">
                    <div id="revpar-value" class="value">{{ summary.current_revpar|floatformat:system_settings.decimal_places_currency }}</div>
                    <div class="label">Target: <span id="revpar-target">{% if budget_goal and budget_goal.revpar_goal %}{{ budget_goal.revpar_goal|floatformat:2 }}{% else %}—{% endif %}</span></div>
                    <div id="revpar-goal-comparison" class="goal-comparison" style="display: none;"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Color Customization Controls -->

<!-- Enhanced Performance Indices -->
<div class="row mb-5">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="fw-bold mb-0">
                        <i class="fas fa-chart-bar me-2"></i>Performance Indices
                    </h5>
                    <span class="badge bg-primary">Market Analysis</span>
                </div>
            </div>
            <div class="table-responsive">
                <table class="table performance-table mb-0">
                    <thead>
                        <tr>
                            <th>Performance Index</th>
                            <th class="text-center">Current Period</th>
                            <th class="text-center">Prior Year</th>
                            <th class="text-center">Change</th>
                            <th class="text-center">Market Rank</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="fw-semibold"><i class="fas fa-users text-primary me-2"></i>MPI</td>
                            <td class="text-center fw-bold">{{ indices.current_mpi|floatformat:system_settings.decimal_places_percentage }}</td>
                            <td class="text-center">{{ indices.prior_year_mpi|floatformat:system_settings.decimal_places_percentage }}</td>
                            <td class="text-center">
                                <span class="change-badge {% if indices.mpi_change > 0 %}positive{% else %}negative{% endif %}">
                                    <i class="fas fa-arrow-{% if indices.mpi_change > 0 %}up{% else %}down{% endif %}"></i>{{ indices.mpi_change|floatformat:system_settings.decimal_places_percentage }}%
                                </span>
                            </td>
                            <td class="text-center"><span class="rank-badge">{{ indices.mpi_rank }} of {{ indices.total_competitors }}</span></td>
                        </tr>
                        <tr>
                            <td class="fw-semibold"><i class="fas fa-money-bill-wave text-success me-2"></i>ARI</td>
                            <td class="text-center fw-bold">{{ indices.current_ari|floatformat:system_settings.decimal_places_percentage }}</td>
                            <td class="text-center">{{ indices.prior_year_ari|floatformat:system_settings.decimal_places_percentage }}</td>
                            <td class="text-center">
                                <span class="change-badge {% if indices.ari_change > 0 %}positive{% else %}negative{% endif %}">
                                    <i class="fas fa-arrow-{% if indices.ari_change > 0 %}up{% else %}down{% endif %}"></i>{{ indices.ari_change|floatformat:system_settings.decimal_places_percentage }}%
                                </span>
                            </td>
                            <td class="text-center"><span class="rank-badge">{{ indices.ari_rank }} of {{ indices.total_competitors }}</span></td>
                        </tr>
                        <tr>
                            <td class="fw-semibold"><i class="fas fa-trophy text-warning me-2"></i>RGI</td>
                            <td class="text-center fw-bold">{{ indices.current_rgi|floatformat:system_settings.decimal_places_percentage }}</td>
                            <td class="text-center">{{ indices.prior_year_rgi|floatformat:system_settings.decimal_places_percentage }}</td>
                            <td class="text-center">
                                <span class="change-badge {% if indices.rgi_change > 0 %}positive{% else %}negative{% endif %}">
                                    <i class="fas fa-arrow-{% if indices.rgi_change > 0 %}up{% else %}down{% endif %}"></i>{{ indices.rgi_change|floatformat:system_settings.decimal_places_percentage }}%
                                </span>
                            </td>
                            <td class="text-center"><span class="rank-badge">{{ indices.rgi_rank }} of {{ indices.total_competitors }}</span></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
<!-- Market Performance Indices Charts - Side by Side -->
<div class="row mb-5">
    <div class="col-12 mb-3">
        <h3 class="section-title">
            <i class="fas fa-chart-bar me-2"></i>Market Performance Indices
        </h3>
    </div>
    
    <!-- No Data Message for Indices -->
    {% if not indices.current_mpi and not indices.current_ari and not indices.current_rgi %}
    <div class="col-12">
        <div class="alert alert-info text-center">
            <i class="fas fa-info-circle me-2"></i>
            <strong>No performance indices available</strong> for the selected date range. 
            Performance indices are calculated when both hotel and competitor data are available.
        </div>
    </div>
    {% endif %}
    
    <!-- MPI Chart -->
    <div class="col-lg-4 mb-4">
        <div class="chart-section">
            <div class="section-header-small">
                <h5 class="chart-title">
                    <i class="fas fa-users me-2"></i>Market Penetration Index
                </h5>
            </div>
            
            <div class="chart-container-compact">
                <canvas id="mpiChart"></canvas>
                <div class="performance-indicator">
                    <div id="market-share-value" class="value">{{ indices.current_mpi|floatformat:system_settings.decimal_places_percentage }}</div>
                    <div class="label">of Competitive Set</div>
                </div>
            </div>
        </div>
    </div>

    <!-- ARI Chart -->
    <div class="col-lg-4 mb-4">
        <div class="chart-section">
            <div class="section-header-small">
                <h5 class="chart-title">
                    <i class="fas fa-money-bill-wave me-2"></i>Average Rate Index
                </h5>
            </div>
            
            <div class="chart-container-compact">
                <canvas id="ariChart"></canvas>
                <div class="performance-indicator">
                    <div id="rate-index-value" class="value">{{ indices.current_ari|floatformat:system_settings.decimal_places_percentage }}</div>
                    <div id="rate-index-label" class="label">Above Market</div>
                </div>
            </div>
        </div>
    </div>

    <!-- RGI Chart -->
    <div class="col-lg-4 mb-4">
        <div class="chart-section">
            <div class="section-header-small">
                <h5 class="chart-title">
                    <i class="fas fa-trophy me-2"></i>Revenue Generation Index
                </h5>
            </div>
            
            <div class="chart-container-compact">
                <canvas id="rgiChart"></canvas>
                <div class="performance-indicator">
                    <div id="revpar-index-value" class="value">{{ indices.current_rgi|floatformat:system_settings.decimal_places_percentage }}</div>
                    <div id="revpar-index-label" class="label">Fair Share</div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .date-range {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        font-size: 0.875rem;
        font-weight: 500;
        display: inline-block;
    }
    
    .chart-container-compact {
        position: relative;
        height: 250px;
        width: 100%;
        padding: 1rem;
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        background: #ffffff;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        transition: all 0.3s ease;
    }
    
    /* Goal-based chart container styling */
    .chart-container-compact.goal-met {
        border-color: #16A34A;
        box-shadow: 0 4px 15px rgba(22, 163, 74, 0.2);
        background: linear-gradient(145deg, #ffffff, #f0fdf4);
    }
    
    .chart-container-compact.goal-missed {
        border-color: #DC2626;
        box-shadow: 0 4px 15px rgba(220, 38, 38, 0.2);
        background: linear-gradient(145deg, #ffffff, #fef2f2);
        animation: pulse-warning 2s infinite;
    }
    
    .chart-container-compact.goal-missed .performance-indicator .value {
        color: #DC2626;
        animation: shake-warning 0.5s ease-in-out;
    }
    
    @keyframes pulse-warning {
        0%, 100% {
            box-shadow: 0 4px 15px rgba(220, 38, 38, 0.2);
        }
        50% {
            box-shadow: 0 6px 20px rgba(220, 38, 38, 0.4);
        }
    }
    
    @keyframes shake-warning {
        0%, 100% { transform: translateX(0); }
        25% { transform: translateX(-2px); }
        75% { transform: translateX(2px); }
    }

    .chart-container-compact canvas {
        max-width: 80% !important;
        max-height: 80% !important;
        width: auto !important;
        height: auto !important;
    }

    .section-header-small {
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid #f1f5f9;
    }

    .chart-title {
        font-size: 1rem;
        font-weight: 600;
        color: #1e293b;
        margin: 0;
    }
    
    canvas {
        display: block;
        max-width: 100% !important;
        height: auto !important;
    }

    .chart-section {
        background: white;
        border-radius: 15px;
        padding: 1.5rem;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        border: 1px solid #e2e8f0;
        height: 100%;
        overflow: hidden;
    }

    .section-title {
        font-size: 1.25rem;
        font-weight: 700;
        color: #1e293b;
        margin: 0;
    }
    
    /* Circular Charts Styles */
    .circular-metrics-row {
        display: flex;
        justify-content: space-around;
        flex-wrap: wrap;
        gap: 1.5rem;
        margin-top: 1rem;
    }
    
    .circular-chart-card {
        flex: 1;
        min-width: 200px;
        max-width: 300px;
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        transition: all 0.3s ease;
        border: 1px solid #e2e8f0;
    }
    
    .circular-chart-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
    }
    
    .circular-chart-container {
        position: relative;
        height: 200px;
        width: 200px;
        margin: 0 auto;
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        background: #ffffff;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }
    
    .circular-chart-container canvas {
        max-width: 80% !important;
        max-height: 80% !important;
        width: auto !important;
        height: auto !important;
    }
    
    .performance-indicator {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
        width: 100%;
        z-index: 10;
        pointer-events: none;
    }
    
    .performance-indicator .value {
        font-size: 1.5rem;
        font-weight: 700;
        color: #1e293b;
        line-height: 1;
        margin-bottom: 0.25rem;
    }
    
    .performance-indicator .label {
        font-size: 0.75rem;
        color: #64748b;
        margin-top: 0.25rem;
    }
    
    .goal-comparison {
        margin-top: 0.5rem;
    }
    
    .goal-comparison .badge {
        font-size: 0.7rem;
        padding: 0.25rem 0.5rem;
        border-radius: 8px;
    }

    /* Color customization styles */
    .form-control-color {
        width: 100%;
        height: 40px;
        border-radius: 8px;
        border: 2px solid #e2e8f0;
        cursor: pointer;
    }

    .form-control-color:hover {
        border-color: #3b82f6;
    }

    /* Debug styles - remove these after charts are working */
    .chart-container-compact::before {
        content: "";
        display: none;
    }

    .circular-chart-container::before {
        content: "";
        display: none;
    }

    /* Hide debug text when charts are loaded */
    .chart-container-compact canvas + .chart-container-compact::before,
    .circular-chart-container canvas + .circular-chart-container::before {
        display: none;
    }
</style>
{% endblock %}

{% block extra_js %}
<!-- Load Chart.js library -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>

<!-- Test Chart.js loading -->
<script>
console.log('Testing Chart.js loading...');
if (typeof Chart !== 'undefined') {
    console.log('✅ Chart.js loaded successfully:', Chart.version);
} else {
    console.error('❌ Chart.js failed to load');
}
</script>

<!-- Django data for JavaScript -->
<script id="django-data" type="application/json">
{
    "summary": {
        "current_occ": {{ summary.current_occ|default:0|floatformat:1 }},
        "current_adr": {{ summary.current_adr|default:0|floatformat:2 }},
        "current_revpar": {{ summary.current_revpar|default:0|floatformat:2 }},
        "occ_change": {{ summary.occ_change|default:0|floatformat:1 }},
        "adr_change": {{ summary.adr_change|default:0|floatformat:1 }},
        "revpar_change": {{ summary.revpar_change|default:0|floatformat:1 }}
    },
    "indices": {
        "current_mpi": {{ indices.current_mpi|default:0|floatformat:1 }},
        "current_ari": {{ indices.current_ari|default:0|floatformat:1 }},
        "current_rgi": {{ indices.current_rgi|default:0|floatformat:1 }},
        "mpi_rank": {{ indices.mpi_rank|default:0 }},
        "ari_rank": {{ indices.ari_rank|default:0 }},
        "rgi_rank": {{ indices.rgi_rank|default:0 }},
        "total_competitors": {{ indices.total_competitors|default:0 }}
    },
    "dates": {
        "start_date": "{{ start_date|date:'Y-m-d' }}",
        "end_date": "{{ end_date|date:'Y-m-d' }}"
    },
    "budget_goal": {
        "occupancy_goal": {% if budget_goal and budget_goal.occupancy_goal %}{{ budget_goal.occupancy_goal|floatformat:1 }}{% else %}null{% endif %},
        "adr_goal": {% if budget_goal and budget_goal.adr_goal %}{{ budget_goal.adr_goal|floatformat:2 }}{% else %}null{% endif %},
        "revpar_goal": {% if budget_goal and budget_goal.revpar_goal %}{{ budget_goal.revpar_goal|floatformat:2 }}{% else %}null{% endif %},
        "period_type": "{% if budget_goal %}{{ budget_goal.period_type }}{% endif %}",
        "period_detail": "{% if budget_goal %}{{ budget_goal.period_detail }}{% endif %}",
        "fiscal_year": {% if budget_goal %}{{ budget_goal.fiscal_year }}{% else %}null{% endif %}
    },
    "goal_comparison": {
        "occupancy_diff": {% if goal_comparison.occupancy_diff %}{{ goal_comparison.occupancy_diff|floatformat:1 }}{% else %}null{% endif %},
        "occupancy_met": {% if goal_comparison.occupancy_met %}true{% else %}false{% endif %}
    },
    "formatting": {
        "decimal_places_percentage": {{ system_settings.decimal_places_percentage|default:1 }},
        "decimal_places_currency": {{ system_settings.decimal_places_currency|default:2 }}
    }
}
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Check if Chart.js is loaded
    if (typeof Chart === 'undefined') {
        console.error('Chart.js library not loaded!');
        return;
    }

    // Register the DataLabels plugin
    //if (typeof ChartDataLabels !== 'undefined') {
    //    Chart.register(ChartDataLabels);
     //   console.log('✅ DataLabels plugin registered successfully');
    //} else {
    //    console.warn('⚠️ DataLabels plugin not available, charts will render without labels');
    //}

    // Get backend data from Django template context
    let backendData;
    try {
        const dataElement = document.getElementById('django-data');
        if (dataElement) {
            backendData = JSON.parse(dataElement.textContent);
        } else {
            backendData = {
                summary: { current_occ: 0, current_adr: 0, current_revpar: 0, occ_change: 0, adr_change: 0, revpar_change: 0 },
                indices: { current_mpi: 0, current_ari: 0, current_rgi: 0, mpi_rank: 0, ari_rank: 0, rgi_rank: 0, total_competitors: 0 },
                dates: { start_date: '', end_date: '' },
                budget_goal: { occupancy_goal: null, adr_goal: null, revpar_goal: null, period_type: '', period_detail: '', fiscal_year: null },
                goal_comparison: { occupancy_diff: null, occupancy_met: false }
            };
        }
    } catch (error) {
        console.error('Error parsing Django data:', error);
        backendData = {
            summary: { current_occ: 0, current_adr: 0, current_revpar: 0, occ_change: 0, adr_change: 0, revpar_change: 0 },
            indices: { current_mpi: 0, current_ari: 0, current_rgi: 0, mpi_rank: 0, ari_rank: 0, rgi_rank: 0, total_competitors: 0 },
            dates: { start_date: '', end_date: '' },
            budget_goal: { occupancy_goal: null, adr_goal: null, revpar_goal: null, period_type: '', period_detail: '', fiscal_year: null },
            goal_comparison: { occupancy_diff: null, occupancy_met: false }
        };
    }

    // Enhanced color schemes for circular charts
    const circularColorSchemes = {
        occupancy: {
            active: '#FF6B6B',
            background: '#FFE5E5',
            // Goal-based colors
            goal_met: '#16A34A',      // Green when meeting goal
            goal_missed: '#DC2626',   // Red when missing goal
            goal_met_bg: '#DCFCE7',   // Light green background
            goal_missed_bg: '#FEE2E2' // Light red background
        },
        adr: {
            active: '#4ECDC4',
            background: '#E0F7F5',
            // Goal-based colors
            goal_met: '#16A34A',
            goal_missed: '#DC2626',
            goal_met_bg: '#DCFCE7',
            goal_missed_bg: '#FEE2E2'
        },
        revpar: {
            active: '#45B7D1',
            background: '#E3F2FD',
            // Goal-based colors
            goal_met: '#16A34A',
            goal_missed: '#DC2626',
            goal_met_bg: '#DCFCE7',
            goal_missed_bg: '#FEE2E2'
        },
        mpi: {
            active: '#96CEB4',
            background: '#E8F5E8'
        },
        ari: {
            active: '#FFEAA7',
            background: '#FFF8E1'
        },
        rgi: {
            active: '#DDA0DD',
            background: '#F3E5F5'
        }
    };

    // Removed legacy circular progress charts (occupancy-circle, rate-index-circle, etc.)
    
    // Function to create simple circular charts for main metrics
    function createSimpleCircularChart(canvasId, value, max, colorScheme, goalInfo = null) {
        const canvas = document.getElementById(canvasId);
        if (!canvas) {
            console.warn(`Canvas element ${canvasId} not found`);
            return null;
        }

        const ctx = canvas.getContext('2d');
        if (!ctx) {
            console.warn(`Could not get 2D context for ${canvasId}`);
            return null;
        }

        // Ensure value is a number and not negative
        const safeValue = Math.max(0, parseFloat(value) || 0);
        const safeMax = Math.max(safeValue + 1, parseFloat(max) || 100);

        // Determine colors based on goal status (for charts with goals: occupancy, ADR, RevPAR)
        let activeColor = colorScheme.active;
        let backgroundColor = colorScheme.background;
        
        if (goalInfo && goalInfo.goal && goalInfo.currentValue !== null) {
            const goalValue = parseFloat(goalInfo.goal);
            const currentValue = parseFloat(goalInfo.currentValue);
            
            if (currentValue >= goalValue) {
                // Meeting or exceeding goal - use green
                activeColor = colorScheme.goal_met;
                backgroundColor = colorScheme.goal_met_bg;
            } else {
                // Missing goal - use red
                activeColor = colorScheme.goal_missed;
                backgroundColor = colorScheme.goal_missed_bg;
            }
        }

        console.log(`Creating simple chart for ${canvasId}: value=${safeValue}, max=${safeMax}, colors=`, { activeColor, backgroundColor });
        
        return new Chart(ctx, {
            type: 'doughnut',
            data: {
                datasets: [{
                    data: [safeValue, safeMax - safeValue],
                    backgroundColor: [activeColor, backgroundColor],
                    borderWidth: 0,
                    cutout: '75%'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: { enabled: false }
                },
                animation: {
                    animateRotate: true,
                    duration: 1500
                }
            }
        });
    }

    // Initialize main metric charts as circular charts using backend data
    function initializeMainCharts() {
        console.log('Initializing main charts with data:', backendData);
        
        // Use actual backend data
        const data = backendData.summary;
        const indices = backendData.indices;
        const budgetGoal = backendData.budget_goal;

        // Check if we have data before creating charts
        if (!data || !indices) {
            console.warn('No backend data available for charts');
            return;
        }

        // Destroy existing charts if they exist
        const chartNames = ['occupancyChart', 'adrChart', 'revparChart', 'mpiChart', 'ariChart', 'rgiChart'];
        chartNames.forEach(chartName => {
            if (window[chartName] && typeof window[chartName].destroy === 'function') {
                window[chartName].destroy();
            }
        });

        // Use actual values from backend, with fallbacks
        const occupancyValue = parseFloat(data.current_occ) || 0;
        const adrValue = parseFloat(data.current_adr) || 0;
        const revparValue = parseFloat(data.current_revpar) || 0;
        const mpiValue = parseFloat(indices.current_mpi) || 0;
        const ariValue = parseFloat(indices.current_ari) || 0;
        const rgiValue = parseFloat(indices.current_rgi) || 0;

        console.log('Chart values:', { occupancyValue, adrValue, revparValue, mpiValue, ariValue, rgiValue });
        console.log('Budget goal:', budgetGoal);

        // Create charts with appropriate max values
        // Pass goal information for occupancy chart
        const occupancyGoalInfo = {
            goal: budgetGoal && budgetGoal.occupancy_goal ? budgetGoal.occupancy_goal : null,
            currentValue: occupancyValue
        };
        
        window.occupancyChart = createSimpleCircularChart('occupancyChart', occupancyValue, 100, circularColorSchemes.occupancy, occupancyGoalInfo);

        const adrGoalInfo = {
            goal: budgetGoal && budgetGoal.adr_goal ? budgetGoal.adr_goal : null,
            currentValue: adrValue
        };
        window.adrChart = createSimpleCircularChart('adrChart', adrValue, Math.max(200, adrValue * 1.5), circularColorSchemes.adr, adrGoalInfo);

        const revparGoalInfo = {
            goal: budgetGoal && budgetGoal.revpar_goal ? budgetGoal.revpar_goal : null,
            currentValue: revparValue
        };
        window.revparChart = createSimpleCircularChart('revparChart', revparValue, Math.max(150, revparValue * 1.5), circularColorSchemes.revpar, revparGoalInfo);
        window.mpiChart = createSimpleCircularChart('mpiChart', mpiValue, Math.max(120, mpiValue * 1.2), circularColorSchemes.mpi);
        window.ariChart = createSimpleCircularChart('ariChart', ariValue, Math.max(120, ariValue * 1.2), circularColorSchemes.ari);
        window.rgiChart = createSimpleCircularChart('rgiChart', rgiValue, Math.max(120, rgiValue * 1.2), circularColorSchemes.rgi);
        
        // Update the performance indicator values in the HTML
        updatePerformanceIndicators(data, indices, budgetGoal);
        
        console.log('Charts initialized successfully');
    }

    // Function to update performance indicator values in the HTML
    function updatePerformanceIndicators(data, indices, budgetGoal) {
        // Use system decimal settings from the template via data attributes if available in the future.
        // Update occupancy value
        const occupancyValueEl = document.getElementById('occupancy-value');
        const percentageDP = (backendData && backendData.formatting && Number.isInteger(backendData.formatting.decimal_places_percentage)) ? backendData.formatting.decimal_places_percentage : 1;
        const currencyDP = (backendData && backendData.formatting && Number.isInteger(backendData.formatting.decimal_places_currency)) ? backendData.formatting.decimal_places_currency : 2;
        if (occupancyValueEl) {
            occupancyValueEl.textContent = `${parseFloat(data.current_occ || 0).toFixed(percentageDP)}%`;
        }
        
        // Update occupancy target
        const occupancyTargetEl = document.getElementById('occupancy-target');
        if (occupancyTargetEl) {
            if (budgetGoal && budgetGoal.occupancy_goal) {
                occupancyTargetEl.textContent = `${parseFloat(budgetGoal.occupancy_goal).toFixed(1)}%`;
            } else {
                occupancyTargetEl.textContent = '—';
            }
        }
        
        // Update occupancy chart container styling based on goal status
        const occupancyChartContainer = document.querySelector('#occupancyChart').closest('.chart-container-compact');
        const alertIcon = document.getElementById('occupancy-alert-icon');
        
        if (occupancyChartContainer && budgetGoal && budgetGoal.occupancy_goal && data.current_occ !== null) {
            const currentOcc = parseFloat(data.current_occ);
            const goalOcc = parseFloat(budgetGoal.occupancy_goal);
            
            // Remove existing classes
            occupancyChartContainer.classList.remove('goal-met', 'goal-missed');
            
            if (currentOcc >= goalOcc) {
                occupancyChartContainer.classList.add('goal-met');
                if (alertIcon) alertIcon.style.display = 'none';
                // Update tooltip for goal met
                occupancyChartContainer.title = `Meeting occupancy goal of ${goalOcc.toFixed(1)}%`;
            } else {
                occupancyChartContainer.classList.add('goal-missed');
                if (alertIcon) alertIcon.style.display = 'inline';
                // Update tooltip for goal missed
                const diff = (goalOcc - currentOcc).toFixed(1);
                occupancyChartContainer.title = `Missing occupancy goal of ${goalOcc.toFixed(1)}% by ${diff}%`;
            }
        } else {
            // Remove goal-based styling if no goal or data
            occupancyChartContainer.classList.remove('goal-met', 'goal-missed');
            if (alertIcon) alertIcon.style.display = 'none';
            occupancyChartContainer.title = 'No goal set for this period';
        }
        
        // Update ADR value
        const adrValueEl = document.getElementById('adr-value');
        if (adrValueEl) {
            adrValueEl.textContent = parseFloat(data.current_adr || 0).toFixed(currencyDP);
        }
        // Update ADR target and styling
        const adrTargetEl = document.getElementById('adr-target');
        const adrChartContainer = document.getElementById('adr-chart-container');
        const adrAlertIcon = document.getElementById('adr-alert-icon');
        const currentAdr = parseFloat(data.current_adr);
        if (adrTargetEl) {
            if (budgetGoal && budgetGoal.adr_goal) {
                adrTargetEl.textContent = `${parseFloat(budgetGoal.adr_goal).toFixed(2)}`;
            } else {
                adrTargetEl.textContent = '—';
            }
        }
        if (adrChartContainer) {
            adrChartContainer.classList.remove('goal-met', 'goal-missed');
            if (budgetGoal && budgetGoal.adr_goal && !isNaN(currentAdr)) {
                const goalAdr = parseFloat(budgetGoal.adr_goal);
                if (currentAdr >= goalAdr) {
                    adrChartContainer.classList.add('goal-met');
                    if (adrAlertIcon) adrAlertIcon.style.display = 'none';
                    adrChartContainer.title = `Meeting ADR goal of ${goalAdr.toFixed(2)}`;
                } else {
                    adrChartContainer.classList.add('goal-missed');
                    if (adrAlertIcon) adrAlertIcon.style.display = 'inline';
                    const diffAdr = (goalAdr - currentAdr).toFixed(2);
                    adrChartContainer.title = `Missing ADR goal of ${goalAdr.toFixed(2)} by ${diffAdr}`;
                }
            } else {
                if (adrAlertIcon) adrAlertIcon.style.display = 'none';
                adrChartContainer.title = 'No goal set for this period';
            }
        }

        // Update RevPAR value
        const revparValueEl = document.getElementById('revpar-value');
        if (revparValueEl) {
            revparValueEl.textContent = parseFloat(data.current_revpar || 0).toFixed(currencyDP);
        }
        // Update RevPAR target and styling
        const revparTargetEl = document.getElementById('revpar-target');
        const revparChartContainer = document.getElementById('revpar-chart-container');
        const revparAlertIcon = document.getElementById('revpar-alert-icon');
        const currentRevpar = parseFloat(data.current_revpar);
        if (revparTargetEl) {
            if (budgetGoal && budgetGoal.revpar_goal) {
                revparTargetEl.textContent = `${parseFloat(budgetGoal.revpar_goal).toFixed(2)}`;
            } else {
                revparTargetEl.textContent = '—';
            }
        }
        if (revparChartContainer) {
            revparChartContainer.classList.remove('goal-met', 'goal-missed');
            if (budgetGoal && budgetGoal.revpar_goal && !isNaN(currentRevpar)) {
                const goalRevpar = parseFloat(budgetGoal.revpar_goal);
                if (currentRevpar >= goalRevpar) {
                    revparChartContainer.classList.add('goal-met');
                    if (revparAlertIcon) revparAlertIcon.style.display = 'none';
                    revparChartContainer.title = `Meeting RevPAR goal of ${goalRevpar.toFixed(2)}`;
                } else {
                    revparChartContainer.classList.add('goal-missed');
                    if (revparAlertIcon) revparAlertIcon.style.display = 'inline';
                    const diffRevpar = (goalRevpar - currentRevpar).toFixed(2);
                    revparChartContainer.title = `Missing RevPAR goal of ${goalRevpar.toFixed(2)} by ${diffRevpar}`;
                }
            } else {
                if (revparAlertIcon) revparAlertIcon.style.display = 'none';
                revparChartContainer.title = 'No goal set for this period';
            }
        }
        
        // Update MPI value
        const mpiValueEl = document.getElementById('market-share-value');
        if (mpiValueEl) {
            mpiValueEl.textContent = parseFloat(indices.current_mpi || 0).toFixed(percentageDP);
        }
        
        // Update ARI value
        const ariValueEl = document.getElementById('rate-index-value');
        if (ariValueEl) {
            ariValueEl.textContent = parseFloat(indices.current_ari || 0).toFixed(percentageDP);
        }
        
        // Update RGI value
        const rgiValueEl = document.getElementById('revpar-index-value');
        if (rgiValueEl) {
            rgiValueEl.textContent = parseFloat(indices.current_rgi || 0).toFixed(percentageDP);
        }
    }

    // Function to refresh all charts with new date range
    async function refreshAllCharts() {
        try {
            console.log('Refreshing all charts...');
            // Reinitialize all charts
            initializeMainCharts();
        } catch (error) {
            console.error('Error refreshing charts:', error);
        }
    }

    // Function to update chart colors
    function updateChartColors() {
        // Get current color values from color pickers
        const newColors = {
            occupancy: {
                active: document.getElementById('occupancy-color').value,
                background: getLightColor(document.getElementById('occupancy-color').value)
            },
            adr: {
                active: document.getElementById('adr-color').value,
                background: getLightColor(document.getElementById('adr-color').value)
            },
            revpar: {
                active: document.getElementById('revpar-color').value,
                background: getLightColor(document.getElementById('revpar-color').value)
            },
            mpi: {
                active: document.getElementById('mpi-color').value,
                background: getLightColor(document.getElementById('mpi-color').value)
            },
            ari: {
                active: document.getElementById('ari-color').value,
                background: getLightColor(document.getElementById('ari-color').value)
            },
            rgi: {
                active: document.getElementById('rgi-color').value,
                background: getLightColor(document.getElementById('rgi-color').value)
            }
        };

        // Update global color schemes without overwriting goal-based colors
        ['occupancy', 'adr', 'revpar', 'mpi', 'ari', 'rgi'].forEach((key) => {
            if (circularColorSchemes[key] && newColors[key]) {
                circularColorSchemes[key].active = newColors[key].active;
                circularColorSchemes[key].background = newColors[key].background;
            }
        });

        // Recreate all charts with new colors
        refreshAllCharts();
    }

    // Function to get light version of a color
    function getLightColor(hexColor) {
        // Convert hex to RGB
        const r = parseInt(hexColor.slice(1, 3), 16);
        const g = parseInt(hexColor.slice(3, 5), 16);
        const b = parseInt(hexColor.slice(5, 7), 16);
        
        // Make it lighter (add 40% white)
        const lightR = Math.min(255, r + (255 - r) * 0.4);
        const lightG = Math.min(255, g + (255 - g) * 0.4);
        const lightB = Math.min(255, b + (255 - b) * 0.4);
        
        // Convert back to hex
        return '#' + Math.round(lightR).toString(16).padStart(2, '0') + 
                   Math.round(lightG).toString(16).padStart(2, '0') + 
                   Math.round(lightB).toString(16).padStart(2, '0');
    }

    // Function to reset colors to default
    function resetColors() {
        const defaultColors = {
            'occupancy-color': '#FF6B6B',
            'adr-color': '#4ECDC4',
            'revpar-color': '#45B7D1',
            'mpi-color': '#96CEB4',
            'ari-color': '#FFEAA7',
            'rgi-color': '#DDA0DD'
        };

        Object.entries(defaultColors).forEach(([id, color]) => {
            document.getElementById(id).value = color;
        });

        updateChartColors();
    }
    
    // Set up date filter form event listener
    const dateFilterForm = document.getElementById('date-filter-form');
    if (dateFilterForm) {
        dateFilterForm.addEventListener('submit', function(e) {
            // Show loading indicator
            const submitBtn = dateFilterForm.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Loading...';
            submitBtn.disabled = true;
            
            // Log the form submission for debugging
            console.log('Date filter form submitted');
            console.log('Start date:', document.getElementById('start_date').value);
            console.log('End date:', document.getElementById('end_date').value);
            
            // Let the form submit to refresh the page with new data
            // The Django view will handle the date filtering and return updated context
            return true;
        });
    }

    // Set up color customization event listeners
    const applyColorsBtn = document.getElementById('apply-colors');
    const resetColorsBtn = document.getElementById('reset-colors');

    if (applyColorsBtn) {
        applyColorsBtn.addEventListener('click', updateChartColors);
    }

    if (resetColorsBtn) {
        resetColorsBtn.addEventListener('click', resetColors);
    }
    
    // Initialize all charts with backend data
    console.log('Starting chart initialization...');
    
    // Removed debug test chart creation
    
    // Always initialize charts with backend data (even if it's zero)
    console.log('Initializing charts with backend data:', backendData);
    initializeMainCharts();
    
    console.log('Chart initialization complete');
});
</script>
{% endblock %}