{% extends 'dashboard_base.html' %}
{% load reporting_filters %}

{% block title %}Budget & KPI Goals - {{ hotel.name }} - Benchstay{% endblock %}

{% block content %}
<!-- Success/Error Messages -->
{% if messages %}
    <div id="alertContainer">
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                <i class="fas fa-{% if message.tags == 'success' %}check-circle{% elif message.tags == 'error' %}exclamation-circle{% elif message.tags == 'warning' %}exclamation-triangle{% else %}info-circle{% endif %} me-2"></i>
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    </div>
{% else %}
    <div id="alertContainer"></div>
{% endif %}

<!-- Enhanced Dashboard Header -->
<div class="dashboard-header mb-4">
    <div class="hotel-info d-flex align-items-center position-relative">
        <div class="me-4">
            <img src="{{ hotel.logo.url|default:'https://via.placeholder.com/80x80/667eea/ffffff?text=HOTEL' }}" 
                 alt="Hotel Logo" class="hotel-logo">
        </div>
        <div>
            <h1 class="mb-2 fw-bold">{{ hotel.name }}</h1>
            <p class="mb-0 opacity-90">
                <i class="fas fa-hotel me-2"></i>Budget & KPI Goals
            </p>
            <div class="mt-2">
                <span class="badge bg-white text-dark fw-bold">
                    <i class="fas fa-calendar-alt me-1"></i>Current Year: {{ fiscal_year|default:"2025" }}
                </span>
            </div>
        </div>
    </div>
</div>

<!-- Quick Metrics -->
<div class="row g-3 mb-4">
    <div class="col-md-3 col-6">
        <div class="metric-card">
            <div class="metric-value">{{ goals_metrics.total_goals|default:0 }}</div>
            <div class="metric-label">Total Goals</div>
        </div>
    </div>
    <div class="col-md-3 col-6">
        <div class="metric-card">
            <div class="metric-value">{{ goals_metrics.active_goals|default:0 }}</div>
            <div class="metric-label">Active Goals</div>
        </div>
    </div>
    <div class="col-md-3 col-6">
        <div class="metric-card">
            <div class="metric-value">{{ goals_metrics.avg_occupancy|floatformat:1|default:0 }}%</div>
            <div class="metric-label">Avg Occupancy Goal</div>
        </div>
    </div>
    <div class="col-md-3 col-6">
        <div class="metric-card">
            <div class="metric-value" id="metricRevenue">{{ system_settings.effective_currency_symbol }}{{ goals_metrics.total_revenue|format_currency_short|default:0 }}</div>
            <div class="metric-label">Total Revenue Budget</div>
        </div>
    </div>
</div>

<!-- Budget Goals Form -->
<div class="row">
    <div class="col-12">
        <div class="card shadow-sm">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-bullseye me-2"></i>Define Budget and Performance Goals
                </h5>
            </div>
            <div class="card-body">
                <form method="POST" id="budget-goals-form" novalidate>
                    {% csrf_token %}

                    <!-- Period Selection -->
                    <div class="row g-3 mb-4">
                        <div class="col-md-4">
                            <label for="fiscal_year" class="form-label">
                                <i class="fas fa-calendar me-1"></i>Fiscal Year
                            </label>
                            <input type="number" class="form-control" id="fiscal_year" name="fiscal_year" 
                                   value="{{ fiscal_year|default:'2025' }}" min="2000" max="2100" required>
                            <div class="validation-feedback">Please enter a valid fiscal year.</div>
                        </div>
                        <div class="col-md-4">
                            <label for="period_type" class="form-label">
                                <i class="fas fa-clock me-1"></i>Planning Period
                            </label>
                            <select class="form-select" id="period_type" name="period_type" required>
                                <option value="annual" {% if period_type == 'annual' or not period_type %}selected{% endif %}>Annual</option>
                                <option value="quarter" {% if period_type == 'quarter' %}selected{% endif %}>Quarter</option>
                                <option value="monthly" {% if period_type == 'monthly' %}selected{% endif %}>Monthly</option>
                            </select>
                        </div>
                        <div class="col-md-4" id="period_detail_wrapper" {% if period_type == 'annual' or not period_type %}style="display:none;"{% endif %}>
                            <label for="period_detail" class="form-label">
                                <i class="fas fa-list me-1"></i>Period Detail
                            </label>
                            <select class="form-select" id="period_detail" name="period_detail">
                                <option value="">Select Period</option>
                            </select>
                        </div>
                    </div>

                    <hr class="my-4">

                    <!-- Goals Section -->
                    <div class="row g-4">
                        <!-- Key Performance Goals -->
                        <div class="col-md-6">
                            <div class="goal-card performance-card p-4 h-100">
                                <div class="goal-card-header mb-4">
                                    <div class="goal-icon">
                                        <i class="fas fa-chart-line"></i>
                                    </div>
                                    <h6 class="fw-bold mb-0">Key Performance Goals</h6>
                                </div>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label for="occupancy_goal" class="form-label fw-semibold">Occupancy Goal (%)</label>
                                        <div class="input-group input-group-enhanced">
                                            <input type="number" class="form-control" id="occupancy_goal" name="occupancy_goal" 
                                                   value="{{ occupancy_goal|default:'' }}" min="0" max="100" step="0.1" required>
                                            <span class="input-group-text">%</span>
                                        </div>
                                        <div class="validation-feedback">Occupancy must be between 0-100%.</div>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="adr_goal" class="form-label fw-semibold">ADR Goal</label>
                                        <div class="input-group input-group-enhanced">
                                            <span class="input-group-text">{{ system_settings.effective_currency_symbol }}</span>
                                            <input type="number" class="form-control" id="adr_goal" name="adr_goal" 
                                                   value="{{ adr_goal|default:'' }}" min="0" step="0.01" required>
                                        </div>
                                        <div class="validation-feedback">Please enter a valid ADR goal.</div>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="revpar_goal" class="form-label fw-semibold">
                                            RevPAR Goal
                                            <small class="text-muted">(Auto-calculated)</small>
                                        </label>
                                        <div class="input-group input-group-enhanced">
                                            <span class="input-group-text">{{ system_settings.effective_currency_symbol }}</span>
                                            <input type="number" class="form-control" id="revpar_goal" name="revpar_goal" 
                                                   value="{{ revpar_goal|default:'' }}" min="0" step="0.01" required readonly>
                                        </div>
                                        <div class="validation-feedback">Please enter a valid RevPAR goal.</div>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="total_revenue_budget" class="form-label fw-semibold">Total Revenue Budget</label>
                                        <div class="input-group input-group-enhanced">
                                            <span class="input-group-text">{{ system_settings.effective_currency_symbol }}</span>
                                            <input type="number" class="form-control" id="total_revenue_budget" name="total_revenue_budget" 
                                                   value="{{ total_revenue_budget|default:'' }}" min="0" step="0.01">
                                        </div>
                                        <small class="text-muted">Calculated automatically based on RevPAR and rooms</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Market Index Goals -->
                        <div class="col-md-6">
                            <div class="goal-card market-card p-4 h-100">
                                <div class="goal-card-header mb-4">
                                    <div class="goal-icon market-icon">
                                        <i class="fas fa-balance-scale"></i>
                                    </div>
                                    <h6 class="fw-bold mb-0">Market Index Goals <span class="optional-badge">Optional</span></h6>
                                </div>
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <label for="mpi_goal" class="form-label fw-semibold">MPI</label>
                                        <input type="number" class="form-control enhanced-control" id="mpi_goal" name="mpi_goal" 
                                               value="{{ mpi_goal|default:'' }}" min="0" step="0.1" placeholder="1.0">
                                        <small class="text-muted">Market Penetration Index</small>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="ari_goal" class="form-label fw-semibold">ARI</label>
                                        <input type="number" class="form-control enhanced-control" id="ari_goal" name="ari_goal" 
                                               value="{{ ari_goal|default:'' }}" min="0" step="0.1" placeholder="1.0">
                                        <small class="text-muted">Average Rate Index</small>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="rgi_goal" class="form-label fw-semibold">RGI</label>
                                        <input type="number" class="form-control enhanced-control" id="rgi_goal" name="rgi_goal" 
                                               value="{{ rgi_goal|default:'' }}" min="0" step="0.1" placeholder="1.0">
                                        <small class="text-muted">Revenue Generation Index</small>
                                    </div>
                                    <div class="col-12">
                                        <label for="notes" class="form-label fw-semibold">Notes</label>
                                        <textarea class="form-control enhanced-control" id="notes" name="notes" rows="3" 
                                                  placeholder="Additional context, market conditions, or allocation details...">{{ notes|default:'' }}</textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Lock Goals Section -->
                    <div class="lock-goals-section mt-4 p-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="1" id="lock_targets" name="lock_targets" {% if lock_targets_checked %}checked{% endif %}>
                            <label class="form-check-label fw-600" for="lock_targets">
                                <i class="fas fa-lock me-1"></i>Lock goals for this period
                            </label>
                            <div class="lock-help-text">
                                <small class="text-muted">When locked, only the goal creator can modify these targets. This prevents accidental changes to approved budgets.</small>
                            </div>
                        </div>
                    </div>

                    <!-- Form Actions -->
                    <div class="d-flex justify-content-between align-items-center mt-4">
                        <div class="action-info">
                            <small class="text-muted">
                                <i class="fas fa-keyboard me-1"></i>
                                Shortcuts: Ctrl+S (Save), Ctrl+R (Reset), Ctrl+P (Preview)
                            </small>
                        </div>
                        <div>
                            <button type="button" class="btn btn-outline-secondary me-2" id="resetForm">
                                <i class="fas fa-undo me-2"></i>Reset
                            </button>
                            <button type="button" class="btn btn-outline-secondary me-2" id="previewBtn">
                                <i class="fas fa-eye me-2"></i>Preview
                            </button>
                            <a href="{% url 'hotel_management:home' %}" class="btn btn-outline-secondary me-2">
                                <i class="fas fa-times me-2"></i>Cancel
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <div class="loading-spinner me-2" style="display: none;"></div>
                                <i class="fas fa-save me-2"></i>Save Goals
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Existing Goals Table -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card shadow-sm">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-list me-2"></i>Existing Goals
                    </h5>
                    <div>
                        <button class="btn btn-outline-light me-2" id="refreshGoals">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                        <button class="btn btn-outline-light me-2" onclick="exportGoals()">
                            <i class="fas fa-download me-2"></i>Export
                        </button>
                        <a class="btn btn-outline-light" href="{% url 'hotel_management:budget_goals_tracker' %}">
                            <i class="fas fa-list-check me-2"></i>Open Goals Tracker
                        </a>
                    </div>
                </div>
            </div>
            <div class="table-responsive">
                <table class="table performance-table mb-0" id="goalsTable">
                    <thead>
                        <tr>
                            <th><i class="fas fa-calendar me-1"></i>Year</th>
                            <th><i class="fas fa-clock me-1"></i>Period</th>
                            <th><i class="fas fa-info me-1"></i>Detail</th>
                            <th class="text-end"><i class="fas fa-bed me-1"></i>Occ %</th>
                            <th class="text-end"><i class="fas fa-dollar-sign me-1"></i>ADR</th>
                            <th class="text-end"><i class="fas fa-chart-bar me-1"></i>RevPAR</th>
                            <th class="text-end"><i class="fas fa-money-bill me-1"></i>Revenue</th>
                            <th><i class="fas fa-user me-1"></i>Created By</th>
                            <th><i class="fas fa-calendar-plus me-1"></i>Created</th>
                            <th><i class="fas fa-calendar-check me-1"></i>Updated</th>
                            <th class="text-end"><i class="fas fa-cog me-1"></i>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for g in goals_list %}
                        <tr data-goal-id="{{ g.id }}">
                            <td><strong>{{ g.fiscal_year }}</strong></td>
                            <td>
                                <span class="badge bg-primary">{{ g.get_period_type_display }}</span>
                            </td>
                            <td>{{ g.period_detail|default:'—' }}</td>
                            <td class="text-end">
                                <strong class="text-primary">{{ g.occupancy_goal|default:'' }}{% if g.occupancy_goal %}%{% endif %}</strong>
                            </td>
                            <td class="text-end">
                                <strong class="text-success">{{ system_settings.effective_currency_symbol }}{{ g.adr_goal|default:'' }}</strong>
                            </td>
                            <td class="text-end">
                                <strong class="text-info">{{ system_settings.effective_currency_symbol }}{{ g.revpar_goal|default:'' }}</strong>
                            </td>
                            <td class="text-end">
                                <strong class="text-warning formatted-revenue">{{ system_settings.effective_currency_symbol }}{{ g.total_revenue_budget|default:'' }}</strong>
                            </td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="avatar-sm bg-primary text-white rounded-circle me-2 d-flex align-items-center justify-content-center" style="width: 32px; height: 32px;">
                                        {{ g.created_by.username|default:'U'|slice:":1"|upper }}
                                    </div>
                                    {{ g.created_by.get_full_name|default:g.created_by.username|default:'—' }}
                                </div>
                            </td>
                            <td>
                                <small class="text-muted">
                                    {{ g.created_at|date:'Y-m-d' }}<br>
                                    {{ g.created_at|time:'H:i' }}
                                </small>
                            </td>
                            <td>
                                <small class="text-muted">
                                    {{ g.updated_at|date:'Y-m-d' }}<br>
                                    {{ g.updated_at|time:'H:i' }}
                                </small>
                            </td>
                            <td class="text-end">
                                <div class="btn-group" role="group">
                                    <a class="btn btn-sm btn-outline-primary" 
                                       href="{% url 'hotel_management:budget_goals' %}?fiscal_year={{ g.fiscal_year }}&period_type={{ g.period_type }}&period_detail={{ g.period_detail }}"
                                       title="Edit">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    <button class="btn btn-sm btn-outline-info" onclick="duplicateGoal('{{ g.id }}')" title="Duplicate">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                    <form method="POST" action="" class="d-inline" onsubmit="return confirm('Are you sure you want to delete this goal? This action cannot be undone.');">
                                        {% csrf_token %}
                                        <input type="hidden" name="action" value="delete">
                                        <input type="hidden" name="goal_id" value="{{ g.id }}">
                                        <button type="submit" class="btn btn-sm btn-outline-danger" title="Delete">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="11" class="text-center text-muted py-4">
                                <i class="fas fa-inbox fa-3x mb-3 opacity-50"></i><br>
                                No goals set yet. Create your first budget goal above!
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Preview Modal -->
<div class="modal fade" id="previewModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-eye me-2"></i>Goal Preview
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="previewContent">
                <!-- Preview content will be populated here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="confirmSave">
                    <i class="fas fa-save me-2"></i>Confirm & Save
                </button>
            </div>
        </div>
    </div>
</div>

{% block extra_css %}
<style>
    :root {
        --primary-color: #3b82f6;
        --secondary-color: #64748b;
        --success-color: #16a34a;
        --warning-color: #f59e0b;
        --danger-color: #dc2626;
        --light-bg: #f8fafc;
        --border-color: #e2e8f0;
        --text-muted: #64748b;
        --performance-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        --market-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }

    /* Enhanced Dashboard Header */
    .dashboard-header {
        background: linear-gradient(135deg, var(--primary-color), #1d4ed8);
        border-radius: 20px;
        padding: 2rem;
        margin-bottom: 2rem;
        color: white;
        position: relative;
        overflow: hidden;
    }

    .dashboard-header::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
        animation: float 6s ease-in-out infinite;
    }

    @keyframes float {
        0%, 100% { transform: translateY(0px) rotate(0deg); }
        50% { transform: translateY(-20px) rotate(180deg); }
    }

    /* Fixed white badge styling */
    .dashboard-header .badge.bg-white {
        background-color: rgba(255, 255, 255, 0.95) !important;
        color: #1d4ed8 !important;
        border: 2px solid rgba(255, 255, 255, 0.3);
        backdrop-filter: blur(10px);
        font-weight: 700;
        padding: 8px 16px;
        border-radius: 20px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .hotel-logo {
        width: 80px;
        height: 80px;
        object-fit: cover;
        border-radius: 16px;
        border: 4px solid rgba(255, 255, 255, 0.2);
        transition: transform 0.3s ease;
    }

    .hotel-logo:hover {
        transform: scale(1.05);
    }

    /* Enhanced Metrics Cards */
    .metric-card {
        background: linear-gradient(145deg, white, #f8fafc);
        border-radius: 20px;
        padding: 2rem;
        text-align: center;
        transition: all 0.3s ease;
        border: 2px solid transparent;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
        position: relative;
        overflow: hidden;
    }

    .metric-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 4px;
        background: var(--performance-gradient);
    }

    .metric-card:hover {
        border-color: var(--primary-color);
        transform: translateY(-8px);
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
    }

    .metric-value {
        font-size: 2.2rem;
        font-weight: 800;
        color: var(--primary-color);
        margin-bottom: 0.5rem;
        background: linear-gradient(135deg, var(--primary-color), #1d4ed8);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .metric-label {
        color: var(--text-muted);
        font-weight: 600;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    /* Enhanced Goal Cards */
    .goal-card {
        border: 2px solid var(--border-color);
        border-radius: 24px;
        transition: all 0.4s ease;
        position: relative;
        overflow: hidden;
        backdrop-filter: blur(10px);
    }

    .performance-card {
        background: linear-gradient(145deg, #ffffff, #f8fafc);
        border-left: 6px solid #667eea;
    }

    .market-card {
        background: linear-gradient(145deg, #ffffff, #fef7f7);
        border-left: 6px solid #f093fb;
    }

    .goal-card:hover {
        transform: translateY(-10px) scale(1.02);
        box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
        border-color: transparent;
    }

    .goal-card-header {
        display: flex;
        align-items: center;
        padding-bottom: 1rem;
        border-bottom: 2px solid var(--border-color);
        position: relative;
    }

    .goal-icon {
        width: 48px;
        height: 48px;
        border-radius: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 1rem;
        font-size: 1.2rem;
        color: white;
        background: var(--performance-gradient);
        box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
    }

    .market-icon {
        background: var(--market-gradient);
        box-shadow: 0 8px 20px rgba(240, 147, 251, 0.3);
    }

    .goal-card h6 {
        color: #1e293b;
        font-size: 1.1rem;
        font-weight: 700;
        margin: 0;
    }

    .optional-badge {
        background: linear-gradient(135deg, #fbbf24, #f59e0b);
        color: white;
        font-size: 0.7rem;
        padding: 4px 8px;
        border-radius: 12px;
        font-weight: 600;
        margin-left: 8px;
    }

    /* Enhanced Form Controls */
    .form-control, .form-select {
        border-radius: 16px;
        border: 2px solid var(--border-color);
        padding: 16px 20px;
        transition: all 0.3s ease;
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(5px);
        font-weight: 500;
    }

    .enhanced-control {
        background: linear-gradient(145deg, #ffffff, #f8fafc);
        border: 2px solid #e2e8f0;
    }

    .enhanced-control:focus {
        background: white;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
        transform: translateY(-2px);
    }

    .form-control:focus, .form-select:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
        background: white;
        transform: translateY(-2px);
    }

    .input-group-enhanced .input-group-text {
        background: var(--performance-gradient);
        color: white;
        border: none;
        font-weight: 700;
        min-width: 60px;
        justify-content: center;
        border-radius: 16px 0 0 16px;
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.2);
    }

    .input-group-enhanced .form-control {
        border-radius: 0 16px 16px 0;
        border-left: none;
    }

    .form-label.fw-semibold {
        color: #1e293b;
        font-weight: 600;
        font-size: 0.95rem;
        margin-bottom: 8px;
    }

    /* Lock Goals Section */
    .lock-goals-section {
        background: linear-gradient(135deg, #fef9e7, #fef3c7);
        border: 2px solid #fbbf24;
        border-radius: 16px;
        position: relative;
        overflow: hidden;
    }

    .lock-goals-section::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 4px;
        background: linear-gradient(90deg, #fbbf24, #f59e0b);
    }

    .lock-help-text {
        margin-top: 8px;
        padding-left: 24px;
    }

    /* Enhanced Buttons */
    .btn {
        border-radius: 16px;
        padding: 14px 28px;
        font-weight: 600;
        transition: all 0.3s ease;
        text-transform: none;
        position: relative;
        overflow: hidden;
    }

    .btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        transition: left 0.5s;
    }

    .btn:hover::before {
        left: 100%;
    }

    .btn-primary {
        background: linear-gradient(135deg, var(--primary-color), #1d4ed8);
        border: none;
        box-shadow: 0 8px 20px rgba(59, 130, 246, 0.3);
    }

    .btn-primary:hover {
        transform: translateY(-3px);
        box-shadow: 0 15px 30px rgba(59, 130, 246, 0.4);
    }

    .btn-outline-secondary {
        border: 2px solid var(--border-color);
        color: var(--secondary-color);
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(5px);
    }

    .btn-outline-secondary:hover {
        background: var(--light-bg);
        transform: translateY(-2px);
        border-color: var(--primary-color);
        color: var(--primary-color);
    }

    .btn-outline-light {
        border: 2px solid rgba(255, 255, 255, 0.3);
        color: white;
        backdrop-filter: blur(5px);
    }

    .btn-outline-light:hover {
        background: rgba(255, 255, 255, 0.15);
        border-color: rgba(255, 255, 255, 0.6);
        color: white;
        transform: translateY(-2px);
    }

    /* Enhanced Table */
    .performance-table {
        border-radius: 20px;
        overflow: hidden;
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
    }

    .performance-table thead {
        background: linear-gradient(135deg, var(--primary-color), #1d4ed8);
        color: white;
    }

    .performance-table th {
        border: none;
        padding: 20px;
        font-weight: 700;
        letter-spacing: 0.5px;
        text-transform: uppercase;
        font-size: 0.85rem;
    }

    .performance-table td {
        border: none;
        padding: 20px;
        vertical-align: middle;
        border-bottom: 1px solid var(--border-color);
        font-weight: 500;
    }

    .performance-table tbody tr {
        transition: all 0.3s ease;
        background: white;
    }

    .performance-table tbody tr:hover {
        background: var(--light-bg);
        transform: scale(1.01);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    /* Enhanced Cards */
    .card {
        border: none;
        border-radius: 24px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
        overflow: hidden;
        transition: all 0.4s ease;
    }

    .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
    }

    .card-header {
        background: linear-gradient(135deg, var(--primary-color), #1d4ed8);
        color: white;
        border: none;
        padding: 2rem;
        position: relative;
    }

    .card-header::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 1px;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.5), transparent);
    }

    /* Enhanced Alerts */
    .alert {
        border-radius: 20px;
        border: none;
        padding: 20px 24px;
        margin-bottom: 1.5rem;
        backdrop-filter: blur(10px);
        position: relative;
        overflow: hidden;
    }

    .alert::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 4px;
        height: 100%;
    }

    .alert-success {
        background: linear-gradient(135deg, rgba(22, 163, 74, 0.1), rgba(22, 163, 74, 0.05));
        color: var(--success-color);
    }

    .alert-success::before {
        background: var(--success-color);
    }

    .alert-error, .alert-danger {
        background: linear-gradient(135deg, rgba(220, 38, 38, 0.1), rgba(220, 38, 38, 0.05));
        color: var(--danger-color);
    }

    .alert-error::before, .alert-danger::before {
        background: var(--danger-color);
    }

    .alert-info {
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(59, 130, 246, 0.05));
        color: var(--primary-color);
    }

    .alert-info::before {
        background: var(--primary-color);
    }

    /* Loading Spinner */
    .loading-spinner {
        width: 20px;
        height: 20px;
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-top: 3px solid white;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Validation */
    .validation-feedback {
        display: none;
        color: var(--danger-color);
        font-size: 0.875rem;
        margin-top: 8px;
        font-weight: 500;
    }

    .is-invalid ~ .validation-feedback {
        display: block;
    }

    .is-invalid {
        border-color: var(--danger-color) !important;
        box-shadow: 0 0 0 4px rgba(220, 38, 38, 0.1) !important;
    }

    /* Avatar */
    .avatar-sm {
        width: 36px;
        height: 36px;
        font-size: 0.9rem;
        font-weight: 700;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    }

    /* Badge enhancements */
    .badge {
        font-weight: 600;
        letter-spacing: 0.5px;
        padding: 8px 12px;
        border-radius: 12px;
    }

    /* Action info styling */
    .action-info {
        background: rgba(59, 130, 246, 0.05);
        padding: 8px 12px;
        border-radius: 12px;
        border: 1px solid rgba(59, 130, 246, 0.1);
    }

    /* Responsive */
    @media (max-width: 768px) {
        .dashboard-header {
            padding: 1.5rem;
        }
        
        .goal-card {
            padding: 1.5rem !important;
        }
        
        .metric-card {
            padding: 1.5rem;
        }

        .metric-value {
            font-size: 1.8rem;
        }
        
        .btn {
            padding: 12px 20px;
        }
        
        .table-responsive {
            font-size: 0.875rem;
        }
        
        .goal-card-header {
            flex-direction: column;
            text-align: center;
        }
        
        .goal-icon {
            margin-right: 0;
            margin-bottom: 1rem;
        }
        
        .action-info {
            display: none;
        }
    }

    /* Format revenue values */
    .formatted-revenue {
        font-family: 'SF Mono', 'Monaco', 'Cascadia Code', 'Roboto Mono', monospace;
    }

    
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const periodType = document.getElementById('period_type');
    const periodDetailWrapper = document.getElementById('period_detail_wrapper');
    const periodDetail = document.getElementById('period_detail');
    const form = document.getElementById('budget-goals-form');

    // Enhanced period detail update function
    const currentPeriodDetail = '{{ period_detail|default:""|escapejs }}';
    const currencySymbol = '{{ system_settings.effective_currency_symbol|escapejs }}';
    const hotelRoomCount = parseInt('{{ hotel.total_rooms|default:0 }}') || 0;
    
    // Format number function for K/M display
    function formatNumber(num) {
        if (num === null || num === undefined || num === '') return '';
        
        const number = parseFloat(num);
        if (isNaN(number)) return num;
        
        if (number >= 1000000) {
            return (number / 1000000).toFixed(1) + 'M';
        } else if (number >= 1000) {
            return (number / 1000).toFixed(1) + 'K';
        } else {
            return number.toLocaleString();
        }
    }

    // Update formatted revenue displays
    function updateRevenueDisplays() {
        // Update metric card - only format if it doesn't already have currency symbol
        const metricRevenue = document.getElementById('metricRevenue');
        if (metricRevenue) {
            const text = metricRevenue.textContent;
            // Only format if it doesn't already start with the currency symbol
            if (!text.startsWith(currencySymbol)) {
                const originalValue = text.replace(/[$,]/g, '');
                if (originalValue && originalValue !== '0') {
                    metricRevenue.textContent = currencySymbol + formatNumber(originalValue);
                }
            }
        }

        // Update table revenue values - only format if they don't already have currency symbol
        document.querySelectorAll('.formatted-revenue').forEach(cell => {
            const text = cell.textContent;
            // Only format if it doesn't already start with the currency symbol
            if (!text.startsWith(currencySymbol)) {
                const originalValue = text.replace(/[$,]/g, '');
                if (originalValue && originalValue !== '0' && originalValue !== '') {
                    cell.textContent = currencySymbol + formatNumber(originalValue);
                }
            }
        });
    }

    function updatePeriodDetail() {
        const value = periodType.value;
        if (value === 'quarter') {
            periodDetailWrapper.style.display = 'block';
            periodDetail.innerHTML = `
                <option value="">Select Quarter</option>
                <option value="Q1">Q1 (Jan-Mar)</option>
                <option value="Q2">Q2 (Apr-Jun)</option>
                <option value="Q3">Q3 (Jul-Sep)</option>
                <option value="Q4">Q4 (Oct-Dec)</option>
            `;
        } else if (value === 'monthly') {
            periodDetailWrapper.style.display = 'block';
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const monthOptions = months.map(month => 
                `<option value="${month}">${month}</option>`
            ).join('');
            periodDetail.innerHTML = `<option value="">Select Month</option>${monthOptions}`;
        } else {
            periodDetailWrapper.style.display = 'none';
            periodDetail.innerHTML = '<option value="">N/A</option>';
        }

        // Set current period detail if editing
        if (currentPeriodDetail && periodDetail.querySelector(`option[value="${currentPeriodDetail}"]`)) {
            periodDetail.value = currentPeriodDetail;
        }
    }

    // Auto-calculate RevPAR and Total Revenue
    function autoCalculateRevPAR() {
        const occupancy = parseFloat(document.getElementById('occupancy_goal').value || 0);
        const adr = parseFloat(document.getElementById('adr_goal').value || 0);
        
        if (occupancy > 0 && adr > 0) {
            const revpar = (occupancy / 100) * adr;
            document.getElementById('revpar_goal').value = revpar.toFixed(2);
            
            // Add visual feedback
            const revparField = document.getElementById('revpar_goal');
            revparField.style.background = 'linear-gradient(135deg, #ecfdf5, #f0fdf4)';
            setTimeout(() => {
                revparField.style.background = '';
            }, 1000);

            // Calculate total revenue if we have room data
            const daysInPeriod = getPeriodDays();
            const totalRevenue = revpar * hotelRoomCount * daysInPeriod;
            
            document.getElementById('total_revenue_budget').value = totalRevenue.toFixed(0);
            
            // Add visual feedback for revenue field
            const revenueField = document.getElementById('total_revenue_budget');
            revenueField.style.background = 'linear-gradient(135deg, #fef3c7, #fde68a)';
            setTimeout(() => {
                revenueField.style.background = '';
            }, 1000);
        }
    }

    function getPeriodDays() {
        const periodType = document.getElementById('period_type').value;
        switch(periodType) {
            case 'monthly': return 30;
            case 'quarter': return 90;
            case 'annual': 
            default: return 365;
        }
    }

    // Enhanced validation
    function validateField(field) {
        const value = field.value.trim();
        let isValid = true;
        let errorMessage = '';

        field.classList.remove('is-invalid');

        if (field.required && !value) {
            isValid = false;
            errorMessage = 'This field is required.';
        } else if (field.type === 'number' && value) {
            const num = parseFloat(value);
            const min = parseFloat(field.min || 0);
            const max = parseFloat(field.max || Infinity);
            
            if (isNaN(num)) {
                isValid = false;
                errorMessage = 'Please enter a valid number.';
            } else if (num < min) {
                isValid = false;
                errorMessage = `Value must be at least ${min}.`;
            } else if (num > max) {
                isValid = false;
                errorMessage = `Value must not exceed ${max}.`;
            }
        }

        if (!isValid) {
            field.classList.add('is-invalid');
            const feedback = field.parentNode.querySelector('.validation-feedback');
            if (feedback) {
                feedback.textContent = errorMessage;
            }
        }

        return isValid;
    }

    function validateForm() {
        const requiredFields = form.querySelectorAll('input[required], select[required]');
        let isValid = true;

        requiredFields.forEach(field => {
            if (!validateField(field)) {
                isValid = false;
            }
        });

        return isValid;
    }

    // Show enhanced alert with auto-dismiss
    function showAlert(message, type = 'info', duration = 5000) {
        const alertContainer = document.getElementById('alertContainer');
        const alertId = 'alert-' + Date.now();
        
        const icons = {
            'success': 'check-circle',
            'error': 'exclamation-circle',
            'danger': 'exclamation-circle',
            'warning': 'exclamation-triangle',
            'info': 'info-circle'
        };
        
        const alertHTML = `
            <div id="${alertId}" class="alert alert-${type} alert-dismissible fade show" role="alert">
                <i class="fas fa-${icons[type]} me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
        
        alertContainer.innerHTML = alertHTML;
        
        // Auto-dismiss after specified duration (guard against removed elements)
        setTimeout(() => {
            const alert = document.getElementById(alertId);
            if (!alert) return;
            const existing = bootstrap.Alert.getInstance(alert);
            const bsAlert = existing || new bootstrap.Alert(alert);
            if (alert.isConnected) {
                try { bsAlert.close(); } catch (e) { /* ignore */ }
            }
        }, duration);
    }

    // Show preview modal
    function showPreview() {
        if (!validateForm()) {
            showAlert('Please correct the validation errors before previewing.', 'danger');
            return;
        }

        const formData = new FormData(form);
        const previewContent = document.getElementById('previewContent');
        
        previewContent.innerHTML = `
            <div class="row g-4">
                <div class="col-md-6">
                    <h6 class="fw-bold mb-3 text-primary"><i class="fas fa-calendar me-2"></i>Period Information</h6>
                    <div class="bg-light p-3 rounded">
                        <table class="table table-sm table-borderless mb-0">
                            <tr><td class="fw-bold">Fiscal Year:</td><td>${formData.get('fiscal_year')}</td></tr>
                            <tr><td class="fw-bold">Period Type:</td><td>${getPeriodDisplay(formData.get('period_type'))}</td></tr>
                            <tr><td class="fw-bold">Period Detail:</td><td>${formData.get('period_detail') || '—'}</td></tr>
                            <tr><td class="fw-bold">Locked:</td><td>${formData.get('lock_targets') ? '<span class="badge bg-warning">Yes</span>' : '<span class="badge bg-success">No</span>'}</td></tr>
                        </table>
                    </div>
                </div>
                <div class="col-md-6">
                    <h6 class="fw-bold mb-3 text-success"><i class="fas fa-chart-line me-2"></i>Performance Goals</h6>
                    <div class="bg-light p-3 rounded">
                        <table class="table table-sm table-borderless mb-0">
                            <tr><td class="fw-bold">Occupancy:</td><td class="text-primary fw-bold">${formData.get('occupancy_goal')}%</td></tr>
                            <tr><td class="fw-bold">ADR:</td><td class="text-success fw-bold">${currencySymbol}${parseFloat(formData.get('adr_goal') || 0).toFixed(2)}</td></tr>
                            <tr><td class="fw-bold">RevPAR:</td><td class="text-info fw-bold">${currencySymbol}${parseFloat(formData.get('revpar_goal') || 0).toFixed(2)}</td></tr>
                            <tr><td class="fw-bold">Revenue Budget:</td><td class="text-warning fw-bold">${currencySymbol}${formatNumber(formData.get('total_revenue_budget') || 0)}</td></tr>
                        </table>
                    </div>
                </div>
                <div class="col-12">
                    <h6 class="fw-bold mb-3 text-info"><i class="fas fa-balance-scale me-2"></i>Market Index Goals</h6>
                    <div class="bg-light p-3 rounded">
                        <div class="row text-center">
                            <div class="col-md-4">
                                <div class="border-end">
                                    <div class="h5 text-primary mb-1">${formData.get('mpi_goal') || '—'}</div>
                                    <small class="text-muted">MPI</small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="border-end">
                                    <div class="h5 text-primary mb-1">${formData.get('ari_goal') || '—'}</div>
                                    <small class="text-muted">ARI</small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="h5 text-primary mb-1">${formData.get('rgi_goal') || '—'}</div>
                                <small class="text-muted">RGI</small>
                            </div>
                        </div>
                        ${formData.get('notes') ? `
                            <hr>
                            <div><strong class="text-secondary">Notes:</strong></div>
                            <div class="text-muted mt-2">${formData.get('notes')}</div>
                        ` : ''}
                    </div>
                </div>
            </div>
        `;

        const modalEl = document.getElementById('previewModal');
        const previouslyFocused = document.activeElement;
        if (previouslyFocused && typeof previouslyFocused.blur === 'function') {
            previouslyFocused.blur();
        }
        const modal = bootstrap.Modal.getOrCreateInstance(modalEl, { backdrop: 'static', keyboard: false, focus: true });
        modal.show();
        // Move focus inside the modal to avoid background focus retention
        setTimeout(() => {
            const focusTarget = modalEl.querySelector('[data-bs-dismiss="modal"], button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
            if (focusTarget && typeof focusTarget.focus === 'function') {
                focusTarget.focus();
            }
        }, 0);

        document.getElementById('confirmSave').onclick = () => {
            modal.hide();
            form.submit();
        };
        // Restore focus to previously focused control once modal fully hidden
        modalEl.addEventListener('hidden.bs.modal', () => {
            if (previouslyFocused && typeof previouslyFocused.focus === 'function') {
                previouslyFocused.focus();
            }
        }, { once: true });
    }

    function getPeriodDisplay(periodType) {
        const displays = {
            'annual': 'Annual',
            'quarter': 'Quarterly',
            'monthly': 'Monthly'
        };
        return displays[periodType] || periodType;
    }

    // Reset form function
    function resetForm() {
        if (confirm('Are you sure you want to reset the form? All unsaved changes will be lost.')) {
            form.reset();
            
            // Reset validation classes
            form.querySelectorAll('.is-invalid').forEach(el => {
                el.classList.remove('is-invalid');
            });

            // Set default values
            document.getElementById('fiscal_year').value = new Date().getFullYear();
            document.getElementById('period_type').value = 'annual';
            updatePeriodDetail();
            document.getElementById('revpar_goal').value = '';
            document.getElementById('total_revenue_budget').value = '';

            showAlert('Form has been reset successfully.', 'info');
        }
    }

    // Event listeners
    periodType.addEventListener('change', updatePeriodDetail);
    
    // Auto-calculate RevPAR and Revenue on input
    document.getElementById('occupancy_goal').addEventListener('input', autoCalculateRevPAR);
    document.getElementById('adr_goal').addEventListener('input', autoCalculateRevPAR);

    // Real-time validation
    form.querySelectorAll('input[required], select[required]').forEach(input => {
        input.addEventListener('blur', () => validateField(input));
        input.addEventListener('input', () => {
            if (input.classList.contains('is-invalid')) {
                validateField(input);
            }
        });
    });

    // Enhanced form submission
    form.addEventListener('submit', function(e) {
        if (!validateForm()) {
            e.preventDefault();
            showAlert('Please correct the validation errors before submitting.', 'danger');
            
            // Focus on first invalid field
            const firstInvalid = form.querySelector('.is-invalid');
            if (firstInvalid) {
                firstInvalid.focus();
                firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            return;
        }

        // Show loading state
        const submitBtn = form.querySelector('button[type="submit"]');
        const spinner = submitBtn.querySelector('.loading-spinner');
        const icon = submitBtn.querySelector('.fas');
        
        spinner.style.display = 'inline-block';
        icon.style.display = 'none';
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<div class="loading-spinner me-2"></div>Saving...';
    });

    // Button event listeners
    document.getElementById('resetForm').addEventListener('click', resetForm);
    document.getElementById('previewBtn').addEventListener('click', showPreview);
    
    // Refresh goals functionality
    document.getElementById('refreshGoals').addEventListener('click', function() {
        showAlert('Refreshing goals data...', 'info', 2000);
        // In a real implementation, this would make an AJAX call to refresh the table
        setTimeout(() => {
            window.location.reload();
        }, 1000);
    });

    // Initialize
    updatePeriodDetail();
    updateRevenueDisplays();
    // Calculate RevPAR if inputs are present
    autoCalculateRevPAR();

    // Auto-dismiss existing alerts after 5 seconds
    setTimeout(() => {
        document.querySelectorAll('.alert').forEach(alert => {
            if (!alert.id.startsWith('alert-')) { // Only auto-dismiss initial alerts
                const bsAlert = bootstrap.Alert.getOrCreateInstance(alert);
                bsAlert.close();
            }
        });
    }, 5000);

    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        if (e.ctrlKey || e.metaKey) {
            switch(e.key) {
                case 's':
                    e.preventDefault();
                    if (validateForm()) {
                        form.submit();
                    } else {
                        showAlert('Please correct validation errors first.', 'warning');
                    }
                    break;
                case 'r':
                    e.preventDefault();
                    resetForm();
                    break;
                case 'p':
                    e.preventDefault();
                    showPreview();
                    break;
            }
        }
    });
});

// Duplicate goal function (for table actions)
function duplicateGoal(goalId) {
    if (confirm('This will copy the selected goal. You can then modify the period and save as a new goal.')) {
        // In a real implementation, this would populate the form with the goal data
        showAlert('Goal data loaded for duplication. Please modify the period and save.', 'info');
        document.getElementById('budget-goals-form').scrollIntoView({ behavior: 'smooth' });
    }
}

// Export goals function
function exportGoals() {
    const table = document.getElementById('goalsTable');
    const rows = Array.from(table.querySelectorAll('tbody tr')).filter(row => 
        !row.querySelector('td[colspan]') // Filter out "no goals" row
    );
    
    if (rows.length === 0) {
        alert('No goals to export.');
        return;
    }

    // Create CSV content
    const headers = ['Year', 'Period', 'Detail', 'Occupancy %', 'ADR', 'RevPAR', 'Revenue Budget', 'Created By', 'Created Date'];
    const csvContent = [
        headers.join(','),
        ...rows.map(row => {
            const cells = Array.from(row.querySelectorAll('td'));
            return [
                cells[0].textContent.trim(), // Year
                cells[1].textContent.trim(), // Period
                cells[2].textContent.trim(), // Detail
                cells[3].textContent.trim(), // Occupancy
                cells[4].textContent.trim(), // ADR
                cells[5].textContent.trim(), // RevPAR
                cells[6].textContent.trim(), // Revenue
                cells[7].textContent.trim(), // Created By
                cells[8].textContent.trim()  // Created Date
            ].map(cell => `"${cell.replace(/"/g, '""')}"`).join(',');
        })
    ].join('\n');

    // Download CSV
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `budget-goals-${new Date().toISOString().split('T')[0]}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showAlert('Goals exported successfully! Check your downloads folder.', 'success');
}

// Helper function to show alert (global access)
function showAlert(message, type = 'info', duration = 5000) {
    const alertContainer = document.getElementById('alertContainer');
    const alertId = 'alert-' + Date.now();
    
    const icons = {
        'success': 'check-circle',
        'error': 'exclamation-circle',
        'danger': 'exclamation-circle',
        'warning': 'exclamation-triangle',
        'info': 'info-circle'
    };
    
    const alertHTML = `
        <div id="${alertId}" class="alert alert-${type} alert-dismissible fade show" role="alert">
            <i class="fas fa-${icons[type]} me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    alertContainer.innerHTML = alertHTML;
    
    // Auto-dismiss after specified duration
    setTimeout(() => {
        const alert = document.getElementById(alertId);
        if (alert) {
            const bsAlert = bootstrap.Alert.getOrCreateInstance(alert);
            bsAlert.close();
        }
    }, duration);
}
</script>
{% endblock %} <!-- extra_js block -->

{% endblock %} <!-- content block -->
